<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>I (almost) broke 99% of Rust prjects in the world | Life is a refactoring process without tests</title>
<meta name=keywords content="Rust"><meta name=description content="Title is boasting but indeed could have broken builds of a lot of projects.
Once upon a time (2022-10), I was trying to fix a tricky bug regarding the feature “artifact dependencies”. Artifact dependencies is a humongous feature too hard to implement it 100% right, as it touches almost every components of Cargo. There&rsquo;s a saying from an anonymous Cargo maintainer, “I am mostly confident to make a change until it touches the dependency resolver."><meta name=author content><link rel=canonical href=https://weihanglo.tw/posts/2022/i-almost-broke-99-percents-of-rust-projects-in-the-world/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://weihanglo.tw/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weihanglo.tw/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weihanglo.tw/favicon-32x32.png><link rel=apple-touch-icon href=https://weihanglo.tw/apple-touch-icon.png><link rel=mask-icon href=https://weihanglo.tw/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weihanglo.tw/posts/2022/i-almost-broke-99-percents-of-rust-projects-in-the-world/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><meta property="og:title" content="I (almost) broke 99% of Rust prjects in the world"><meta property="og:description" content="Title is boasting but indeed could have broken builds of a lot of projects.
Once upon a time (2022-10), I was trying to fix a tricky bug regarding the feature “artifact dependencies”. Artifact dependencies is a humongous feature too hard to implement it 100% right, as it touches almost every components of Cargo. There&rsquo;s a saying from an anonymous Cargo maintainer, “I am mostly confident to make a change until it touches the dependency resolver."><meta property="og:type" content="article"><meta property="og:url" content="https://weihanglo.tw/posts/2022/i-almost-broke-99-percents-of-rust-projects-in-the-world/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-06T20:19:00+00:00"><meta property="article:modified_time" content="2022-11-06T20:19:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="I (almost) broke 99% of Rust prjects in the world"><meta name=twitter:description content="Title is boasting but indeed could have broken builds of a lot of projects.
Once upon a time (2022-10), I was trying to fix a tricky bug regarding the feature “artifact dependencies”. Artifact dependencies is a humongous feature too hard to implement it 100% right, as it touches almost every components of Cargo. There&rsquo;s a saying from an anonymous Cargo maintainer, “I am mostly confident to make a change until it touches the dependency resolver."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weihanglo.tw/posts/"},{"@type":"ListItem","position":2,"name":"I (almost) broke 99% of Rust prjects in the world","item":"https://weihanglo.tw/posts/2022/i-almost-broke-99-percents-of-rust-projects-in-the-world/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"I (almost) broke 99% of Rust prjects in the world","name":"I (almost) broke 99% of Rust prjects in the world","description":"Title is boasting but indeed could have broken builds of a lot of projects.\nOnce upon a time (2022-10), I was trying to fix a tricky bug regarding the feature “artifact dependencies”. Artifact dependencies is a humongous feature too hard to implement it 100% right, as it touches almost every components of Cargo. There\u0026rsquo;s a saying from an anonymous Cargo maintainer, “I am mostly confident to make a change until it touches the dependency resolver.","keywords":["Rust"],"articleBody":" Title is boasting but indeed could have broken builds of a lot of projects.\nOnce upon a time (2022-10), I was trying to fix a tricky bug regarding the feature “artifact dependencies”. Artifact dependencies is a humongous feature too hard to implement it 100% right, as it touches almost every components of Cargo. There’s a saying from an anonymous Cargo maintainer, “I am mostly confident to make a change until it touches the dependency resolver.” Unfortunately, the root cause of that bug was exactly related to dependency resolution, specifically feature resolution in Cargo. “Well, it is still fixable”, I told myself.\nA gigantic pull request\nAfter some researches and experiments, I became more confident in my knowledge of feature resolver and artifact dependencies, so I submitted a pull request fixing the bug. Discussing back and forth with other Cargo maintainers, we finally reached an agreement and merged my patch. Everything went smoothly than expected. Really happy to see myself expanding my comfort zone and being more helpful in the area of feature resolution.\nI then did a sync update from rust-lang/cargo repository to rust-lang/rust. The purpose of the update was to land changes from Cargo master branch into the next Rust nightly channel release. Then every nightly Rust users in the world will receive those changes. We merged that sync update soon and everything looked normal as usual. Those patches was about to hit nightly users within less than 16 hours at the end of that day.\nHowever, there is always a new bug following a new fix. The performance benchmark bot in rust-lang/rust found abnormal failures. After investigations, the official Rust compiler-perfomance team suspected there was a bug rooted in Cargo. They immediately notified the Cargo Team to take a look. I was there and realized I messed up something. With my fix to artifact dependencies, Cargo refused to compile any project depending on serde_derive. serde, along with its companion crate serde_derive, are the cornerstone of a huge amount of Rust project in the ecosystem. I could say 99% of projects doing serialization use serde. So does Rust compiler itself. We figured out that the fastest way to fix it was reverting the Cargo sync update. I was also trying to find a way to fix the bug, but it was nearly impossible to find an nonintrusive and sensible way to fix the bug within such a limited time frame. So yeah, I chose to revert it from Cargo side as well.\nDownload stats of serde_derive\nThe feature and the patch lived happily ever after, right? No exactly. Since the sync update PR had already been merged, if the revert PR hadn’t made it merged before midnight, the bug could have sneaked in the next nightly release. That meant everyone using nightly channel suddenly failed to build their projects if it depends on serde_derive. I was really worried that day, as I knew that the Rust CI queue is always way too long. A member of Rust Infra Team set a higher priority on the revert PR, so that it was expected to get merged before midnight. We were all relieved and had a good sleep.\nOops! The CI build of revert PR failed. A mysterious timeout. Well, fine. We could always kick off a new build and get it merged and then everyone is happy. But, no. Not this time. It was already 21:40 when we spotted the timeout, and a full CI build on rust-lang/rust usually takes around 3 hours. That is to say, we were too late to ship the revert to the next nightly release, and My bug could have started biting everyone after midnight! I begged Rust Infra Team to disable the nightly auto-release temporarily, and thankfully people were around to help. They disabled the CI pipeline and did a manual release.\nbors timeout!!!\nAlthough the story ended here, I still couldn’t make myself calm until we can prevent this from happening again. I posted a pull request adding tests to ensure the behaviour always successful. I also plan to add a new CI pipeline to verify builds of some real world projects during the CI of rust-lang/cargo. Thanks @lqd for always keeping an eye on abnormal performance build. Thanks @Mark-Simulacrum for helping trigger the manual release process at midnight. Also thanks @ehuss for trusting me with dealing with the entire incident. I couldn’t have had this precious experience without their helps and trust.\nJust realized that I lost an opportunity to become famous 😗.\n","wordCount":"751","inLanguage":"en","datePublished":"2022-11-06T20:19:00Z","dateModified":"2022-11-06T20:19:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://weihanglo.tw/posts/2022/i-almost-broke-99-percents-of-rust-projects-in-the-world/"},"publisher":{"@type":"Organization","name":"Life is a refactoring process without tests","logo":{"@type":"ImageObject","url":"https://weihanglo.tw/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weihanglo.tw/ accesskey=h title="Life is a refactoring process without tests (Alt + H)">Life is a refactoring process without tests</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://weihanglo.tw/ title=Home><span>Home</span></a></li><li><a href=https://weihanglo.tw/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://weihanglo.tw/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://weihanglo.tw/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">I (almost) broke 99% of Rust prjects in the world</h1><div class=post-meta><span title='2022-11-06 20:19:00 +0000 UTC'>November 6, 2022</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><blockquote><p>Title is boasting but indeed could have broken builds of a lot of projects.</p></blockquote><p>Once upon a time (2022-10),
I was trying to fix <a href=https://github.com/rust-lang/cargo/issues/10526>a tricky bug</a> regarding the feature “artifact dependencies”.
<a href=https://rust-lang.github.io/rfcs/3028-cargo-binary-dependencies.html>Artifact dependencies</a> is a humongous feature too hard to implement it 100% right,
as it touches almost every components of Cargo.
There&rsquo;s a saying from an anonymous Cargo maintainer,
“I am mostly confident to make a change until it touches the dependency resolver.”
Unfortunately, the root cause of that bug was exactly related to dependency resolution,
specifically feature resolution in Cargo.
“Well, it is still fixable”, I told myself.</p><img src=./artifact-deps.png style="box-shadow:0 0 1em #a8a8a8"><p><small><em>A gigantic pull request</em></small></p><p>After some researches and experiments,
I became more confident in my knowledge of feature resolver and artifact dependencies,
so I submitted <a href=https://github.com/rust-lang/cargo/pull/11183>a pull request</a> fixing the bug.
Discussing back and forth with other Cargo maintainers,
we finally reached an agreement and merged my patch.
Everything went smoothly than expected.
Really happy to see myself expanding my comfort zone and being more helpful
in the area of feature resolution.</p><p>I then did a <a href=https://github.com/rust-lang/rust/pull/103860>sync update</a> from rust-lang/cargo repository to rust-lang/rust.
The purpose of the update was to land changes from Cargo master branch
into the next Rust nightly channel release.
Then every nightly Rust users in the world will receive those changes.
We merged that sync update soon and everything looked normal as usual.
Those patches was about to hit nightly users within less than 16 hours at the end of that day.</p><p>However, there is always a new bug following a new fix.
The performance benchmark bot in rust-lang/rust <a href=https://github.com/rust-lang/rust/pull/103860#issuecomment-1301898101>found abnormal failures</a>.
After investigations,
the official Rust compiler-perfomance team suspected there was a bug rooted in Cargo.
They immediately notified the Cargo Team to take a look.
I was there and realized I messed up something. With my fix to artifact dependencies,
Cargo refused to compile any project depending on <code>serde_derive</code>.
<code>serde</code>, along with its companion crate <code>serde_derive</code>,
are the cornerstone of a huge amount of Rust project in the ecosystem.
I could say 99% of projects doing serialization use <code>serde</code>. So does Rust compiler itself.
We figured out that the fastest way to fix it was <a href=https://github.com/rust-lang/rust/pull/103922>reverting the Cargo sync update</a>.
I was also trying to find a way to fix the bug,
but it was nearly impossible to find an nonintrusive and sensible way to
fix the bug within such a limited time frame.
So yeah, I chose to <a href=https://github.com/rust-lang/cargo/pull/11331>revert it from Cargo side</a> as well.</p><img src=./stats.png style="box-shadow:0 0 1em #a8a8a8"><p><small><em>Download stats of <code>serde_derive</code></em></small></p><p>The feature and the patch lived happily ever after, right? No exactly.
Since the sync update PR had already been merged,
if the revert PR hadn’t made it merged before midnight,
the bug could have sneaked in the next nightly release.
That meant everyone using nightly channel suddenly failed to build their projects
if it depends on <code>serde_derive</code>.
I was really worried that day, as I knew that the Rust CI queue is always way too long.
A member of Rust Infra Team set a higher priority on the revert PR,
so that it was expected to get merged before midnight.
We were all relieved and had a good sleep.</p><p>Oops! The CI build of revert PR failed. <a href=https://github.com/rust-lang/rust/pull/103922#issuecomment-1302686811>A mysterious timeout</a>.
Well, fine.
We could always kick off a new build and get it merged and then everyone is happy.
But, no. Not this time.
It was already 21:40 when we spotted the timeout,
and a full CI build on rust-lang/rust usually takes around 3 hours.
That is to say, we were too late to ship the revert to the next nightly release,
and My bug could have started biting everyone after midnight!
I <a href=https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler.2Fperformance/topic/cargo.20and.20rustc.20benchmarks.20broken/near/307851302>begged Rust Infra Team</a> to disable the nightly auto-release temporarily,
and thankfully people were around to help.
They disabled the CI pipeline and <a href=https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler.2Fperformance/topic/cargo.20and.20rustc.20benchmarks.20broken/near/307872225>did a manual release</a>.</p><img src=./timeout.png style="box-shadow:0 0 1em #a8a8a8"><p><small><em>bors timeout!!!</em></small></p><p>Although the story ended here, I still couldn’t make myself calm
until we can prevent this from happening again.
I <a href=https://github.com/rust-lang/cargo/pull/11342>posted a pull request</a> adding tests to ensure the behaviour always successful.
I also plan to add a new CI pipeline to verify builds of some real world projects
during the CI of rust-lang/cargo.
Thanks <a href=https://github.com/lqd>@lqd</a> for always keeping an eye on abnormal performance build.
Thanks <a href=https://github.com/Mark-Simulacrum>@Mark-Simulacrum</a> for helping trigger the manual release process at midnight.
Also thanks <a href=https://github.com/ehuss>@ehuss</a> for trusting me with dealing with the entire incident.
I couldn’t have had this precious experience without their helps and trust.</p><p>Just realized that I lost an opportunity to become famous 😗.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://weihanglo.tw/tags/rust/>Rust</a></li></ul><nav class=paginav><a class=prev href=https://weihanglo.tw/posts/2022/2022-not-a-real-retro/><span class=title>« Prev</span><br><span>2022 流水帳式年度回顧</span>
</a><a class=next href=https://weihanglo.tw/posts/2022/make-the-world-better-even-you-arent-a-super-hero/><span class=title>Next »</span><br><span>不必是眾星拱月那個月 也能替世界增添光芒</span></a></nav></footer></article></main><footer class=footer><span>CC BY-NC-SA 4.0</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>