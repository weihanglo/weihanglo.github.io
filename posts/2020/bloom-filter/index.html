<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æœ¬ç¯‡å¾ Rust Algorithm Club ç§»æ¤ï¼Œè‹¥æ¬²é–±è®€æœ€æ–°ç‰ˆï¼Œè«‹ç§»é§•è‡³Rust æ¼”ç®—æ³•ä¿±æ¨‚éƒ¨ï¼šå¸ƒéš†éæ¿¾å™¨ Bloom Filter ä¸€æ–‡ï¼Œæ­¤æ–‡ä¸åŒæ­¥æ›´æ–°ã€‚
 Bloom filter æ˜¯ä¸€ç¨®æ©Ÿç‡è³‡æ–™çµæ§‹ï¼ˆprobabilistic data structureï¼‰ï¼Œé¡ä¼¼æ–¼é›†åˆï¼Œå¸¸ç”¨æ–¼éœ€å¿«é€Ÿé©—è­‰æˆå“¡æ˜¯å¦ã€Œå¯èƒ½å­˜åœ¨ã€æˆ–æ˜¯ã€Œçµ•å°ä¸å­˜åœ¨ã€åœ¨å®¹å™¨ä¸­ï¼Œäº¦å³æœ‰æ©Ÿæœƒå‡ºç¾å‡é™½æ€§ï¼ˆfalse positiveï¼‰ï¼Œä½†çµ•ä¸æœƒæœ‰å‡é™°æ€§ï¼ˆfalse negativeï¼‰ã€‚
Bloom filter çš„å„ªå‹¢æ˜¯ï¼š
 é¡ä¼¼é›†åˆï¼Œå¯åœ¨ $O(1)$ æ™‚é–“è¤‡é›œåº¦é©—è­‰æˆå“¡æ˜¯å¦å­˜åœ¨ï¼Œå»åƒ…éœ€ç›¸å°å°‘çš„å„²å­˜ç©ºé–“ã€‚ æ‰¿ä¸Šï¼Œåœ¨ 0.1% éŒ¯èª¤ç‡ä¸‹å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ åƒ…éœ€ 1.71 MiBã€‚ éå¸¸å®¹æ˜“å¯¦ä½œçš„æ©Ÿç‡è³‡æ–™çµæ§‹ï¼Œåƒ…éœ€å¤šæ¬¡é›œæ¹Šã€‚  Bloom filter å‰‡æœ‰ä»¥ä¸‹çŸ­è™•ï¼š
 ç¶“å…¸æ¬¾ Bloom filter å®¹å™¨å¤§å°å›ºå®šï¼ˆfixed-sizeï¼‰ï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ã€‚ å¯èƒ½çµ¦å‡ºå‡é™½æ€§ç­”æ¡ˆï¼šå›å ±å­˜åœ¨ä½†å¯¦éš›ä¸å­˜åœ¨ï¼Œä¸”éŒ¯èª¤éš¨æ•¸é‡è®Šå¤šä¸Šå‡ã€‚ è‡ªèº«ä¸å„²å­˜æˆå“¡è³‡æ–™ï¼Œéœ€è¦æœ‰é¡å¤–çš„å„²å­˜è³‡æ–™æ–¹æ¡ˆã€‚ åªèƒ½æ–°å¢æˆå“¡ï¼Œä½†ä¸èƒ½ç§»é™¤æˆå“¡ï¼ˆå¯é€éè®Šå½¢è§£æ±ºï¼‰ã€‚ è‹¥è¼¸å…¥è³‡æ–™é›†æœ¬èº«é›¢æ•£ï¼Œæ¥è¿‘éš¨æ©Ÿå­˜å–ï¼Œç„¡æ³•å……åˆ†åˆ©ç”¨ CPU cacheã€‚ æ‰¿ä¸Šï¼Œå› ç‚ºéš¨æ©Ÿå­˜å–ï¼Œä¸åˆ©æ–¼å»¶ä¼¸åˆ°è¨˜æ†¶é«”ä»¥å¤–çš„å¤–éƒ¨å„²å­˜è£ç½®ã€‚  Bloom filter å¸¸è¦‹æ‡‰ç”¨å ´æ™¯ç‚ºï¼š
 è³‡æ–™åº«åˆ©ç”¨ Bloom filter ä¸­æ¸›å°‘å¯¦éš›å­˜å– disk çš„ IO é–‹éŠ·ã€‚ Chromium ç€è¦½å™¨é©—è­‰å¤§é‡æƒ¡æ„é€£çµã€‚ Medium é¿å…æ¨è–¦å·²æ¨è–¦éçš„æ–‡ç« ã€‚   å°çŸ¥è­˜ï¼šbloom æ˜¯é–‹èŠ±ä¹‹æ„ï¼Œä½† Bloom filter å’Œé–‹èŠ±æ²’ä»»ä½•é—œä¿‚ï¼Œåªå› ç™¼æ˜äººå§“æ°ç‚º Bloom"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="å¸ƒéš†éæ¿¾å™¨ Bloom Filter â€¢ Weihang Lo"><meta property="og:description" content="æœ¬ç¯‡å¾ Rust Algorithm Club ç§»æ¤ï¼Œè‹¥æ¬²é–±è®€æœ€æ–°ç‰ˆï¼Œè«‹ç§»é§•è‡³Rust æ¼”ç®—æ³•ä¿±æ¨‚éƒ¨ï¼šå¸ƒéš†éæ¿¾å™¨ Bloom Filter ä¸€æ–‡ï¼Œæ­¤æ–‡ä¸åŒæ­¥æ›´æ–°ã€‚
 Bloom filter æ˜¯ä¸€ç¨®æ©Ÿç‡è³‡æ–™çµæ§‹ï¼ˆprobabilistic data structureï¼‰ï¼Œé¡ä¼¼æ–¼é›†åˆï¼Œå¸¸ç”¨æ–¼éœ€å¿«é€Ÿé©—è­‰æˆå“¡æ˜¯å¦ã€Œå¯èƒ½å­˜åœ¨ã€æˆ–æ˜¯ã€Œçµ•å°ä¸å­˜åœ¨ã€åœ¨å®¹å™¨ä¸­ï¼Œäº¦å³æœ‰æ©Ÿæœƒå‡ºç¾å‡é™½æ€§ï¼ˆfalse positiveï¼‰ï¼Œä½†çµ•ä¸æœƒæœ‰å‡é™°æ€§ï¼ˆfalse negativeï¼‰ã€‚
Bloom filter çš„å„ªå‹¢æ˜¯ï¼š
 é¡ä¼¼é›†åˆï¼Œå¯åœ¨ $O(1)$ æ™‚é–“è¤‡é›œåº¦é©—è­‰æˆå“¡æ˜¯å¦å­˜åœ¨ï¼Œå»åƒ…éœ€ç›¸å°å°‘çš„å„²å­˜ç©ºé–“ã€‚ æ‰¿ä¸Šï¼Œåœ¨ 0.1% éŒ¯èª¤ç‡ä¸‹å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ åƒ…éœ€ 1.71 MiBã€‚ éå¸¸å®¹æ˜“å¯¦ä½œçš„æ©Ÿç‡è³‡æ–™çµæ§‹ï¼Œåƒ…éœ€å¤šæ¬¡é›œæ¹Šã€‚  Bloom filter å‰‡æœ‰ä»¥ä¸‹çŸ­è™•ï¼š
 ç¶“å…¸æ¬¾ Bloom filter å®¹å™¨å¤§å°å›ºå®šï¼ˆfixed-sizeï¼‰ï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ã€‚ å¯èƒ½çµ¦å‡ºå‡é™½æ€§ç­”æ¡ˆï¼šå›å ±å­˜åœ¨ä½†å¯¦éš›ä¸å­˜åœ¨ï¼Œä¸”éŒ¯èª¤éš¨æ•¸é‡è®Šå¤šä¸Šå‡ã€‚ è‡ªèº«ä¸å„²å­˜æˆå“¡è³‡æ–™ï¼Œéœ€è¦æœ‰é¡å¤–çš„å„²å­˜è³‡æ–™æ–¹æ¡ˆã€‚ åªèƒ½æ–°å¢æˆå“¡ï¼Œä½†ä¸èƒ½ç§»é™¤æˆå“¡ï¼ˆå¯é€éè®Šå½¢è§£æ±ºï¼‰ã€‚ è‹¥è¼¸å…¥è³‡æ–™é›†æœ¬èº«é›¢æ•£ï¼Œæ¥è¿‘éš¨æ©Ÿå­˜å–ï¼Œç„¡æ³•å……åˆ†åˆ©ç”¨ CPU cacheã€‚ æ‰¿ä¸Šï¼Œå› ç‚ºéš¨æ©Ÿå­˜å–ï¼Œä¸åˆ©æ–¼å»¶ä¼¸åˆ°è¨˜æ†¶é«”ä»¥å¤–çš„å¤–éƒ¨å„²å­˜è£ç½®ã€‚  Bloom filter å¸¸è¦‹æ‡‰ç”¨å ´æ™¯ç‚ºï¼š
 è³‡æ–™åº«åˆ©ç”¨ Bloom filter ä¸­æ¸›å°‘å¯¦éš›å­˜å– disk çš„ IO é–‹éŠ·ã€‚ Chromium ç€è¦½å™¨é©—è­‰å¤§é‡æƒ¡æ„é€£çµã€‚ Medium é¿å…æ¨è–¦å·²æ¨è–¦éçš„æ–‡ç« ã€‚   å°çŸ¥è­˜ï¼šbloom æ˜¯é–‹èŠ±ä¹‹æ„ï¼Œä½† Bloom filter å’Œé–‹èŠ±æ²’ä»»ä½•é—œä¿‚ï¼Œåªå› ç™¼æ˜äººå§“æ°ç‚º Bloom"><meta property="og:url" content="https://weihanglo.tw/posts/2020/bloom-filter/"><meta property="og:site_name" content="Weihang Lo"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Algorithms"><meta property="article:published_time" content="2020-08-28T00:00:00+08:00"><meta property="article:modified_time" content="2020-08-28T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>å¸ƒéš†éæ¿¾å™¨ Bloom Filter â€¢ Weihang Lo</title><link rel=canonical href=https://weihanglo.tw/posts/2020/bloom-filter/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-posts"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/posts/>Posts</a></li><li class=item><a href=/tags/>Tags</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Weihang Lo</p><p class="desc site-desc"></p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>å¸ƒéš†éæ¿¾å™¨ Bloom Filter</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-08-28T00:00:00+08:00>2020, Aug 28</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>9 mins read</span></div></div></header><div class="container entry-content"><blockquote><p>æœ¬ç¯‡å¾ <a href=https://rust-algo.club>Rust Algorithm Club</a> ç§»æ¤ï¼Œè‹¥æ¬²é–±è®€æœ€æ–°ç‰ˆï¼Œè«‹ç§»é§•è‡³<a href=https://rust-algo.club/collections/bloom_filter>Rust æ¼”ç®—æ³•ä¿±æ¨‚éƒ¨ï¼šå¸ƒéš†éæ¿¾å™¨ Bloom Filter</a> ä¸€æ–‡ï¼Œæ­¤æ–‡ä¸åŒæ­¥æ›´æ–°ã€‚</p></blockquote><p>Bloom filter æ˜¯ä¸€ç¨®æ©Ÿç‡è³‡æ–™çµæ§‹ï¼ˆprobabilistic data structureï¼‰ï¼Œé¡ä¼¼æ–¼<a href=https://rust-algo.club/collections/set>é›†åˆ</a>ï¼Œå¸¸ç”¨æ–¼éœ€å¿«é€Ÿé©—è­‰æˆå“¡æ˜¯å¦ã€Œå¯èƒ½å­˜åœ¨ã€æˆ–æ˜¯ã€Œçµ•å°ä¸å­˜åœ¨ã€åœ¨å®¹å™¨ä¸­ï¼Œäº¦å³æœ‰æ©Ÿæœƒå‡ºç¾å‡é™½æ€§ï¼ˆfalse positiveï¼‰ï¼Œä½†çµ•ä¸æœƒæœ‰å‡é™°æ€§ï¼ˆfalse negativeï¼‰ã€‚</p><p>Bloom filter çš„å„ªå‹¢æ˜¯ï¼š</p><ul><li>é¡ä¼¼<a href=https://rust-algo.club/collections/set>é›†åˆ</a>ï¼Œå¯åœ¨ $O(1)$ æ™‚é–“è¤‡é›œåº¦é©—è­‰æˆå“¡æ˜¯å¦å­˜åœ¨ï¼Œå»åƒ…éœ€ç›¸å°å°‘çš„å„²å­˜ç©ºé–“ã€‚</li><li>æ‰¿ä¸Šï¼Œ<a href="https://hur.st/bloomfilter/?n=1M&p=0.001&m=&k=">åœ¨ 0.1% éŒ¯èª¤ç‡ä¸‹å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ åƒ…éœ€ 1.71 MiB</a>ã€‚</li><li>éå¸¸å®¹æ˜“å¯¦ä½œçš„æ©Ÿç‡è³‡æ–™çµæ§‹ï¼Œåƒ…éœ€å¤šæ¬¡é›œæ¹Šã€‚</li></ul><p>Bloom filter å‰‡æœ‰ä»¥ä¸‹çŸ­è™•ï¼š</p><ul><li>ç¶“å…¸æ¬¾ Bloom filter å®¹å™¨å¤§å°å›ºå®šï¼ˆfixed-sizeï¼‰ï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ã€‚</li><li>å¯èƒ½çµ¦å‡ºå‡é™½æ€§ç­”æ¡ˆï¼šå›å ±å­˜åœ¨ä½†å¯¦éš›ä¸å­˜åœ¨ï¼Œä¸”éŒ¯èª¤éš¨æ•¸é‡è®Šå¤šä¸Šå‡ã€‚</li><li>è‡ªèº«ä¸å„²å­˜æˆå“¡è³‡æ–™ï¼Œéœ€è¦æœ‰é¡å¤–çš„å„²å­˜è³‡æ–™æ–¹æ¡ˆã€‚</li><li>åªèƒ½æ–°å¢æˆå“¡ï¼Œä½†ä¸èƒ½ç§»é™¤æˆå“¡ï¼ˆå¯é€é<a href=#%E8%AE%8A%E5%BD%A2>è®Šå½¢</a>è§£æ±ºï¼‰ã€‚</li><li>è‹¥è¼¸å…¥è³‡æ–™é›†æœ¬èº«é›¢æ•£ï¼Œæ¥è¿‘<a href=https://en.wikipedia.org/wiki/Random_access>éš¨æ©Ÿå­˜å–</a>ï¼Œç„¡æ³•å……åˆ†åˆ©ç”¨ CPU cacheã€‚</li><li>æ‰¿ä¸Šï¼Œå› ç‚ºéš¨æ©Ÿå­˜å–ï¼Œä¸åˆ©æ–¼å»¶ä¼¸åˆ°è¨˜æ†¶é«”ä»¥å¤–çš„å¤–éƒ¨å„²å­˜è£ç½®ã€‚</li></ul><p>Bloom filter å¸¸è¦‹æ‡‰ç”¨å ´æ™¯ç‚ºï¼š</p><ul><li><a href=https://www.postgresql.org/docs/12/bloom.html>è³‡æ–™åº«åˆ©ç”¨ Bloom filter</a> ä¸­æ¸›å°‘å¯¦éš›å­˜å– disk çš„ IO é–‹éŠ·ã€‚</li><li>Chromium ç€è¦½å™¨<a href=https://chromiumcodereview.appspot.com/10896048/>é©—è­‰å¤§é‡æƒ¡æ„é€£çµ</a>ã€‚</li><li>Medium <a href=https://blog.medium.com/what-are-bloom-filters-1ec2a50c68ff>é¿å…æ¨è–¦å·²æ¨è–¦éçš„æ–‡ç« </a>ã€‚</li></ul><blockquote><p>å°çŸ¥è­˜ï¼šbloom æ˜¯é–‹èŠ±ä¹‹æ„ï¼Œä½† Bloom filter å’Œé–‹èŠ±æ²’ä»»ä½•é—œä¿‚ï¼Œåªå› ç™¼æ˜äººå§“æ°ç‚º Bloom</p></blockquote><h2 id=æ¦‚å¿µ>æ¦‚å¿µ</h2><p>Bloom filter ç”±ä¸‹åˆ—å…©å€‹éƒ¨åˆ†çµ„æˆï¼š</p><ul><li>ä¸€å€‹ $m$ ä½å…ƒçš„ä½å…ƒé™£åˆ—ï¼ˆbit arrayï¼‰</li><li>$k$ å€‹ä¸åŒçš„é›œæ¹Šå‡½æ•¸</li></ul><p>ç¶“å…¸æ¬¾çš„ Bloom filter ä½œç‚ºä¸€å€‹è¿‘ä¼¼é›†åˆçš„å®¹å™¨ï¼Œæä¾›ä¸‹åˆ—å…©å€‹æ“ä½œ</p><ul><li><strong>æ–°å¢ï¼š</strong> æ–°å¢ä¸€å€‹å€¼æ™‚ï¼Œé€é $k$ å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿ $k$ å€‹é›œæ¹Šå€¼ï¼Œåˆ†åˆ¥ä»£è¡¨åœ¨ä½å…ƒé™£åˆ—çš„ç´¢å¼•ä½ç½®ï¼Œå†å°‡ $k$ å€‹ä½ç½®çš„ä½å…ƒç¿»è½‰è‡³ 1ã€‚</li><li><strong>æŸ¥è©¢ï¼š</strong> åŒæ¨£é€é $k$ å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿ $k$ å€‹é›œæ¹Šå€¼ä½œç‚ºä½å…ƒé™£åˆ—çš„ç´¢å¼•ä½ç½®ï¼Œè‹¥æ‰€æœ‰ä½å…ƒçš†ç‚º 1ï¼Œå‰‡ä»£è¡¨è©²å€¼å­˜åœ¨ã€‚</li></ul><p><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/Bloom_filter.svg/1280px-Bloom_filter.svg.png alt></p><blockquote><p>ä¸Šåœ–é¡¯ç¤º w ä¸¦æ²’æœ‰åœ¨ {x,y,z} é›†åˆä¸­ï¼Œå› ç‚º w çš„é›œæ¹Šçµæœæœ‰å€‹ä½å…ƒç‚º 0ã€‚</p></blockquote><p>ä½ å¯èƒ½æœƒé–‹å§‹æƒ³ï¼š</p><ul><li>æ¬²å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ ï¼Œéœ€è¦å¤šå°‘ä½å…ƒï¼Ÿ</li><li>å‡ºç¾å‡é™½æ€§çš„æ©Ÿç‡æ˜¯å¤šå°‘ï¼Ÿå¯ä»¥èª¿æ•´å—ï¼Ÿ</li><li>éœ€è¦å¹¾å€‹é›œæ¹Šå‡½æ•¸ï¼Ÿ</li><li>å¯é‡è¤‡ä½¿ç”¨ç›¸åŒçš„é›œæ¹Šå‡½æ•¸å—ï¼Ÿ</li></ul><p>å›ç­”é€™äº›å•é¡Œéœ€è¦å…©å€‹å·²çŸ¥æ¢ä»¶ï¼š</p><ol><li>é æœŸæœƒå„²å­˜å¤šå°‘ $n$ å€‹å…ƒç´ åˆ°å®¹å™¨ã€‚</li><li>å¯å®¹å¿çš„å‡é™½æ€§æ©Ÿç‡ $\epsilon$ï¼Œå³å®¹å™¨ä¸åŒ…å«è©²å…ƒç´ ï¼Œæª¢æ¸¬å»å›å ±å­˜åœ¨ï¼ˆæ‰€æœ‰é›œæ¹Šä½çš†ç‚º 1ï¼‰ã€‚</li></ol><p>æ–¼æ˜¯å¯å¾—ä½å…ƒé™£åˆ—æœ€ä½³åŒ–çš„é•·åº¦ç‚º $m$ å€‹ä½å…ƒï¼Œ$m$ ç‚ºï¼š</p><p>$$m = -\frac{n \ln{\epsilon}}{(\ln{2})^2}$$</p><p>è€Œåœ¨å·²çŸ¥æ¢ä»¶ä¸‹ï¼Œéœ€è¦çš„é›œæ¹Šå‡½æ•¸æ•¸é‡ $k$ ç‚ºï¼š</p><p>$$k = -\frac{\ln{\epsilon}}{\ln{2}} = -\log_2{\epsilon}$$</p><p>ç•¶ç„¶ï¼Œé€™äº›å…¬å¼ä¸¦éæ†‘ç©ºå†’å‡ºï¼Œæœ‰èˆˆè¶£å¯ä»¥è®€è®€<a href=https://en.wikipedia.org/wiki/Bloom_filter#Optimal_number_of_hash_functions>ç¶­åŸºç™¾ç§‘ä¸Šçš„æ•¸å­¸</a>ï¼Œå’Œ<a href=https://sagi.io/bloom-filters-for-the-perplexed/#false-positive-probability-and-formulae>é€™æ®µè©³ç´°çš„æ¨å°</a>ï¼Œä¸éä¹Ÿè¦æ³¨æ„ï¼ŒBloom filter çš„å‡è¨­æ˜¯ã€Œæ¯å€‹é›œæ¹Šå‡½æ•¸ç¨ç«‹ã€ä½†<a href=https://gopiandcode.uk/logs/log-bloomfilters-debunked.html#org7b3d391>ä½å…ƒé–“æ˜¯å¦ç¨ç«‹æœ‰å¾…è¨è«–</a>ï¼Œé€™é †ä¾¿é–‹å•Ÿäº†å…¶ä»–å•é¡Œï¼Œå¯é‡è¤‡ä½¿ç”¨ç›¸åŒçš„é›œæ¹Šå‡½æ•¸å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯å¯ä»¥ï¼Œ é€™ç¯‡<a href=https://www.eecs.harvard.edu/~michaelm/postscripts/rsa2008.pdf>ã€ŒLess Hashing, Same Performance:Building a Better Bloom Filterã€</a>æåŠï¼Œåœ¨ä¸çŠ§ç‰²æ¼¸é€²å‡é™½æ€§æ©Ÿç‡ï¼ˆasymptotic false positive probabilityï¼‰çš„å‰æä¸‹ï¼Œé€éå…©å€‹ä¸åŒçš„é›œæ¹Šå‡½æ•¸ $h_1(x)$ å’Œ $h_2(x)$ï¼Œé…åˆä»¥ä¸‹å…¬å¼ï¼Œå°±å¯ä»¥æ¨¡æ“¬å‡ºå¤šå€‹é›œæ¹Šå‡½æ•¸ï¼š</p><p>$$g_i(x) = h_1(x) + ih_2(x)$$</p><p>æ•¸å­¸çœ‹æšˆäº†å—ï¼Ÿä¾†é»ç¨‹å¼ç¢¼å§ã€‚</p><h2 id=æ¶æ§‹è¨­è¨ˆ>æ¶æ§‹è¨­è¨ˆ</h2><h3 id=åˆ©ç”¨-vec-å„²å­˜ä½å…ƒ>åˆ©ç”¨ <code>Vec</code> å„²å­˜ä½å…ƒ</h3><p>Bloom filter åº•å±¤ä»¥ä½å…ƒé™£åˆ—ä½œç‚ºå„²å­˜å®¹å™¨ï¼Œå¦‚æœç›®æ¨™æ˜¯æœ€çœç©ºé–“ï¼Œè©²ç”¨ Rust çš„ä»€éº¼å‹åˆ¥ä¾†å„²å­˜ä½å…ƒå‘¢ï¼Ÿ</p><p>ç›´è§€ä½œæ³•æ˜¯åœ¨ struct æ–°å¢ä¸€å€‹ <code>bits</code> ä½å…ƒé™£åˆ—çš„ <code>array</code> å‹åˆ¥ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BloomFilter</span> {
  bits: [<span style=color:#66d9ef>bool</span>; N]
}
</code></pre></div><p>é›–ç„¶éå¸¸çœç©ºé–“ï¼Œç”¨äº†å¤šå°‘ bits é€™å€‹ struct å°±ä½”å¤šå¤§ï¼Œä½†é€™èªæ³•ä¸¦éä¸åˆæ³•ï¼Œå› ç‚º <code>N</code> æœªå®šç¾©ï¼Œç„¡æ³•ç·¨è­¯ï¼Œ<a href=https://doc.rust-lang.org/std/primitive.array.html>array</a> çš„ <code>N</code> å¿…é ˆæ˜¯ç·¨è­¯æœŸå°±æ±ºå®šçš„å¸¸æ•¸ï¼ŒBloomFilter è‹¥å¯«æ­» <code>N</code> å°±ä¸å¤ æ³›ç”¨äº†ï¼ˆé™¤éåƒè€ƒ <a href=https://doc.rust-lang.org/alloc/macro.vec.html><code>vec!</code></a> é€é macro å»ºç«‹ï¼‰ã€‚</p><p>ä¸å¦‚æ›å€‹æ–¹å‘ï¼Œä¸ç”¨ fixed size arrayï¼Œçµ¦å®šå‹•æ…‹å¤§å°çš„ <code>slice</code> è©¦è©¦çœ‹ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BloomFilter</span> {
  bits: [<span style=color:#66d9ef>bool</span>]
}
</code></pre></div><p>å—¯ï¼Œå¯ä»¥ç·¨è­¯é€šéï¼Œä½†å¦‚æœå˜—è©¦å»ºç«‹ä¸€å€‹ struct å‘¢ï¼Ÿ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>let</span> input_len <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
    <span style=color:#66d9ef>let</span> bits <span style=color:#f92672>=</span> [<span style=color:#66d9ef>true</span>; input_len];
    BloomFilter { bits };
}
</code></pre></div><p>å°±æœƒç™¼ç¾ç·¨è­¯çµæœå¦‚ä¸‹ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>error<span style=color:#f92672>[</span>E0435<span style=color:#f92672>]</span>: attempt to use a non-constant value in a constant
 --&gt; src/main.rs:7:23
  |
<span style=color:#ae81ff>7</span> |     let bits <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>true; input_len<span style=color:#f92672>]</span>;
  |                       ^^^^^^^^^ non-constant value

error<span style=color:#f92672>[</span>E0277<span style=color:#f92672>]</span>: the size <span style=color:#66d9ef>for</span> values of type <span style=color:#e6db74>`</span><span style=color:#f92672>[</span>bool<span style=color:#f92672>]</span><span style=color:#e6db74>`</span> cannot be known at compilation time
 --&gt; src/main.rs:8:5
  |
<span style=color:#ae81ff>8</span> |     BloomFilter <span style=color:#f92672>{</span> bits <span style=color:#f92672>}</span>;
  |     ^^^^^^^^^^^^^^^^^^^^ doesn<span style=color:#960050;background-color:#1e0010>&#39;</span>t have a size known at compile-time
</code></pre></div><p>åŸå› æœ‰äºŒï¼Œå…¶ä¸€åŒæ¨£æ˜¯ array <code>bits</code> éœ€è¦ä¸€å€‹å¸¸æ•¸é•·åº¦ï¼›å…¶äºŒå‰‡æ˜¯ <code>bits</code> æ˜¯ä¸€å€‹ <a href=https://doc.rust-lang.org/book/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait>Dynamic Sized Typesï¼ˆDstsï¼‰</a> ï¼Œé•·åº¦ç„¡æ³•åœ¨ç·¨è­¯æ™‚æ±ºå®šï¼Œç·¨è­¯æœŸå°±ç„¡æ³•å¾—çŸ¥ BloomFilter çš„æ‰€ä½”è¨˜æ†¶é«”ç”¨é‡ã€‚</p><p>çœ‹ä¾†å¾—æ”¾æ£„ç”¨ <code>array</code> æˆ– <code>slice</code> é€™äº›æ–¹æ³•ï¼Œæ”¹ç”¨æœ€æš´åŠ›çš„ <code>Vec</code> ä½œç‚ºä½å…ƒé™£åˆ—å„²å­˜å®¹å™¨ï¼Œ<code>Vec</code> é›–å¯å‹•æ…‹èª¿æ•´å¤§å°ï¼ŒèƒŒå¾Œå…¶å¯¦æ˜¯ä¸€å€‹ pointer + ä¸€å€‹ <code>usize</code> çš„ <code>capacity</code> + ä¸€å€‹ <code>usize</code> çš„ <code>len</code> çµ„æˆï¼Œè‹¥æ˜¯åœ¨ 64 ä½å…ƒçš„æ©Ÿå™¨ä¸Šï¼Œ<a href=https://cheats.rs/#general-purpose-heap-storage>ä¸€å€‹ <code>Vec</code> å°±æœƒä½” 24 ä½å…ƒçµ„</a>ï¼Œæ¯”èµ· <code>array</code> å¤šè€—è²»å…©å€‹ 2 * 8 å€‹ä½å…ƒçµ„ç©ºé–“ï¼Œå¹¸å¥½é€™é¡å¤–çš„ 16 å€‹ä½å…ƒçµ„æ˜¯å›ºå®šæ”¯å‡ºï¼Œä¸éš¨è‘— $m$ å’Œ $n$ æˆé•·ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BloomFilter</span> {
  bits: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span>
}
</code></pre></div><h3 id=å„²å­˜å…©å€‹é›œæ¹Šå‡½æ•¸>å„²å­˜å…©å€‹é›œæ¹Šå‡½æ•¸</h3><p>å†ä¾†ï¼Œè¦åœ¨ <code>BloomFilter</code> å„²å­˜å…©å€‹ hasherï¼Œä¹Ÿå°±æ˜¯å¯¦ä½œå‰é¢æåŠ<a href=https://www.eecs.harvard.edu/~michaelm/postscripts/rsa2008.pdf>ç”¨å…©å€‹é›œæ¹Šå‡½æ•¸æ¨¡æ“¬ $k$ å€‹</a>è«–æ–‡ä¸­çš„å…©å€‹ hasherï¼Œé€™å…©å€‹åœ¨ <code>BloomFilter</code> å»ºæ§‹æ™‚åŒæ™‚å»ºç«‹ï¼Œä¸¦åœ¨æ“ä½œ <code>BloomFilter</code> çš„æ–¹æ³•ä¸Šå…±ç”¨ã€‚</p><p>é€™æ¬¡ç›´æ¥ä½¿ç”¨æ¨™æº–å‡½å¼åº«å…§é è¨­é›œæ¹Šæ¼”ç®—æ³• <a href=http://doc.rust-lang.org/std/collections/hash_map/struct.DefaultHasher.html><code>DefaultHasher</code></a> ä½œç‚ºéš¨æ©Ÿçš„å…©å€‹é›œæ¹Šå‡½æ•¸ <code>BloomFilter.hashers</code>ã€‚ç”±æ–¼æ˜¯æ¨¡æ“¬ $k$ å€‹å‡½æ•¸çš„é›œæ¹Šè¡Œç‚ºï¼Œä»éœ€å¦é—¢æ¬„ä½ï¼Œå„²å­˜ $k$ å¯¦éš›ä¸Šæ˜¯å¤šå°‘å€‹é›œæ¹Šå‡½æ•¸ <code>BloomFilter.hash_fn_count</code>ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>use</span> std::collections::hash_map::DefaultHasher;

<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BloomFilter</span> {
  <span style=color:#e6db74>/// The bit array of _m_ bits.
</span><span style=color:#e6db74></span>  bits: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span>,
  <span style=color:#e6db74>/// Count of hash functions. Denoted by _k_.
</span><span style=color:#e6db74></span>  hash_fn_count: <span style=color:#66d9ef>usize</span>,
  <span style=color:#e6db74>/// The hashers that do real works.
</span><span style=color:#e6db74></span>  hashers: [DefaultHasher; <span style=color:#ae81ff>2</span>],
}
</code></pre></div><p>å°±å‰©æœ€å¾Œä¸€é‡Œè·¯äº†ï¼</p><h3 id=ä½¿ç”¨-phantomdatarust-std-marker-phantomdata-è®“ç·¨è­¯å™¨é–‰å˜´>ä½¿ç”¨ <a href=https://doc.rust-lang.org/core/marker/struct.PhantomData.html><code>PhantomData</code></a> è®“ç·¨è­¯å™¨é–‰å˜´</h3><p>çœ¾æ‰€å‘¨çŸ¥ï¼Œé€é<a href=https://doc.rust-lang.org/book/ch10-01-syntax.html>æ³›å‹ï¼ˆGenericï¼‰</a>ï¼ŒRust å¯é‡ç”¨ç›¸åŒçš„å®¹å™¨å‹åˆ¥ï¼Œç‰¹åŒ–æ¥å—ä¸åŒå‹åˆ¥çš„å®¹å™¨ï¼Œä¾‹å¦‚ <code>HashMap&lt;K, V></code> å¯ä»¥ç‰¹åŒ–ç‚ºéµç‚º <code>String</code>ï¼Œå€¼ç‚º <code>u32</code> çš„ <code>HashMap&lt;String, u32></code>ï¼Œ<code>Vec&lt;T></code> å¯ä»¥æˆç‚ºäºŒç¶­ä½å…ƒçµ„ <code>Vec&lt;Vec&lt;u8>></code>ã€‚çœ‹ <a href=http://doc.rust-lang.org/std/collections/index.html><code>std::collections</code></a> æä¾›çš„å®¹å™¨ï¼Œæ‰€æœ‰æ³›å‹å‹åˆ¥åƒæ•¸ï¼ˆType Parameterï¼‰åƒæ˜¯ <code>T</code>ã€<code>K</code>ã€<code>V</code> éƒ½æ˜¯è·Ÿè‘— struct å®£å‘Šï¼Œä¹Ÿå› ç‚ºé€™äº›å®¹å™¨çš„ç¢ºå¯¦éš›å„²å­˜äº†é€™äº›å‹åˆ¥çš„å…ƒç´ ï¼Œæ³›å‹å‹åˆ¥åƒæ•¸è·Ÿè‘— struct å¾ˆåˆç†ã€‚</p><p>æœ‰è¶£çš„æ˜¯ï¼Œä½œç‚ºä¸€å€‹å®¹å™¨ï¼ŒBloom filter å…¶å¯¦ä¸å„²å­˜å…ƒç´ æœ¬èº«ï¼Œè€Œæ˜¯è¨˜éŒ„å…ƒç´ æ˜¯å¦ã€Œæ›¾ç¶“æ–°å¢è‡³ã€è©²å®¹å™¨ä¸­ã€‚é€™çµ¦äº†ä¸€äº›æƒ³åƒç©ºé–“ï¼šå¦‚ä½•æä¾›å‹åˆ¥åƒæ•¸çµ¦ Bloom filterï¼Ÿæä¾›å…©å€‹æ–¹å‘ï¼š</p><ol><li><strong>æ³›å‹å‹åˆ¥åƒæ•¸å®£å‘Šè·Ÿè‘— structï¼š</strong> ä¹Ÿå°±æ˜¯ <code>struct BloomFilter&lt;T></code>ï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œä¸€å€‹å®¹å™¨å¯¦ä¾‹åªèƒ½æ“ä½œä¸€ç¨®å‹åˆ¥ï¼Œè€Œä¸”åœ¨ç·¨è­¯æœŸå°±æ±ºå®šã€‚<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>let</span> bf <span style=color:#f92672>=</span> BloomFilter::new();
bf.insert(<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span>);            <span style=color:#75715e>// infer the type T is i32
</span><span style=color:#75715e></span>bf.insert(<span style=color:#e6db74>&#34;wront type&#34;</span>);  <span style=color:#75715e>// compile error: &amp;str is not compatible to i32
</span></code></pre></div></li><li><strong>æ³›å‹å‹åˆ¥è·Ÿè‘— struct çš„æ–¹æ³•ï¼Œstruct æœ¬èº«ä¸å®£å‘Šï¼š</strong> å¾ˆé›£æƒ³åƒå®¹å™¨è£¡é¢å„²å­˜ä¸åŒçš„å‹åˆ¥ï¼Œä½† BloomFilter å¯¦éš›ä¸Šåªéœ€è¦ä¸€å€‹ <code>Vec&lt;bool></code> è¨˜éŒ„å­˜åœ¨èˆ‡å¦ï¼Œåˆ°åº•æ–°å¢äº†ä»€éº¼å‹åˆ¥çš„å…ƒç´ å…¶å¯¦ä¸é‡è¦ï¼Œå‹åˆ¥æœ‰å¯¦ä½œé›œæ¹Šå°±è¡Œã€‚é€™å€‹ä½œæ³•ä¸‹ï¼Œä½ å¯èƒ½æœƒçœ‹åˆ°é€™ç¨®é‚ªé­”æ­ªé“ï¼š<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>let</span> bf <span style=color:#f92672>=</span> BloomFilter::new();
bf.insert(<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span>);
bf.insert(<span style=color:#e6db74>&#34;another type&#34;</span>);  <span style=color:#75715e>// it works
</span><span style=color:#75715e></span>bf.insert(vec<span style=color:#f92672>!</span>[<span style=color:#ae81ff>3.14159</span>]);   <span style=color:#75715e>// it also works
</span></code></pre></div></li></ol><p>ç‚ºäº†è®“å®¹å™¨æœ‰ä¸€è‡´æ„Ÿï¼Œé€™è£¡æ±ºå®šé¸æ“‡æ³•ä¸€ï¼Œè®“æ³›å‹è·Ÿè‘—å®¹å™¨èµ°ã€‚å¯¦ä½œéå¸¸ç°¡å–®ï¼ŒåŠ ä¸Š <code>T</code> æ³›å‹åƒæ•¸å°±è¡Œ</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>use std::collections::hash_map::DefaultHasher;

<span style=color:#f92672>- pub struct BloomFilter {
</span><span style=color:#f92672></span><span style=color:#a6e22e>+ pub struct BloomFilter&lt;T&gt; {
</span><span style=color:#a6e22e></span>  /// .. snip
}
</code></pre></div><p>å“å‘€ï¼Œç·¨è­¯å¤±æ•—ï¼</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>error<span style=color:#f92672>[</span>E0392<span style=color:#f92672>]</span>: parameter <span style=color:#e6db74>`</span>T<span style=color:#e6db74>`</span> is never used
 --&gt; src/lib.rs:3:24
  |
<span style=color:#ae81ff>3</span> | pub struct BloomFilter&lt;T&gt; <span style=color:#f92672>{</span>
  |                        ^ unused parameter
  |
  <span style=color:#f92672>=</span> help: consider removing <span style=color:#e6db74>`</span>T<span style=color:#e6db74>`</span>, referring to it in a field, or using a marker such as <span style=color:#e6db74>`</span>std::marker::PhantomData<span style=color:#e6db74>`</span>
</code></pre></div><p>å› ç‚º Rust ç·¨è­¯å™¨èªç‚º <code>BloomFilter</code> ä¸¦ä¸å¯¦éš›æ“æœ‰ <code>T</code> ç›¸é—œæ¬„ä½ï¼Œå› æ­¤ç·¨è­¯ä¸é€šéï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨ <a href=https://doc.rust-lang.org/core/marker/struct.PhantomData.html><code>std::marker::PhantomData</code></a>ï¼Œ<code>PhantomData</code> æ˜¯ä¸€å€‹ Zero-Sized Type ä¸ä½”ç©ºé–“ï¼Œå°±æ˜¯ç‚ºäº†å–æ‚…ç·¨è­¯å™¨ï¼Œè£½é€ å‡º struct æ“æœ‰ <code>T</code> çš„å‡è±¡ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>use</span> std::collections::hash_map::DefaultHasher;
<span style=color:#66d9ef>use</span> std::marker::PhantomData;

<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BloomFilter</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
  <span style=color:#e6db74>/// The bit array of _m_ bits.
</span><span style=color:#e6db74></span>  bits: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span>,
  <span style=color:#e6db74>/// Count of hash functions. Denoted by _k_.
</span><span style=color:#e6db74></span>  hash_fn_count: <span style=color:#66d9ef>usize</span>,
  <span style=color:#e6db74>/// The hashers that do real works.
</span><span style=color:#e6db74></span>  hashers: [DefaultHasher; <span style=color:#ae81ff>2</span>],
  _phantom: <span style=color:#a6e22e>PhantomData</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>,
}
</code></pre></div><h2 id=sized-è®“å®¹å™¨å¯ä»¥å„²å­˜-dsts><code>?Sized</code> è®“å®¹å™¨å¯ä»¥å„²å­˜ DSTs</h2><p>æœ€å¾Œï¼Œæœ‰é‘‘æ–¼è®“Bloom fliter èƒ½å¤ æ¥å—æ›´å¤šå‹åˆ¥ï¼Œå…ƒç´ ä¸ä¸€å®šè¦ç¬¦åˆç·¨è­¯æœŸç¢ºå®šå¤§å°çš„ <a href=http://doc.rust-lang.org/std/marker/trait.Sized.html><code>Sized</code></a> trait boundï¼Œå¯ä»¥é€éåŠ ä¸Š <code>?Sized</code> trait bound è§£é™¤é è¨­çš„é™åˆ¶ï¼Œå¦‚æ­¤ä¸€ä¾† <code>BloomFilter</code> å°±å¯æ¥å— slice å’Œ trait object é€™äº› <a href=https://doc.rust-lang.org/book/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait>DSTs</a> äº†ï¼Œå‚³å…¥ string literal è®Šç‚ºå¯èƒ½ <code>bloom_filter.insert("1234")</code>ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>use std::collections::hash_map::DefaultHasher;
use std::marker::PhantomData;

<span style=color:#f92672>- pub struct BloomFilter&lt;T&gt; {
</span><span style=color:#f92672></span><span style=color:#a6e22e>+ pub struct BloomFilter&lt;T: ?Sized&gt; {
</span><span style=color:#a6e22e></span>    // .. snip
}
</code></pre></div><h2 id=åŸºæœ¬æ“ä½œ>åŸºæœ¬æ“ä½œ</h2><p>Bloom filter ç‚ºé¡ä¼¼é›†åˆçš„å®¹å™¨ï¼Œç•¶ç„¶æœ‰<a href=https://rust-algo.club/collections/set#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C>é¡ä¼¼çš„æ“ä½œ</a>ï¼Œäº‹å¯¦ä¸Šï¼Œé€™é¡æ©Ÿç‡æ€§é›†åˆæˆå“¡æª¢æ¸¬çš„è³‡æ–™çµæ§‹æœ‰å€‹è¼ƒå°‘è½è¦‹ä½†ä»¤äººå°è±¡æ·±åˆ»çš„åå­—ï¼Œç¨±ç‚ºã€ŒApproximate Membership Queryï¼ˆAMQï¼‰ã€ï¼Œæä¾› <code>add(element)</code> å’Œ <code>query(element)</code> å…©å€‹åŸºæœ¬æ“ä½œã€‚</p><p>æœ¬æ–‡çš„ <code>BloomFilter</code> æä¾›ä¸‹åˆ—å¹¾å€‹å…¬é–‹æ–¹æ³•ï¼š</p><ul><li><code>new</code>ï¼šåˆå§‹åŒ–ä¸€å€‹å®¹å™¨ã€‚</li><li><code>insert</code>ï¼šæ–°å¢ä¸€å€‹å…ƒç´ ã€‚</li><li><code>contains</code>ï¼šæª¢æŸ¥å®¹å™¨å…§æœ‰ç„¡ç‰¹å®šå…ƒç´ ï¼ˆæ˜¯å¦æ›¾æ–°å¢éï¼‰ã€‚</li></ul><p>ä»¥åŠå¹¾å€‹å…§éƒ¨è¼”åŠ©æ–¹æ³•ï¼š</p><ul><li><code>make_hash</code>ï¼šçµ¦å®šè¼¸å…¥å…ƒç´ è³‡æ–™ï¼Œé€éå…©å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿå…©å€‹é›œæ¹Šå€¼ã€‚</li><li><code>get_index</code>ï¼šå°‡ <code>make_hash</code> çš„å…©é›œæ¹Šå€¼å¸¶å…¥ $g_i(x) = h_1(x) + ih_2(x)$ è¨ˆç®—å–®æ¬¡ <code>i</code> çš„ç´¢å¼•ä½ç½®ã€‚</li><li><code>optimal_bits_count</code>ï¼šçµ¦å®šé æœŸå„²å­˜å…ƒç´ å€‹æ•¸ $n$ èˆ‡å‡é™½æ€§æ©Ÿç‡ $\epsilon$ï¼Œå¾—ä½å…ƒé™£åˆ—æœ€é©ä½å…ƒæ•¸ $m$ã€‚</li><li><code>optimal_hashers_count</code>ï¼šçµ¦å®šé æœŸå‡é™½æ€§æ©Ÿç‡ï¼Œå¾—æœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸ $k$ã€‚</li></ul><h3 id=åˆå§‹åŒ–>åˆå§‹åŒ–</h3><p>Bloom filter æœ‰å››å€‹åƒæ•¸ $m$ã€$n$ã€$k$ã€$\epsilon$ å¯ä»¥èª¿æ•´ï¼ˆè©³è¦‹ <a href=#%E6%95%88%E8%83%BD>æ•ˆèƒ½</a>ä¸€ç¯€ï¼‰ï¼Œå°ä½¿ç”¨è€…ä¾†èªªï¼Œæœ‰å¹¾å€‹é›œæ¹Šå‡½æ•¸æˆ–åº•å±¤æ˜¯å¤šå°‘å€‹ä½å…ƒéƒ½æ˜¯å¯¦ä½œç´°ç¯€äº†ï¼Œæ›´é—œå¿ƒçš„å¯èƒ½æ˜¯</p><p><em>ã€Œæˆ‘æœ‰ä¸€ç™¾è¬ç­†è³‡æ–™éœ€è¦é©—è­‰å­˜åœ¨ï¼Œå®¹éŒ¯ç‡éœ€è¦åœ¨ 0.1%ï¼Œæˆ‘éœ€è¦å¤šå¤§çš„å„²å­˜ç©ºé–“ï¼Ÿã€</em></p><p>å› æ­¤ï¼Œå»ºæ§‹å‡½æ•¸ <code>new</code> æä¾›è¼¸å…¥é æœŸå„²å­˜å…ƒç´ å€‹æ•¸ $n$ å’Œé æœŸçš„å‡é™½æ€§æ©Ÿç‡ $\epsilon$ æ˜¯å¤©ç¶“åœ°ç¾©çš„äº‹ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(capacity: <span style=color:#66d9ef>usize</span>, err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#a6e22e>Self</span>;
</code></pre></div><p>æ¥ä¸‹ä¾†ï¼Œæœƒå¯¦ä½œ<a href=#%E6%A6%82%E5%BF%B5>æ¦‚å¿µ</a>ä¸€ç¯€çš„æ•¸å­¸å…¬å¼ï¼Œæ‰¾å‡ºæœ€é©ä½å…ƒæ•¸å’Œæœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸ã€‚é€™å…©å€‹å‡½æ•¸éƒ½æ˜¯ä»¥ Rust è¡¨é”æ•¸å­¸å…¬å¼ï¼Œå¯æ³¨æ„çš„é»æ˜¯ï¼Œ<a href=http://doc.rust-lang.org/std/f32/consts/index.html><code>std::f32::consts</code></a> å’Œ <a href=http://doc.rust-lang.org/std/f64/consts/index.html><code>std::f64::consts</code></a>ï¼Œæä¾›è¨±å¤šæ•¸å­¸ä¸Šå¸¸è¦‹çš„å¸¸æ•¸è€æœ‹å‹ï¼Œæ“ä½œæµ®é»æ•¸å’Œé›™ç²¾åº¦æµ®é»æ•¸å°±ä¸ç”¨è‡ªå·±æ‰‹å‹•é‡ç®—äº†ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#e6db74>/// m = -1 * (n * ln Îµ) / (ln 2)^2
</span><span style=color:#e6db74></span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>optimal_bits_count</span>(capacity: <span style=color:#66d9ef>usize</span>, err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#66d9ef>usize</span> {
    <span style=color:#66d9ef>let</span> ln_2_2 <span style=color:#f92672>=</span> std::<span style=color:#66d9ef>f64</span>::consts::LN_2.powf(<span style=color:#ae81ff>2</span><span style=color:#66d9ef>f64</span>);
    (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> capacity <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> err_rate.ln() <span style=color:#f92672>/</span> ln_2_2).ceil() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>
}

<span style=color:#e6db74>/// k = -log_2 Îµ
</span><span style=color:#e6db74></span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>optimal_hashers_count</span>(err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#66d9ef>usize</span> {
    (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> err_rate.log2()).ceil() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>
}
</code></pre></div><p>ç›®å‰ç‚ºæ­¢ï¼Œ<code>BloomFilter::new</code> é•·é€™æ¨£ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(capacity: <span style=color:#66d9ef>usize</span>, err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#a6e22e>Self</span> {
    <span style=color:#66d9ef>let</span> bits_count <span style=color:#f92672>=</span> Self::optimal_bits_count(capacity, err_rate);
    <span style=color:#66d9ef>let</span> hash_fn_count <span style=color:#f92672>=</span> Self::optimal_hashers_count(err_rate);
}
</code></pre></div><p>æœ€å¾Œï¼ŒæŒ‰ç…§å‰è¿°<a href=https://www.eecs.harvard.edu/~michaelm/postscripts/rsa2008.pdf>å…©å€‹é›œæ¹Šå‡½æ•¸æ°æ°å¥½</a>çš„é“ç†ï¼Œå»ºç«‹å…©å€‹ä¸åŒçš„é›œæ¹Šå‡½æ•¸ï¼Œä¸¦åˆå§‹åŒ–ä½å…ƒé™£åˆ—ï¼Œå¤§åŠŸå‘Šæˆï¼</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(capacity: <span style=color:#66d9ef>usize</span>, err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#a6e22e>Self</span> {
    <span style=color:#75715e>// #1 Get optimal count of bit
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> bits_count <span style=color:#f92672>=</span> Self::optimal_bits_count(capacity, err_rate);
    <span style=color:#75715e>// #2 Get optimal count of hash functions
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> hash_fn_count <span style=color:#f92672>=</span> Self::optimal_hashers_count(err_rate);
    <span style=color:#75715e>// #3 Use RandomState to build different hasher
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> hashers <span style=color:#f92672>=</span> [
        RandomState::new().build_hasher(),
        RandomState::new().build_hasher(),
    ];

    Self {
        bits: <span style=color:#a6e22e>vec</span><span style=color:#f92672>!</span>[<span style=color:#66d9ef>false</span>; bits_count], <span style=color:#75715e>// #4 Initialize a all zero bit array
</span><span style=color:#75715e></span>        hash_fn_count,
        hashers,
        _phantom: <span style=color:#a6e22e>PhantomData</span>,
    }
}
</code></pre></div><ol><li>é€éæŒ‡å®šå‡é™½æ€§æ©Ÿç‡èˆ‡é æœŸå…ƒç´ å€‹æ•¸ï¼Œç®—å¾—æœ€é©ä½å…ƒæ•¸</li><li>é€éæŒ‡å®šå‡é™½æ€§æ©Ÿç‡ï¼Œç®—å¾—æœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸</li><li>é€é std å…§å»ºçš„ <a href=http://doc.rust-lang.org/std/collections/hash_map/struct.RandomState.html><code>RandomState</code></a> ç”¢ç”Ÿå…©å€‹ä¸åŒåˆå§‹ç‹€æ…‹çš„é›œæ¹Šå‡½æ•¸ï¼Œä»¥æ¨¡æ“¬ $k$ å€‹é›œæ¹Šå‡½æ•¸</li><li>åˆå§‹åŒ–ä¸€å€‹å…¨é›¶çš„ä½å…ƒé™£åˆ—</li></ol><h3 id=æ–°å¢>æ–°å¢</h3><p>æ–°å¢ä¸€å€‹å…ƒç´ åˆ° Bloom filterï¼Œèªªç©¿äº†å°±åšä¸€ä»¶äº‹ï¼šå°‡å…ƒç´ é€é $k$ å€‹é›œæ¹Šå‡½æ•¸ï¼Œç”¢å‡º $k$ å€‹ç´¢å¼•ä½ç½®ï¼Œä¸¦å°‡ä½å…ƒé™£åˆ—ä¸Šé€™äº›ä½ç½®çš„ä½å…ƒç¿»è½‰è‡³ 1ã€‚</p><p>æ•´å€‹ <code>insert</code> å‡½æ•¸å³ç‚ºè¨ˆç®— $g_i(x) = h_1(x) + ih_2(x)$ æ¨¡æ“¬ $k$ å€‹é›œæ¹Šå‡½æ•¸çš„éç¨‹ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>insert</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, elem: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>T</span>)
<span style=color:#66d9ef>where</span>
    T: <span style=color:#a6e22e>Hash</span>,
{
    <span style=color:#66d9ef>let</span> hashes <span style=color:#f92672>=</span> self.make_hash(elem);  <span style=color:#75715e>// #1
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> fn_i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span>..self.hash_fn_count { <span style=color:#75715e>// #2
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> index <span style=color:#f92672>=</span> self.get_index(hashes, fn_i <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>); <span style=color:#75715e>// #3
</span><span style=color:#75715e></span>        self.bits[index] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;        <span style=color:#75715e>// #4
</span><span style=color:#75715e></span>    }
}
</code></pre></div><ol><li>å–å¾— $h_1(x)$ å’Œ $h_2(x)$ çš„é›œæ¹Šè¼¸å‡ºçµæœã€‚</li><li>è¿­ä»£ <code>i</code> æ¬¡ï¼Œ<code>i</code> ä¸Šé™ç‚º $k$ï¼šåˆå§‹åŒ–æ™‚æ‰€å¾—çš„æœ€é©é›œæ¹Šå‡½æ•¸å€‹æ•¸</li><li>è¨ˆç®— $g_i(x) = h_1(x) + ih_2(x)$ å–å¾—ç´¢å¼•ä½ç½®</li><li>å°‡ç´¢å¼•ä½ç½®ä¸‹çš„ä½å…ƒè¨­å®šç‚º 1</li></ol><p>é€™è£¡æœ‰å…©å€‹å…§éƒ¨æ–¹æ³•ï¼Œå…ˆè¬›è§£å¦‚ä½•è¨ˆç®— $h_1(x)$ å’Œ $h_2(x)$ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>make_hash</span>(<span style=color:#f92672>&amp;</span>self, elem: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>T</span>) -&gt; (<span style=color:#66d9ef>u64</span>, <span style=color:#66d9ef>u64</span>)
<span style=color:#66d9ef>where</span>
    T: <span style=color:#a6e22e>Hash</span>,
{
    <span style=color:#75715e>// #1
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> hasher1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self.hashers[<span style=color:#ae81ff>0</span>].clone();
    <span style=color:#66d9ef>let</span> hasher2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self.hashers[<span style=color:#ae81ff>1</span>].clone();

    <span style=color:#75715e>// #2
</span><span style=color:#75715e></span>    elem.hash(hasher1);
    elem.hash(hasher2);

    <span style=color:#75715e>// #3
</span><span style=color:#75715e></span>    (hasher1.finish(), hasher2.finish())
}
</code></pre></div><ol><li>ç‚ºä¿å­˜å…©å€‹ hasher å…§éƒ¨åˆå§‹ç‹€æ…‹ï¼Œä½¿ç”¨ <code>clone</code> è¤‡è£½æ–°çš„ hasher ä¾†åšé›œæ¹Š</li><li>å°‡ <code>elem</code> é¤µçµ¦ hasher è¨ˆç®—é›œæ¹Šå€¼</li><li>è¼¸å‡ºé›œæ¹Šå€¼ï¼Œç”±æ–¼ <a href=http://doc.rust-lang.org/core/hash/trait.Hasher.html#tymethod.finish><code>Hasher::finish</code></a> ä¸æœƒé‡è¨­ hasher å…§éƒ¨ç‹€æ…‹ï¼Œæ‰€ä»¥éœ€è¦æ­¥é©Ÿä¸€ <code>clone</code> ä¾†ä¿ç•™ hasher çš„åŸå§‹ç‹€æ…‹</li></ol><p>å†ä¾†æ˜¯å¯¦ä½œè¨ˆç®—ç´¢å¼•ä½ç½® $g_i(x) = h_1(x) + ih_2(x)$ï¼Œé€™å€‹å‡½æ•¸éå¸¸å–®ç´”ï¼Œå°±æ˜¯è¼¸å…¥ <code>make_hash</code> æ‰€å¾—ä¹‹é›œæ¹Šå€¼ï¼Œç„¶å¾Œå¸¶å…¥å…¬å¼ä¸­ã€‚ç‚ºäº†é˜²æ­¢è¼¸å‡ºçš„ç´¢å¼•ä½ç½®è¶…éä½å…ƒé™£åˆ—çš„ä½å…ƒæ•¸ï¼Œé€™è£¡ä»¥ä½å…ƒæ•¸ $m$ å–æ¨¡ï¼ˆ<code>%</code> moduloï¼‰ï¼ŒåŠ ä¸Šä½¿ç”¨ <code>wrapping_ops</code> é€™äº› modular arithmetic operation é”æˆã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_index</span>(<span style=color:#f92672>&amp;</span>self, (h1, h2): (<span style=color:#66d9ef>u64</span>, <span style=color:#66d9ef>u64</span>), fn_i: <span style=color:#66d9ef>u64</span>) -&gt; <span style=color:#66d9ef>usize</span> {
    (h1.wrapping_add(fn_i.wrapping_mul(h2)) <span style=color:#f92672>%</span> self.bits.len() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>
}
</code></pre></div><h3 id=æŸ¥è©¢>æŸ¥è©¢</h3><p>æŸ¥è©¢å…ƒç´ æ˜¯å¦åœ¨ Bloom filter è£¡é¢ï¼Œå°±æ˜¯çœ‹çœ‹è©²å…ƒç´ é€é $k$ å€‹é›œæ¹Šå‡½æ•¸è¼¸å‡ºçš„æ¯å€‹ç´¢å¼•ä½ç½®<strong>å…¨éƒ¨ç‚º 1</strong>ï¼Œå‰‡å¯èƒ½å­˜åœ¨ï¼›å¦å‰‡å°±æ˜¯çµ•å°ä¸å­˜åœ¨ã€‚</p><p>å¯¦ä½œæ­¥é©Ÿå’Œæ’å…¥éå¸¸ç›¸ä¼¼ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>contains</span>(<span style=color:#f92672>&amp;</span>self, elem: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>T</span>) -&gt; <span style=color:#66d9ef>bool</span>
<span style=color:#a6e22e>where</span>
    T: <span style=color:#a6e22e>Hash</span>,
{
    <span style=color:#66d9ef>let</span> hashes <span style=color:#f92672>=</span> self.make_hash(elem); <span style=color:#75715e>// #1
</span><span style=color:#75715e></span>    (<span style=color:#ae81ff>0</span>..self.hash_fn_count).all(<span style=color:#f92672>|</span>fn_i<span style=color:#f92672>|</span> { <span style=color:#75715e>// #1 ä½¿ç”¨ iter
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> index <span style=color:#f92672>=</span> self.get_index(hashes, fn_i <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>);
        self.bits[index]
    })
}
</code></pre></div><ol><li>å–å¾— $h_1(x)$ å’Œ $h_2(x)$ çš„é›œæ¹Šè¼¸å‡ºçµæœã€‚</li><li>ä½¿ç”¨ <a href=http://doc.rust-lang.org/1.45.2/core/iter/trait.Iterator.html#method.all>Iterator::all</a> è¿­ä»£æ”¶é›† $k$ å€‹é›œæ¹Šå‡½æ•¸çš„è¼¸å‡º</li><li>è¨ˆç®— $g_i(x) = h_1(x) + ih_2(x)$ å–å¾—ç´¢å¼•ä½ç½®</li><li>å›å‚³ç´¢å¼•ä½ç½®ä¸‹çš„ä½å…ƒ <code>bool</code> å€¼ï¼Œæ­¤å€¼æœƒåŒ¯é›†èµ·ä¾†ï¼Œæ–¼æ­¥é©ŸäºŒç¢ºèªå‘½ä¸­å…¨éƒ¨ $k$ å€‹ç´¢å¼•ï¼Œå³ç‚ºå…ƒç´ å­˜åœ¨</li></ol><p>å®Œæ•´ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼Œæˆ–è½‰é§•åˆ° <a href=/doc/rust_algorithm_club/collections/struct.BloomFilter.html>API æ–‡ä»¶</a>ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>BloomFilter</span><span style=color:#f92672>&lt;</span>T: <span style=color:#f92672>?</span>Sized<span style=color:#f92672>&gt;</span> {
    bits: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span>,
    hash_fn_count: <span style=color:#66d9ef>usize</span>,
    hashers: [DefaultHasher; <span style=color:#ae81ff>2</span>],
    _phantom: <span style=color:#a6e22e>PhantomData</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>,
}

<span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>T: <span style=color:#f92672>?</span>Sized<span style=color:#f92672>&gt;</span> BloomFilter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span>(capacity: <span style=color:#66d9ef>usize</span>, err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#a6e22e>Self</span> {
        <span style=color:#66d9ef>let</span> bits_count <span style=color:#f92672>=</span> Self::optimal_bits_count(capacity, err_rate);
        <span style=color:#66d9ef>let</span> hash_fn_count <span style=color:#f92672>=</span> Self::optimal_hashers_count(err_rate);
        <span style=color:#66d9ef>let</span> hashers <span style=color:#f92672>=</span> [
            RandomState::new().build_hasher(),
            RandomState::new().build_hasher(),
        ];

        Self {
            bits: <span style=color:#a6e22e>vec</span><span style=color:#f92672>!</span>[<span style=color:#66d9ef>false</span>; bits_count],
            hash_fn_count,
            hashers,
            _phantom: <span style=color:#a6e22e>PhantomData</span>,
        }
    }

    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>insert</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, elem: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>T</span>)
    <span style=color:#66d9ef>where</span>
        T: <span style=color:#a6e22e>Hash</span>,
    {
        <span style=color:#75715e>// g_i(x) = h1(x) + i * h2(x)
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> hashes <span style=color:#f92672>=</span> self.make_hash(elem);
        <span style=color:#66d9ef>for</span> fn_i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span>..self.hash_fn_count {
            <span style=color:#66d9ef>let</span> index <span style=color:#f92672>=</span> self.get_index(hashes, fn_i <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>);
            self.bits[index] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
        }
    }

    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>contains</span>(<span style=color:#f92672>&amp;</span>self, elem: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>T</span>) -&gt; <span style=color:#66d9ef>bool</span>
    <span style=color:#a6e22e>where</span>
        T: <span style=color:#a6e22e>Hash</span>,
    {
        <span style=color:#66d9ef>let</span> hashes <span style=color:#f92672>=</span> self.make_hash(elem);
        (<span style=color:#ae81ff>0</span>..self.hash_fn_count).all(<span style=color:#f92672>|</span>fn_i<span style=color:#f92672>|</span> {
            <span style=color:#66d9ef>let</span> index <span style=color:#f92672>=</span> self.get_index(hashes, fn_i <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>);
            self.bits[index]
        })
    }

    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_index</span>(<span style=color:#f92672>&amp;</span>self, (h1, h2): (<span style=color:#66d9ef>u64</span>, <span style=color:#66d9ef>u64</span>), fn_i: <span style=color:#66d9ef>u64</span>) -&gt; <span style=color:#66d9ef>usize</span> {
        (h1.wrapping_add(fn_i.wrapping_mul(h2)) <span style=color:#f92672>%</span> self.bits.len() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>
    }

    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>make_hash</span>(<span style=color:#f92672>&amp;</span>self, elem: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>T</span>) -&gt; (<span style=color:#66d9ef>u64</span>, <span style=color:#66d9ef>u64</span>)
    <span style=color:#66d9ef>where</span>
        T: <span style=color:#a6e22e>Hash</span>,
    {
        <span style=color:#66d9ef>let</span> hasher1 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self.hashers[<span style=color:#ae81ff>0</span>].clone();
        <span style=color:#66d9ef>let</span> hasher2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self.hashers[<span style=color:#ae81ff>1</span>].clone();

        elem.hash(hasher1);
        elem.hash(hasher2);

        (hasher1.finish(), hasher2.finish())
    }

    <span style=color:#e6db74>/// m = -1 * (n * ln Îµ) / (ln 2)^2
</span><span style=color:#e6db74></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>optimal_bits_count</span>(capacity: <span style=color:#66d9ef>usize</span>, err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#66d9ef>usize</span> {
        <span style=color:#66d9ef>let</span> ln_2_2 <span style=color:#f92672>=</span> std::<span style=color:#66d9ef>f64</span>::consts::LN_2.powf(<span style=color:#ae81ff>2</span><span style=color:#66d9ef>f64</span>);
        (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> capacity <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> err_rate.ln() <span style=color:#f92672>/</span> ln_2_2).ceil() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>
    }

    <span style=color:#e6db74>/// k = -log_2 Îµ
</span><span style=color:#e6db74></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>optimal_hashers_count</span>(err_rate: <span style=color:#66d9ef>f64</span>) -&gt; <span style=color:#66d9ef>usize</span> {
        (<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#66d9ef>f64</span> <span style=color:#f92672>*</span> err_rate.log2()).ceil() <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>usize</span>
    }
}
</code></pre></div><h2 id=æ•ˆèƒ½>æ•ˆèƒ½</h2><table><thead><tr><th>Notation</th><th>Description</th></tr></thead><tbody><tr><td>$n$</td><td>é æœŸå„²å­˜ $n$ å€‹å…ƒç´ åˆ°å®¹å™¨ä¸­</td></tr><tr><td>$m$</td><td>ä½¿ç”¨ $m$ ä½å…ƒçš„ä½å…ƒé™£åˆ—ä¾†å„²å­˜</td></tr><tr><td>$k$</td><td>æœ‰ $k$ å€‹é›œæ¹Šå‡½æ•¸è¨ˆç®—ç´¢å¼•ä½ç½®</td></tr><tr><td>$\epsilon$</td><td>å‡é™½æ€§éŒ¯èª¤çš„æ©Ÿç‡ $\epsilon$</td></tr></tbody></table><p>å’Œå¸¸è¦‹çš„å®¹å™¨è³‡æ–™çµæ§‹ä¸å¤ªä¸€æ¨£ï¼Œè¤‡é›œåº¦å’Œ $n$ å…ƒç´ å€‹æ•¸è„«é‰¤ï¼Œè€Œæ˜¯å’Œ $k$ å’Œ $m$ ç›¸é—œï¼š</p><table><thead><tr><th>Operation</th><th>Time complexity</th></tr></thead><tbody><tr><td>insert(v)</td><td>$O(k)$</td></tr><tr><td>contains(v)</td><td>$O(k)$</td></tr></tbody></table><p>è€Œå„²å­˜ç©ºé–“è¤‡é›œåº¦å‰‡æ˜¯ $O(m)$ã€‚</p><p>æ–°å¢å’Œæœå°‹ä¸€å€‹å…ƒç´ å€‹åˆ¥éœ€è¦é›œæ¹Š $k$ æ¬¡ï¼Œå› æ­¤æ™‚é–“è¤‡é›œåº¦ç‚º $O(k)$ é¡¯è€Œæ˜“è¦‹ï¼Œç„¶è€Œï¼Œ$k$ é€šå¸¸ç›¸å° $m$ $n$ æ˜¯éå¸¸å°çš„æ•¸å­—ï¼Œä¾‹å¦‚
<a href="https://hur.st/bloomfilter/?n=1M&p=0.001&m=&k=">åœ¨ 0.1% éŒ¯èª¤ç‡ä¸‹å„²å­˜ä¸€ç™¾è¬å€‹å…ƒç´ åƒ…éœ€ 1.71 MiB å’Œ 7 å€‹é›œæ¹Šå‡½æ•¸</a>ï¼Œå¯¦å‹™ä¸Šç›´æ¥ç•¶ä½œ $O(1)$ ä¹Ÿä¸ç®—éŒ¯ã€‚</p><p>è‡³æ–¼ç©ºé–“è¤‡é›œåº¦ï¼Œç”±æ–¼å¿…é ˆäº‹å…ˆé…ç½®å¥½ $m$ ä½å…ƒçš„ä½å…ƒé™£åˆ—ï¼Œå°±ç®—æ–°å¢çš„å…ƒç´  $n \gt m$ï¼Œä¹Ÿä¸æœƒå†æ–°å¢æ–°ä½å…ƒï¼Œå› æ­¤ç©ºé–“ä½¿ç”¨ç‚º $O(m)$ å€‹ä½å…ƒã€‚å¯¦å‹™ä¸Šï¼Œç•¶ $n$ æˆé•·åˆ°æ¥è¿‘ $m$ æ™‚ï¼Œå‡é™½æ€§çš„æ©Ÿç‡æœƒå¤§å¢ï¼Œä¸å ªä½¿ç”¨ï¼Œé€²è€Œéœ€è¦èƒ½å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“çš„ Bloom filter è®Šå½¢ã€‚</p><h2 id=è®Šå½¢>è®Šå½¢</h2><p>ç¶“å…¸æ¬¾ Bloom filter å®¹æ˜“å¯¦ä½œï¼Œæ­·ä¹…ä¸è¡°ï¼Œä¸éä»æœ‰è¨±å¤šå¯ä»¥å¢é€²ç©ºé–“ï¼š</p><ul><li>Data locality ä¸å¤ å¥½ï¼šBloom filter åº•å±¤å„²å­˜æ˜¯ä½å…ƒé™£åˆ—<a href=https://en.wikipedia.org/wiki/Random_access>éš¨æ©Ÿå­˜å–</a>ï¼Œè¼ƒä¸ç¬¦åˆç¾ä»£ CPU æ¶æ§‹çš„ cache line ä½¿ç”¨å§¿å‹¢ã€‚Cloudflare æŠ€è¡“éƒ¨è½æ ¼æ–‡ <a href=https://blog.cloudflare.com/when-bloom-filters-dont-bloom/>When Bloom filters don&rsquo;t bloom</a> ä»¥å¹½é»˜ç­†æ³•å¸¶å‡ºé€™å€‹å•é¡Œï¼Œå€¼å¾—ä¸€è®€ã€‚</li><li>é›œæ¹Šæ¬¡æ•¸éå¤šï¼šBloom filter æ¯ä¸€å€‹æ–°å¢æŸ¥è©¢æ“ä½œéƒ½éœ€è¦é›œæ¹Š $k$ æ¬¡ï¼Œå°±ç®—åˆ©ç”¨ double hashing é‚„æ˜¯è¦é›œæ¹Šå…©æ¬¡ï¼Œæ¯”èµ·å…¶ä»–é¡ä¼¼è³‡æ–™çµæ§‹ç¡¬ç”Ÿç”Ÿå¤šé›œæ¹Šæ•¸æ¬¡ã€‚</li><li>ä½å…ƒé™£åˆ—å¤§å°å›ºå®šï¼šBloom filter å®¹å™¨å¤§å°å›ºå®šï¼Œçµ¦ä½ é æœŸçš„å…ƒç´ å€‹æ•¸å¾Œï¼Œç„¡æ³•å‹•æ…‹èª¿æ•´å„²å­˜ç©ºé–“ï¼Œ</li><li>bits per entry è¼ƒé«˜ï¼šä»¥é¡ä¼¼åŠŸèƒ½çš„çš„è³‡æ–™çµæ§‹ä¾†èªªï¼ŒBloom filter åœ¨ç©ºé–“åˆ©ç”¨ç‡ä¸Šï¼Œæ¬²ç¶­æŒä¸€å®šçš„å‡é™½æ€§æ©Ÿç‡ï¼Œæ¯å€‹å…ƒç´ æ‰€éœ€ä½å…ƒæ•¸ç›¸å°è¼ƒé«˜ï¼Œéœ€è¦ $1.44 \log_2{\frac{1}{\epsilon}}$ å€‹ä½å…ƒã€‚</li></ul><p>é€™è£¡ä»‹ç´¹å¹¾æ¬¾å˜—è©¦è§£æ±ºä¸Šè¿°å•é¡Œçš„ filterï¼Œæ‚¨ä¹Ÿå¯ä»¥å» <a href=https://en.wikipedia.org/wiki/Bloom_filter#Extensions_and_applications>Wikipedia çœ‹çœ‹å…¶ä»–æ›´å¤šè®Šå½¢çš„ä»‹ç´¹</a>ã€‚</p><h3 id=å¯ä»¥è¨ˆæ•¸çš„-counting-bloom-filter>å¯ä»¥è¨ˆæ•¸çš„ Counting Bloom filter</h3><p><a href=https://en.wikipedia.org/wiki/Counting_Bloom_filter>ğŸ“š ç¶­åŸºç™¾ç§‘</a></p><p>ç¶“å…¸æ¬¾ Bloom filter ä¹‹æ‰€ä»¥ç„¡æ³•åˆªé™¤å…ƒç´ ï¼Œæ˜¯å› ç‚ºæ²’æœ‰è¨˜éŒ„å“ªäº›å…ƒç´ æ–°å¢/åˆªé™¤çš„è³‡è¨Šï¼Œè€Œ Counting Bloom filter é¡§åæ€ç¾©ï¼ŒåŸæœ¬ç”¨ä¸€å€‹ä½å…ƒå„²å­˜ 0 / 1 è³‡è¨Šï¼Œå»¶ä¼¸ç‚ºå¤šä½å…ƒæ–¹ä¾¿å„²å­˜è¨ˆæ•¸ï¼ˆcountingï¼‰ï¼Œæœ‰äº†å€‹åˆ¥å…ƒç´ å¢åˆªè³‡è¨Šï¼ŒBloom filter å› æ­¤èƒ½å¯¦ä½œã€Œåˆªé™¤å…ƒç´ ã€ã€‚æœå°‹ä¸€å€‹ Counting Bloom filter æ˜¯å¦æ“æœ‰ n æ¬¡ä»¥ä¸Š xï¼Œç­”æ¡ˆä¸€æ¨£å’Œ Bloom filter é¡ä¼¼æ˜¯ã€Œå¯èƒ½æœ‰ n æ¬¡ä»¥ä¸Šçš„ xã€æˆ–æ˜¯ã€Œx çµ•å°æ²’æœ‰ n æ¬¡ä»¥ä¸Šã€ã€‚äº‹å¯¦ä¸Šï¼Œå¯å°‡ Counting Bloom filter è¦–ç‚º Bloom filter çš„ä¸€èˆ¬åŒ–å½¢å¼ï¼ˆgeneralized formï¼‰ï¼Œè€Œç¶“å…¸æ¬¾ Bloom filter åéä¾†å¯ç•¶ä½œåªè¨˜ä¸€æ¬¡æ•¸çš„ç‰¹åŒ–ã€‚</p><p>ä½† Counting Bloom filter çš„ç¼ºé»æ˜¯ç©ºé–“éœ€æ±‚å¤§ï¼Œç«¯çœ‹æ±ºå®šè¦ç”¨å¹¾å€‹ä½å…ƒè¨ˆæ•¸ï¼Œä¾‹å¦‚å¸¸è¦‹ç”¨ 4 å€‹ä½å…ƒè¨ˆæ•¸ï¼Œå‰‡æ˜¯ç¶“å…¸æ¬¾çš„å››å€ç©ºé–“æ¶ˆè€—ã€‚</p><h3 id=å‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°çš„-scalable-bloom-filter>å‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°çš„ Scalable Bloom Filter</h3><p><a href=https://gsd.di.uminho.pt/members/cbm/ps/dbloom.pdf>ğŸ“š è«–æ–‡é€£çµ</a></p><p>Scalable Bloom Filter çš„ç‰¹è‰²æ˜¯ï¼šå‹•æ…‹é©æ‡‰ç©ºé–“å¤§å°ï¼Œä¸éœ€äº‹å…ˆçŸ¥é“é æœŸå„²å­˜çš„å…ƒç´ å€‹æ•¸ã€‚</p><p>Scalable Bloom Filter çš„å¯¦ä½œè »æš´åŠ›çš„ï¼Œæœ¬èº«æ˜¯ç”±ä¸€è‡³å¤šå€‹ç¶“å…¸æ¬¾ Bloom filter çµ„æˆï¼Œè‹¥ä¸€å€‹ filter æ»¿äº†ï¼ˆè¶…é fill ratioï¼‰ï¼Œå‰‡æœƒæ–°å¢ä¸€å€‹ filterï¼Œå¾€å¾Œæ‰€æœ‰æ–°å¢éƒ½åœ¨é€™å€‹æ–° filter ä¸Šé¢ï¼Œç›´åˆ°å®ƒä¹Ÿæ»¿äº†ï¼Œå¯è¦–ç‚ºä¸€å€‹ recursive data structureã€‚</p><p>è‡³æ–¼æŸ¥è©¢ï¼Œé€™å°±æ˜¯ Scalable Bloom Filter æ¯”è¼ƒå¼±çš„åœ°æ–¹ï¼ŒæŸ¥è©¢æœƒå¾ç¬¬ä¸€å€‹ filter é–‹å§‹æ‰¾ï¼Œè‹¥æ‰¾ä¸åˆ°å¾€ä¸‹ä¸€å€‹ filter æ‰¾ï¼Œæ‰¾åˆ°æœƒæ²’æœ‰ä¸‹ä¸€å€‹ filter ç‚ºæ­¢ã€‚è‹¥ filter æ•¸é‡ç‚º $l$ï¼Œå‰‡æŸ¥è©¢çš„æ™‚é–“è¤‡é›œåº¦å¾ $O(k)$ è®Šæˆ $O(k \cdot l)$ã€‚</p><p>é™¤äº†åˆå§‹åŒ–å¤§å°å’Œå‡é™½æ€§æ©Ÿç‡ç‡ï¼ŒScalable Bloom Filter æä¾›è¨­å®šæˆé•·ç‡å’Œå‡é™½æ€§éŒ¯èª¤ç·Šç¸®ç‡ï¼š</p><ul><li>æˆé•·å› å­ $s$ï¼šæ¯å€‹æ–°å¢çš„ filter ç©ºé–“å¤§å°æˆé•·ç‡ï¼Œè«–æ–‡çš„ç¶“é©—æ³•å‰‡å¾—å‡ºé æœŸå°æˆé•·è¶¨å‹¢é¸æ“‡ $s = 2$ï¼Œæœ‰è¼ƒå¤§æˆé•·è¶¨å‹¢å‰‡ $s = 4$ æ•ˆæœå¥½ã€‚</li><li>éŒ¯èª¤ç·Šç¸®ç‡ $r$ï¼š æ¯å€‹æ–°å¢çš„ filter æœƒä»¥ç­‰æ¯”ç´šæ•¸å¾—åˆ°æ›´ç·Šç¸®çš„å‡é™½æ€§æ©Ÿç‡ä¸Šé™ï¼Œç”±æ–¼æ˜¯ç­‰æ¯”ç´šæ•¸ï¼Œé€¼è¿‘æ¥µé™æ™‚æœƒå°æ–¼åŸå§‹æ©Ÿç‡ï¼Œé€™è®“æ•´é«”å‡é™½æ€§æ©Ÿç‡å¾—ä»¥ä¿æŒã€‚è«–æ–‡ä¸­å¯¦è­‰ 0.8 åˆ° 0.9 åœ¨å…ƒç´ é æœŸæœ‰å¤§æˆé•·ç‡ä¸‹æœ‰æœ€ä½³å¹³å‡ç©ºé–“åˆ©ç”¨ç‡ã€‚</li></ul><h3 id=quotient-filter>Quotient filter</h3><p><a href=http://vldb.org/pvldb/vol5/p1627_michaelabender_vldb2012.pdf>ğŸ“š è«–æ–‡é€£çµ</a>ï¼ˆç›´æ¥è®€è«–æ–‡æ›´æ˜“æ‡‚ï¼‰</p><p>å•†æ•¸éæ¿¾å™¨ï¼ˆQuotient filterFï¼‰åˆ©ç”¨<a href=https://rust-algo.club/collections/hash_map>é›œæ¹Šè¡¨</a>ç‚ºåº•å±¤å„²å­˜å®¹å™¨ï¼Œä¾†åšé›†åˆæˆå“¡æª¢æ¸¬çš„ AMQï¼Œç‚ºäº†ç¯€çœç©ºé–“ä½¿ç”¨é‡ï¼ŒQuotient filter çš„é›œæ¹Šè¡¨åªå„²å­˜ partial-keyï¼Œä¿—ç¨±æŒ‡ç´‹ï¼ˆfingerprintï¼‰ï¼ŒæŒ‡ç´‹çš„éµçŸ­ç©ºé–“ç”¨é‡ä½ï¼Œå‰¯ä½œç”¨æ˜¯æ›´å®¹æ˜“ç¢°æ’ï¼Œä»£è¡¨éœ€è¦æ›´æœ‰æ•ˆè™•ç†é›œæ¹Šç¢°æ’ï¼ˆhash collisionï¼‰ã€‚</p><p>ä¸€èˆ¬ä¾†èªªï¼Œ<a href=https://rust-algo.club/collections/hash_map#%E8%99%95%E7%90%86%E9%9B%9C%E6%B9%8A%E7%A2%B0%E6%92%9E>è™•ç†é›œæ¹Šç¢°æ’</a>æœ‰ separate chaining å’Œ Open addressping å…©å¤§é¡æ–¹æ³•ï¼Œè€Œ Quotient filter é¸æ“‡äº†å¦ä¸€æ¢è©­è­çš„æ–¹æ³•ï¼šåˆ©ç”¨ open addressing ä¸­ linear probing çš„æ–¹å¼ï¼Œå°æ¯å€‹ slot å„²å­˜é¡å¤–è³‡è¨Šï¼Œä½¿å¾—æˆ‘å€‘å¯è¾¨èªç¢°æ’çš„å…ƒç´ æ˜¯åœ¨ç›¸åŒæŒ‡ç´‹ä¸‹çš„åŒå€‹ bucket å…§ã€‚æ›å¥è©±èªªï¼Œé¡å¤–è³‡è¨Šå°±æ˜¯åœ¨ã€Œé€é linear probing æ¨¡æ“¬ separate chainingã€ã€‚</p><p>å›åˆ°æŒ‡ç´‹ï¼ŒQuotient filter å¯¦éš›ä¸Šä¸¦ä¸ç›´æ¥å„²å­˜æŒ‡ç´‹ï¼Œè€Œæ˜¯å°‡æŒ‡ç´‹ $f$ é€²ä¸€æ­¥æ‹†æˆå•† $f_q$ èˆ‡é¤˜æ•¸ $f_r$ï¼Œå•†ä½œç‚ºç´¢å¼•ä½ç½®ï¼Œè€Œé¤˜æ•¸å‰‡ç‚ºçœŸå¯¦è¢«å„²å­˜çš„å€¼ã€‚é€éå•†å’Œé¤˜æ•¸ï¼Œå¯é‡çµ„å›æ¨åŸæœ¬çš„æŒ‡ç´‹ã€‚ä¸éœ€å­˜å®Œæ•´çš„æŒ‡ç´‹ï¼Œåˆå†æ¬¡æ¸›å°‘ç©ºé–“ä½¿ç”¨é‡ï¼Œå¸¥ï¼</p><p>ç°¡å–®ç¸½çµ Quotient filter çš„ç‰¹æ€§ï¼š</p><ul><li>ä½¿ç”¨ linear probing è§£æ±ºé›œæ¹Šç¢°æ’ï¼Œdata locality å¥½ï¼Œæœ‰ cache friendlyã€‚</li><li>æœ‰é¡å¤–å„²å­˜è³‡è¨Šï¼Œå¯åœ¨ä¸é‡å»ºä¸ rehash filter çš„æƒ…æ³ä¸‹æ”¯æ´åˆªé™¤ã€åˆä½µã€èª¿æ•´ç©ºé–“ã€‚</li><li>ç¶œåˆä¸Šè¿°å…©é»ï¼Œéå¸¸é©åˆ LSM-tree ç­‰éœ€è¦å­˜å– SSD çš„å ´æ™¯ï¼Œå¤§å¹…æ¸›å°‘ I/Oã€‚</li><li>Throughput å—åˆ°é›œæ¹Šè¡¨ load factor å½±éŸ¿è¼ƒå¤§ã€‚</li><li>ç©ºé–“ç”¨é‡ä»æ¯”ç¶“å…¸æ¬¾ Bloom filter å¤š 10% åˆ° 25%ã€‚</li></ul><p><img src=./quotient-filter.png alt></p><blockquote><p>Quotient filter èˆ‡å®ƒç­‰åƒ¹çš„ open addressing hash map</p></blockquote><p><em>Image Source: <a href=http://vldb.org/pvldb/vol5/p1627_michaelabender_vldb2012.pdf>Bender, et al., 2012. &ldquo;Donâ€™t Thrash: How to Cache Your Hash on Flash&rdquo;</a>.</em></p><h3 id=æ”¯æ´åˆªé™¤å…ƒç´ çš„-cuckoo-filter>æ”¯æ´åˆªé™¤å…ƒç´ çš„ Cuckoo filter</h3><p><a href=https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf>ğŸ“š è«–æ–‡é€£çµ</a>ï¼ˆæœ‰è¶£æ˜“è®€ï¼Œèª æ‘¯æ¨è–¦ï¼‰</p><p>Cuckoo hashing æ˜¯ä¸€ç¨®è§£æ±ºé›œæ¹Šç¢°æ’çš„æ–¹æ³•ï¼Œé€éä¸€æ¬¡è¨ˆç®—å…©å€‹é›œæ¹Šå‡½æ•¸ç”¢ç”Ÿå…©å€‹ç´¢å¼•ä½ç½®ï¼Œè‹¥å…¶ä¸­ä¸€å€‹ä½ç½®æœ‰ç©ºä½å‰‡æ’å…¥ç©ºä½ï¼Œè‹¥éƒ½æ²’æœ‰ç©ºä½ï¼Œå‰‡éš¨æ©Ÿè¸¢æ‰ä¸€å€‹ï¼Œè¢«è¸¢æ‰çš„å†å»æ‰¾ä¸‹ä¸€å€‹æ›¿æ­»é¬¼ï¼Œç›´åˆ°å…¨éƒ¨éƒ½æœ‰ä½ç½®ï¼Œæˆ–è¸¢æ‰æ¬¡æ•¸å¤§æ–¼ä¸€å®šå€¼å‰‡åœæ­¢ã€‚é€™ç¨®è¡Œç‚ºå’Œæœéµ‘é³¥ï¼ˆcuckooã€å¸ƒç©€é³¥ï¼‰é³©ä½”éµ²å·¢çš„ç”Ÿç‰©ç¿’æ€§å¾ˆåƒï¼Œå› æ­¤å¾—åã€‚</p><p>Cuckoo filter åˆ©ç”¨<a href=./hash_map>é›œæ¹Šè¡¨</a>ç‚ºåº•å±¤å„²å­˜å®¹å™¨ï¼Œä¾†åšé›†åˆæˆå“¡æª¢æ¸¬çš„ AMQï¼Œæœƒå’Œ cuckoo æ‰¯ä¸Šé—œä¿‚å‰‡æ˜¯å› ç‚ºä½¿ç”¨ Cuckoo hashing è§£æ±ºé›œæ¹Šç¢°æ’ï¼Œä»¥å¢åŠ ç©ºé–“ä½¿ç”¨ç‡ï¼ˆé”åˆ° 95% occupancyï¼‰ã€‚Cuckoo filter çš„é›œæ¹Šè¡¨å’Œ Quotient filter ä¸€æ¨£ï¼Œç‚ºäº†æ¸›å°‘ç©ºé–“ä½¿ç”¨é‡è€Œåªå„²å­˜ partial-keyã€‚</p><p>å„²å­˜æŒ‡ç´‹å°è‡´éµè®ŠçŸ­ï¼Œå®¹æ˜“ç¢°æ’ï¼Œä¹Ÿä»£è¡¨è¬ä¸€ç¢°æ’ï¼Œæ²’è¾¦æ³•é€éåŸå§‹çš„éµå†æ¬¡é›œæ¹Šä¾†æ‰¾åˆ° Cuckoo hasing å°æ‡‰å¦ä¸€ä½ç½®ï¼Œä¸é Cuckoo filter å·§å¦™åˆ©ç”¨ XOR çš„ identity $x \oplus x = 0$ è§£æ±ºå•é¡Œï¼Œdouble hashing å…¬å¼å¥‰ä¸Šï¼š</p><p>$$
h_1(x) = hash(x) \\
h_2(x) = h_1(x) \oplus hash(fingerprint(x))
$$</p><p>å¦‚æ­¤ä¸€æ¬¡ï¼Œé€é $h_2(x)$ å’ŒæŒ‡ç´‹çš„ XOR å°±å¯ä»¥å¾—åˆ° $h_1(x)$ï¼Œå…¬å¼é€²è€Œå¯ä¸€èˆ¬åŒ–æˆï¼š</p><p>$$j = i \oplus hash(fingerprint(x))$$</p><p>å…¶ä¸­ $j$ èˆ‡ $i$ ç‚ºåŒå€‹å…ƒç´ ç¶“éå…©å€‹é›œæ¹Šå‡½æ•¸ä¸­ä»»ä¸€çš„å€¼ï¼Œç¥å¥‡å§ï¼</p><p>Cuckoo filter çš„ç‰¹æ€§æ˜¯ï¼š</p><ul><li>æ”¯æ´å‹•æ…‹æ–°å¢èˆ‡åˆªé™¤å…ƒæ•¸ã€‚</li><li>æ¯”å…¶ä»– filter è®Šå½¢ï¼ˆä¾‹å¦‚ Quotient filterï¼‰å¥½å¯¦ä½œï¼Œå¦‚æœæ‡‚ Cuckoo hashing çš„è©±ã€‚</li><li>æŸ¥è©¢æ•ˆèƒ½æ¯”ç¶“å…¸æ¬¾ Bloom filter å¥½ï¼Œbits per item ä¹Ÿæ¯”è¼ƒä½ï¼ˆ$(\log_2{\frac{1}{\epsilon}} + 2) / \alpha$ï¼Œ$\alpha$ æ˜¯é›œæ¹Šè¡¨çš„ load factorï¼Œé€šå¸¸ç‚º 95.5%ï¼‰ã€‚</li><li>ç¼ºé»æ˜¯ã€Œä¸€å®šè¦å…ˆæ–°å¢éä¸€å€‹å…ƒç´ ï¼Œæ‰èƒ½å° filter åˆªé™¤è©²å…ƒç´ ã€ï¼Œä½†é€™æ˜¯æ‰€æœ‰æ”¯æ´åˆªé™¤çš„ filter çš„é€šç—…ï¼Œä¸ç„¶å°±æœƒæœ‰å‡é™½æ€§ç™¼ç”Ÿã€‚</li></ul><p><img src=./cuckoo-filter.png alt></p><p><em>Image Source: <a href=https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf>Fan, et al., 2014. &ldquo;Cuckoo Filter: Practically Better Than Bloom&rdquo;</a>.</em></p><h2 id=åƒè€ƒè³‡æ–™>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://citeseerx.ist.psu.edu/viewdoc/download;?doi=10.1.1.641.9096&rep=rep1&type=pdf">Burton H. Bloom: Space/Time Trade-offs in Hash Coding with Allowable Errors</a></li><li><a href=https://en.wikipedia.org/wiki/Bloom_filter>Wiki: Bloom filter</a></li><li><a href=https://www.eecs.harvard.edu/~michaelm/postscripts/rsa2008.pdf>Less Hashing, Same Performance:Building a Better Bloom Filter</a></li><li><a href=https://onatm.dev/2020/08/10/let-s-implement-a-bloom-filter/>Onat: Let&rsquo;s implement a Bloom Filter</a></li><li><a href=https://github.com/google/guava/blob/v29.0/guava/src/com/google/common/hash/BloomFilter.java>Google Guava: BloomFilter</a></li><li><a href=https://hur.st/bloomfilter/>Bloom Filter Calculator</a></li></ul></div><footer class=entry-footer><div class="container sep-before"><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/algorithms/>Algorithms</a></div></div><div style=text-align:center;padding-top:2em><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/><img src=https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png alt=cc-by-nc-sa-4></a></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/posts/2020/www-0x17/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>WWW 0x17: å†è¦‹ weekly</a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://facebook.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Facebook account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href=https://twitter.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=https://linkedin.com/in/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Telegram icon</title><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2017-2020 Weihang Lo</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script src=/js/custom.js></script><link rel=stylesheet href=//unpkg.com/katex/dist/katex.min.css><script src=//unpkg.com/katex/dist/katex.min.js></script><script src=//unpkg.com/katex/dist/contrib/auto-render.min.js></script><script type=text/javascript>renderMathInElement(document.querySelector('.entry-content'),{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":false,"left":"$","right":"$"}]});</script></body></html>