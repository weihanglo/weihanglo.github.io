<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>WWW 0x16: JWT、分散式 ID 生成、k8s 安全性 | Weihang Lo</title>
<meta name=keywords content="DevOps,Distributed Systems">
<meta name=description content="這裡是 WWW 第貳拾貳期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多">
<meta name=author content>
<link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x16/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style>
<link rel=icon href=https://weihanglo.tw/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://weihanglo.tw/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://weihanglo.tw/favicon-32x32.png>
<link rel=apple-touch-icon href=https://weihanglo.tw/apple-touch-icon.png>
<link rel=mask-icon href=https://weihanglo.tw/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script>
<meta property="og:title" content="WWW 0x16: JWT、分散式 ID 生成、k8s 安全性">
<meta property="og:description" content="這裡是 WWW 第貳拾貳期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多">
<meta property="og:type" content="article">
<meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x16/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-06-20T00:00:00+08:00">
<meta property="article:modified_time" content="2020-06-20T00:00:00+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="WWW 0x16: JWT、分散式 ID 生成、k8s 安全性">
<meta name=twitter:description content="這裡是 WWW 第貳拾貳期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://weihanglo.tw/posts/"},{"@type":"ListItem","position":3,"name":"WWW 0x16: JWT、分散式 ID 生成、k8s 安全性","item":"https://weihanglo.tw/posts/2020/www-0x16/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WWW 0x16: JWT、分散式 ID 生成、k8s 安全性","name":"WWW 0x16: JWT、分散式 ID 生成、k8s 安全性","description":"這裡是 WWW 第貳拾貳期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多","keywords":["DevOps","Distributed Systems"],"articleBody":"這裡是 WWW 第貳拾貳期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。\nKubernetes Blog: 11 Ways (Not) to Get Hacked 管理 Kubernetes 就和管理 VM 一樣，一定會遇到各種安全性問題，這篇文章提出 11 種可以增加安全性的小撇步，順便分享 @hwchiu 整理的中文版，資訊更多更完整，感恩惜福。\nJWT 是否適合 session mechanism 最近翻到 The Ultimate Guide to handling JWTs on frontend clients 這篇小巧精緻的 JWT 身分驗證教學，流程圖簡明易懂，內容包括：\n JWT 的結構：header.payload.signature JWT 會儲存在 client-side，不適合儲存敏感資料 JWT 不適合放在 browser storage，容易被 XSS（所以推薦 in-memory） 由於 JWT 本身無狀態，誰幹走都能奪權，請保持 JWT 過期時間不會太長，文中案例是 15 分鐘 鑑於過期比較快，請配合 HttpOnly 的 cookie 的 refresh token 來更新 JWT（但 XSS 還是有點不安全） Revoke all login sessions 可以簡單透過 refresh token 達成：刪除該使用者的所有 refresh token 就行 Server-side rendering 和 JWT + refresh token 如何整合：JWT 會存在 SSR server 上，refresh token 則是每個 page request 都會產生新的 token  有趣的是，留言提出許多 JWT 與這篇文章的實作總總問題，像是：\n JWT 不適合用在 session 上 文章 refresh token 還是會被 XSS 多個 tab 同時發送 refresh token API 要如何處理 IETF RFC 建議 refresh token 每次 refresh 都要產生新的  句句都在逼宮作者，但作者完全沒有出來說明，於是我只能好好點擊進入留言中的文章分享。不看也罷，一看便驚天地泣鬼神。\n這篇 Stop using JWT for sessions 的標題就破題了（好像很正常），主要是在戳破那些 JWT 沒有告訴你的事，主要是：\n JWT 開啟 session 透過 JavaScript 控制的大門，相較於 HttpOnly cookie 更不安全更容 XSS 無法主動過期，如果 token 權限設定錯誤或是伺服器受攻擊，很難第一時間解決問題 還是需要 cookie consent，functional purpose 像登入使用產品服務，本來就不需要 cookie consent，追蹤行為才需要使用者同意。  看來 JWT vs. cookie 大戰還會持續下去。\nLeaf——美团点评分布式ID生成系统 本篇文章把分散式 ID 生成常見的解法和需求點出來，最後歸納出適合美團使用的 Leaf。重點節錄：\n UUID： 長度太長，而且無序，一般 RDMBS index 都是 B+ tree，不適合無序資料（所以 laravel 做了一個 timestamp-first ordered UUID） snowflake： 很讚很快，有序但並非 autoincrement 的 ID，不過相依機器時鐘，如果不小心 sync NTP 之類的，可能就會產生重複 ID 用資料庫生成 ID： 很 robust，但資料庫本身就會變成瓶頸，可以用 step 解決，也就是多台機器，每台發不同 step 的號碼  以下是 Leaf 兩種 ID 生成的簡單介紹：\n Leaf-segment： 和資料生成類似，不過一次發一個區段（例如 1-1000）的號碼，讓 DB 壓力小很多，而且可以在取到 10% 是先去取得下一個 segment，降低 latency Leaf-snowflake： 註冊到 ZooKeeper 來產生 worker ID，server 啟動時檢查時間是否正常，不正常就等到時鐘追上或重試，然後關掉 NTP….  ","wordCount":"1122","inLanguage":"en","datePublished":"2020-06-20T00:00:00+08:00","dateModified":"2020-06-20T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weihanglo.tw/posts/2020/www-0x16/"},"publisher":{"@type":"Organization","name":"Weihang Lo","logo":{"@type":"ImageObject","url":"https://weihanglo.tw/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://weihanglo.tw accesskey=h title="Weihang Lo (Alt + H)">Weihang Lo</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://weihanglo.tw/ title=Home>
<span>Home</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
WWW 0x16: JWT、分散式 ID 生成、k8s 安全性
</h1>
<div class=post-meta><span title="2020-06-20 00:00:00 +0800 +0800">June 20, 2020</span>&nbsp;·&nbsp;3 min
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#kubernetes-blog-11-ways-not-to-get-hackedhttpskubernetesioblog2018071811-ways-not-to-get-hacked11-run-a-service-mesh aria-label="Kubernetes Blog: 11 Ways (Not) to Get Hacked"><a href=https://kubernetes.io/blog/2018/07/18/11-ways-not-to-get-hacked/#11-run-a-service-mesh>Kubernetes Blog: 11 Ways (Not) to Get Hacked</a></a></li>
<li>
<a href=#jwt-%e6%98%af%e5%90%a6%e9%81%a9%e5%90%88-session-mechanism aria-label="JWT 是否適合 session mechanism">JWT 是否適合 session mechanism</a></li>
<li>
<a href=#leaf%e7%be%8e%e5%9b%a2%e7%82%b9%e8%af%84%e5%88%86%e5%b8%83%e5%bc%8fid%e7%94%9f%e6%88%90%e7%b3%bb%e7%bb%9fhttpstechmeituancom20170421mt-leafhtml aria-label=Leaf——美团点评分布式ID生成系统><a href=https://tech.meituan.com/2017/04/21/mt-leaf.html>Leaf——美团点评分布式ID生成系统</a></a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>這裡是 WWW 第貳拾貳期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p>
<h2 id=kubernetes-blog-11-ways-not-to-get-hackedhttpskubernetesioblog2018071811-ways-not-to-get-hacked11-run-a-service-mesh><a href=https://kubernetes.io/blog/2018/07/18/11-ways-not-to-get-hacked/#11-run-a-service-mesh>Kubernetes Blog: 11 Ways (Not) to Get Hacked</a><a hidden class=anchor aria-hidden=true href=#kubernetes-blog-11-ways-not-to-get-hackedhttpskubernetesioblog2018071811-ways-not-to-get-hacked11-run-a-service-mesh>#</a></h2>
<p>管理 Kubernetes 就和管理 VM 一樣，一定會遇到各種安全性問題，這篇文章提出 11 種可以增加安全性的小撇步，順便分享 <a href=https://www.hwchiu.com/k8s-security-11tips-i.html>@hwchiu</a> 整理的中文版，資訊更多更完整，感恩惜福。</p>
<h2 id=jwt-是否適合-session-mechanism>JWT 是否適合 session mechanism<a hidden class=anchor aria-hidden=true href=#jwt-是否適合-session-mechanism>#</a></h2>
<p>最近翻到 <a href=https://hasura.io/blog/best-practices-of-using-jwt-with-graphql/>The Ultimate Guide to handling JWTs on frontend clients</a> 這篇小巧精緻的 JWT 身分驗證教學，流程圖簡明易懂，內容包括：</p>
<ul>
<li>JWT 的結構：<code>header.payload.signature</code></li>
<li>JWT 會儲存在 client-side，不適合儲存敏感資料</li>
<li>JWT 不適合放在 browser storage，容易被 XSS（所以推薦 in-memory）</li>
<li>由於 JWT 本身無狀態，誰幹走都能奪權，請保持 JWT 過期時間不會太長，文中案例是 15 分鐘</li>
<li>鑑於過期比較快，請配合 <code>HttpOnly</code> 的 cookie 的 refresh token 來更新 JWT（但 XSS 還是有點不安全）</li>
<li>Revoke all login sessions 可以簡單透過 refresh token 達成：刪除該使用者的所有 refresh token 就行</li>
<li>Server-side rendering 和 JWT + refresh token 如何整合：JWT 會存在 SSR server 上，refresh token 則是每個 page request 都會產生新的 token</li>
</ul>
<p>有趣的是，留言提出許多 JWT 與這篇文章的實作總總問題，像是：</p>
<ul>
<li>JWT 不適合用在 session 上</li>
<li>文章 refresh token 還是會被 XSS</li>
<li>多個 tab 同時發送 refresh token API 要如何處理</li>
<li>IETF RFC 建議 refresh token 每次 refresh 都要產生新的</li>
</ul>
<p>句句都在逼宮作者，但作者完全沒有出來說明，於是我只能好好點擊進入留言中的文章分享。不看也罷，一看便驚天地泣鬼神。</p>
<p>這篇 <a href=http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/>Stop using JWT for sessions</a> 的標題就破題了（好像很正常），主要是在戳破那些 JWT 沒有告訴你的事，主要是：</p>
<ul>
<li>JWT 開啟 session 透過 JavaScript 控制的大門，相較於 <code>HttpOnly</code> cookie 更不安全更容 XSS</li>
<li>無法主動過期，如果 token 權限設定錯誤或是伺服器受攻擊，很難第一時間解決問題</li>
<li>還是需要 cookie consent，functional purpose 像登入使用產品服務，本來就不需要 cookie consent，追蹤行為才需要使用者同意。</li>
</ul>
<p>看來 JWT vs. cookie 大戰還會持續下去。</p>
<h2 id=leaf美团点评分布式id生成系统httpstechmeituancom20170421mt-leafhtml><a href=https://tech.meituan.com/2017/04/21/mt-leaf.html>Leaf——美团点评分布式ID生成系统</a><a hidden class=anchor aria-hidden=true href=#leaf美团点评分布式id生成系统httpstechmeituancom20170421mt-leafhtml>#</a></h2>
<p>本篇文章把分散式 ID 生成常見的解法和需求點出來，最後歸納出適合美團使用的 <a href=https://github.com/Meituan-Dianping/Leaf>Leaf</a>。重點節錄：</p>
<ul>
<li><strong>UUID：</strong> 長度太長，而且無序，一般 RDMBS index 都是 B+ tree，不適合無序資料（所以 laravel 做了一個 <a href=https://itnext.io/laravel-the-mysterious-ordered-uuid-29e7500b4f8>timestamp-first ordered UUID</a>）</li>
<li><strong>snowflake：</strong> 很讚很快，有序但並非 <code>autoincrement</code> 的 ID，不過相依機器時鐘，如果不小心 sync NTP 之類的，可能就會產生重複 ID</li>
<li><strong>用資料庫生成 ID：</strong> 很 robust，但資料庫本身就會變成瓶頸，可以用 step 解決，也就是多台機器，每台發不同 step 的號碼</li>
</ul>
<p>以下是 Leaf 兩種 ID 生成的簡單介紹：</p>
<ul>
<li><strong>Leaf-segment：</strong> 和資料生成類似，不過一次發一個區段（例如 1-1000）的號碼，讓 DB 壓力小很多，而且可以在取到 10% 是先去取得下一個 segment，降低 latency</li>
<li><strong>Leaf-snowflake：</strong> 註冊到 ZooKeeper 來產生 worker ID，server 啟動時檢查時間是否正常，不正常就等到時鐘追上或重試，然後關掉 NTP&mldr;.</li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://weihanglo.tw/tags/devops/>DevOps</a></li>
<li><a href=https://weihanglo.tw/tags/distributed-systems/>Distributed Systems</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://weihanglo.tw/posts/2020/www-0x17/>
<span class=title>« Prev Page</span>
<br>
<span>WWW 0x17: 再見 weekly</span>
</a>
<a class=next href=https://weihanglo.tw/posts/2020/www-0x15/>
<span class=title>Next Page »</span>
<br>
<span>WWW 0x15: 你懂資料庫嗎</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>CC BY-NC-SA 4.0</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>