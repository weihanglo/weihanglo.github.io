<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular?
— @dabit3 2020.4.19
 這裡是 WWW 第十四期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Apple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care 標題很聳動但無誤，Apple 決定幫 Safari 給所有 storage 加上一個**「七天沒進站就刪掉」**的限制，不負責任猜測是 app 營收不好。
Copyrighting all the melodies to avoid accidental infringement  All the Music LLC 是一間懷抱夢想的公司，他們將旋律視為有限的數學排列組合，而數學是既有事實，所以沒有著作權，然後再利用程式組合不同音高的音符，每秒產生三十萬不同旋律的 midi，放在 public domain，進而保障音樂創作者不會被來路不明的著作權蟑螂吿到死。"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="WWW 0x0E: 親愛的，我把快取都放你腦中了 • Weihang Lo"><meta property="og:description" content="If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular?
— @dabit3 2020.4.19
 這裡是 WWW 第十四期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Apple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care 標題很聳動但無誤，Apple 決定幫 Safari 給所有 storage 加上一個**「七天沒進站就刪掉」**的限制，不負責任猜測是 app 營收不好。
Copyrighting all the melodies to avoid accidental infringement  All the Music LLC 是一間懷抱夢想的公司，他們將旋律視為有限的數學排列組合，而數學是既有事實，所以沒有著作權，然後再利用程式組合不同音高的音符，每秒產生三十萬不同旋律的 midi，放在 public domain，進而保障音樂創作者不會被來路不明的著作權蟑螂吿到死。"><meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x0e/"><meta property="og:site_name" content="Weihang Lo"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Cache"><meta property="article:tag" content="Databases"><meta property="article:published_time" content="2020-04-25T00:00:00+08:00"><meta property="article:modified_time" content="2020-04-25T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.62.2"><title>WWW 0x0E: 親愛的，我把快取都放你腦中了 • Weihang Lo</title><link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x0e/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.6a060eb7.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-posts"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/posts/>Posts</a></li><li class=item><a href=/tags/>Tags</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Weihang Lo</p><p class="desc site-desc"></p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>WWW 0x0E: 親愛的，我把快取都放你腦中了</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-04-25T00:00:00+08:00>2020, Apr 25</time></span>
<span class=reading-time><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>2 mins read</span></div></div></header><div class="container entry-content"><blockquote><p>If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular?</p><p>— <a href="https://twitter.com/dabit3/status/1251597948472999936?s=20">@dabit3</a> 2020.4.19</p></blockquote><p>這裡是 WWW 第十四期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p><h2 id=apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-carehttpsaral20200325apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care><a href=https://ar.al/2020/03/25/apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care/>Apple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care</a></h2><p>標題很聳動但無誤，Apple 決定幫 Safari 給所有 storage 加上一個**「七天沒進站就刪掉」**的限制，不負責任猜測是 app 營收不好。</p><h2 id=copyrighting-all-the-melodies-to-avoid-accidental-infringement-httpsyoutubesjtm0moogiu><a href=https://youtu.be/sJtm0MoOgiU>Copyrighting all the melodies to avoid accidental infringement</a></h2><p><a href=http://allthemusic.info>All the Music LLC</a> 是一間懷抱夢想的公司，他們將旋律視為有限的數學排列組合，而數學是既有事實，所以沒有著作權，然後再利用程式組合不同音高的音符，每秒產生三十萬不同旋律的 midi，放在 public domain，進而保障音樂創作者不會被來路不明的著作權蟑螂吿到死。</p><p>該專案認為，音樂是由旋律、節奏、合聲，音色的要素組合，但在節奏差距不大的情況下，聽起來會像同一個旋律，加上美國著作權有「<a href=https://en.wikipedia.org/wiki/Substantial_similarity#Substantial_similarity_in_copyright_infringement>實質相似性</a>」的概念，所以目前窮舉 8 個音高 x 12 個音符組合的旋律即可涵蓋大部分的旋律（之後又加上更多小調，以涵蓋更多種類的音樂）。</p><p>這個專案我覺得非常有趣，而且是<a href=https://github.com/allthemusicllc>用 Rust 寫的</a>！不過其實世界上音樂不是只有西方古典音樂的五線譜，印度、中國、日本還有大大小小的部落民族都有各種超越五線譜的音樂，這些著作權要怎麼保障？又要怎樣讓創作者盡情發揮？仍然有難度存在。</p><blockquote><p>更多細節可以看專案的 <a href=http://allthemusic.info/faqs/>FAQ</a>，雖然載入超慢&mldr;</p></blockquote><h2 id=why-we-started-putting-unpopular-assets-in-memoryhttpsblogcloudflarecomwhy-we-started-putting-unpopular-assets-in-memory><a href=https://blog.cloudflare.com/why-we-started-putting-unpopular-assets-in-memory/>Why We Started Putting Unpopular Assets in Memory</a></h2><p><img src=https://blog-cloudflare-com-assets.storage.googleapis.com/2020/03/pasted-image-0--4--1.png alt></p><blockquote><p>Image from Cloudflare blog</p></blockquote><p>乍聽之下，標題聳動駭人，依然推薦閱讀此文。抽絲剝繭，層層理出技術決策如何從觀察、實驗、可能問題、現實部署情況，到未來展望的脈絡，值得技術撰文者參考。稍加摘要（根本稱不上是摘要）：</p><h3 id=背景>背景</h3><p>Cloudflare 的 Cache 放在 SSD，<a href=https://blog.cloudflare.com/cloudflares-gen-x-servers-for-an-accelerated-future/>客製化的超強 SSD</a>，但仍遭遇一些問題：</p><ul><li><strong>問題一：</strong> SSD 的 IO 是造成 tail latency 的主因</li><li><strong>問題二：</strong> 物理 SSD 壞掉替換的維運成本很高（Cloudflare 在兩百座城市的資料中心的運費、人力替換成本）</li></ul><h3 id=觀察現況>觀察現況</h3><p>熱點資源已有作業系統 page cache 將之放在 memory：</p><ul><li>Linux LRU 等各種演算法早就針對熱點做讀取快取</li><li>page cache 也會做寫入緩衝（buffer write） 但 Cloudflare 作為 CDN 服務，更新資源次數極少，page cache 沒辦法幫助減少硬碟寫入</li></ul><p>非熱點資源似乎可以放進 memory：</p><ul><li><strong>動機一：</strong> 寫入過多<a href=https://www.usenix.org/conference/fast12/reducing-ssd-read-latency-nand-flash-program-and-erase-suspension>導致 SSD 壽命驟減</a>，寫入需要對 storage 晶片送 P/E operation ，這個 operation 會阻擋 read ops</li><li><strong>動機二：</strong> 很多資源都是一次性再也不會存取第二次<ul><li><strong>假說：</strong> 減少硬碟寫入可加速硬碟讀取</li><li><strong>方法：</strong> 只 cache 第二次存取的資源</li><li><strong>結果：</strong> 減少硬碟寫入次數，P75 cache hit duration 也降低，因為不需要 evict 非熱點資源、cache hit ratio 和 retention 也提高了</li></ul></li></ul><h3 id=如何實作>如何實作</h3><p><strong>解法一：</strong> 紀錄存取次數，但不要快取</p><ul><li>用 <a href=https://en.wikipedia.org/wiki/Bloom_filter>bloom filter</a> 等 memory-efficient 資料結構來儲存存取次數</li><li>新問題：資源都會 miss 第二次才會被 cache，這對 CDN 供應商或客戶來說都無法接受。</li></ul><p><strong>解法二：</strong> 多一個 transient cache (in memory cache)。</p><ul><li>先將欲快取到 SSD 的資源放在 memory 中，如果存取它太多次，就 promote 到 SSD 中</li><li>沒被 promote 的資源最後會被 evict</li></ul><h2 id=權衡>權衡</h2><p>這聽起來很合理，全部放到 memory 中，但其實需要在 SSD 壽命、cache tail hit latency 和 memory 使用量之間權衡，而這次影響最大的就是 memory 使用量上升：</p><ul><li><strong>transient cache memory 究竟要多大：</strong> 影響 eviction、cache hit ratio</li><li><strong>和 page cache 競爭：</strong> page cache 抓熱門資源、但 transient cache 大多為非熱門，有排擠效應</li><li><strong>和 process memory 競爭：</strong> process 和 page cache 不一樣，對 memory 有剛性需求，而且 edge service 的升級需要 zero downtime，所以會同時有兩個版本的服務（<a href=https://tech.hahow.in/%E6%B7%BA%E8%AB%87-hahow-%E8%97%8D%E7%B6%A0%E9%83%A8%E7%BD%B2-1c99d42336a9>藍綠佈署 🙃</a>），如果記憶體不夠，就會讓 page cache 減少，反而增加 IO。</li></ul><p>有段話透露出 Cloudflare 對於客戶太在乎 miss rate 的抱怨，認為只是在博取「眼球效能」😈</p><blockquote><p>From a customer's perspective, cache retention being too short is unacceptable because it leads to more misses, commensurate higher cost, and <strong><em>worse eyeball performance</em></strong>.</p></blockquote><h2 id=結果與展望>結果與展望</h2><p>Cloudlfare 採取在新的機器上部署新的 transient cache，並只在部分 asset 使用，不斷尋找 memory size 的甜蜜點，最後結果為</p><ul><li>在 SSD 壽命、cache tail hit latency 和 memory 使用量三者間，Cloudflare 選擇前兩者</li><li>減少 20%-25% SSD 寫入</li><li>CDN tail latency 在高峰期間也減少了 20%</li></ul><p>而對未來可以做更好的部分則是：</p><ul><li><strong>部署更多：</strong> 舊機器退役後，新世代機器（更多 memory 的機器）就會上去</li><li><strong>更智慧的 promotion 演算法：</strong> 現在僅透過資源觸擊數，未來可依據資源的 TTL 決定是否 promote；另一面向則是 demotion，雖然不會減少硬碟寫入，但可增加 cache hit ratio 和 cache retention</li><li><strong>用其他儲存裝置做 transient cache：</strong> 選擇 memory 是因為損耗花費低，HDD 同樣耐操，可以考慮混合 SSD、HDD、memory 在費用和效能取得平衡</li></ul></div><footer class=entry-footer><div class="container sep-before"><div class=tags><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/cache/>Cache</a>, <a class=tag href=/tags/databases/>Databases</a></div></div><div style=text-align:center;padding-top:2em><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/><img src=https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png alt=cc-by-nc-sa-4></a></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/posts/2020/www-0x0d/><span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>WWW 0x0D: 已達上限</a></div><div class="next-entry sep-before"><a href=/posts/2020/www-0x0f/><span class=screen-reader-text>Next post: </span>WWW 0x0F: 工程師唯一需要知道的數字是伴侶生日<span aria-hidden=true>Next<svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://facebook.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Facebook account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href=https://twitter.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=https://linkedin.com/in/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="m22.05 1.577c-.393-.016-.784.08-1.117.235-.484.186-4.92 1.902-9.41 3.64C9.263 6.325 7.005 7.198 5.267 7.867 3.53 8.537 2.222 9.035 2.153 9.059c-.46.16-1.082.362-1.61.984-.79581202 1.058365.21077405 1.964825 1.004 2.499 1.76.564 3.58 1.102 5.087 1.608.556 1.96 1.09 3.927 1.618 5.89.174.394.553.54.944.544l-.002.02s.307.03.606-.042c.3-.07.677-.244 1.02-.565.377-.354 1.4-1.36 1.98-1.928l4.37 3.226.035.02s.484.34 1.192.388c.354.024.82-.044 1.22-.337.403-.294.67-.767.795-1.307.374-1.63 2.853-13.427 3.276-15.38L23.676 4.725C23.972 3.625 23.863 2.617 23.18 2.02 22.838 1.723 22.444 1.593 22.05 1.576z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2017-2020 Weihang Lo</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.67d669ac.js></script><script src=/js/custom.js></script></body></html>