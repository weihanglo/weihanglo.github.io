<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>WWW 0x0E: 親愛的，我把快取都放你腦中了 | Weihang Lo</title>
<meta name=keywords content="Cache,Databases">
<meta name=description content="If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular? — @dabit3 2020.4.19 這裡是 WWW 第拾肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期">
<meta name=author content>
<link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x0e/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://weihanglo.tw/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://weihanglo.tw/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://weihanglo.tw/favicon-32x32.png>
<link rel=apple-touch-icon href=https://weihanglo.tw/apple-touch-icon.png>
<link rel=mask-icon href=https://weihanglo.tw/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script>
<meta property="og:title" content="WWW 0x0E: 親愛的，我把快取都放你腦中了">
<meta property="og:description" content="If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular? — @dabit3 2020.4.19 這裡是 WWW 第拾肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期">
<meta property="og:type" content="article">
<meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x0e/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-04-25T00:00:00+08:00">
<meta property="article:modified_time" content="2020-04-25T00:00:00+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="WWW 0x0E: 親愛的，我把快取都放你腦中了">
<meta name=twitter:description content="If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular? — @dabit3 2020.4.19 這裡是 WWW 第拾肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://weihanglo.tw/posts/"},{"@type":"ListItem","position":3,"name":"WWW 0x0E: 親愛的，我把快取都放你腦中了","item":"https://weihanglo.tw/posts/2020/www-0x0e/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WWW 0x0E: 親愛的，我把快取都放你腦中了","name":"WWW 0x0E: 親愛的，我把快取都放你腦中了","description":"If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular? — @dabit3 2020.4.19 這裡是 WWW 第拾肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期","keywords":["Cache","Databases"],"articleBody":" If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular?\n— @dabit3 2020.4.19\n 這裡是 WWW 第拾肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。\nApple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care 標題很聳動但無誤，Apple 決定幫 Safari 給所有 storage 加上一個**「七天沒進站就刪掉」**的限制，不負責任猜測是 app 營收不好。\nCopyrighting all the melodies to avoid accidental infringement  All the Music LLC 是一間懷抱夢想的公司，他們將旋律視為有限的數學排列組合，而數學是既有事實，所以沒有著作權，然後再利用程式組合不同音高的音符，每秒產生三十萬不同旋律的 midi，放在 public domain，進而保障音樂創作者不會被來路不明的著作權蟑螂吿到死。\n該專案認為，音樂是由旋律、節奏、合聲，音色的要素組合，但在節奏差距不大的情況下，聽起來會像同一個旋律，加上美國著作權有「實質相似性」的概念，所以目前窮舉 8 個音高 x 12 個音符組合的旋律即可涵蓋大部分的旋律（之後又加上更多小調，以涵蓋更多種類的音樂）。\n這個專案我覺得非常有趣，而且是用 Rust 寫的！不過其實世界上音樂不是只有西方古典音樂的五線譜，印度、中國、日本還有大大小小的部落民族都有各種超越五線譜的音樂，這些著作權要怎麼保障？又要怎樣讓創作者盡情發揮？仍然有難度存在。\n 更多細節可以看專案的 FAQ，雖然載入超慢…\n Why We Started Putting Unpopular Assets in Memory  Image from Cloudflare blog\n 乍聽之下，標題聳動駭人，依然推薦閱讀此文。抽絲剝繭，層層理出技術決策如何從觀察、實驗、可能問題、現實部署情況，到未來展望的脈絡，值得技術撰文者參考。稍加摘要（根本稱不上是摘要）：\n背景 Cloudflare 的 Cache 放在 SSD，客製化的超強 SSD，但仍遭遇一些問題：\n 問題一： SSD 的 IO 是造成 tail latency 的主因 問題二： 物理 SSD 壞掉替換的維運成本很高（Cloudflare 在兩百座城市的資料中心的運費、人力替換成本）  觀察現況 熱點資源已有作業系統 page cache 將之放在 memory：\n Linux LRU 等各種演算法早就針對熱點做讀取快取 page cache 也會做寫入緩衝（buffer write） 但 Cloudflare 作為 CDN 服務，更新資源次數極少，page cache 沒辦法幫助減少硬碟寫入  非熱點資源似乎可以放進 memory：\n 動機一： 寫入過多導致 SSD 壽命驟減，寫入需要對 storage 晶片送 P/E operation ，這個 operation 會阻擋 read ops 動機二： 很多資源都是一次性再也不會存取第二次  假說： 減少硬碟寫入可加速硬碟讀取 方法： 只 cache 第二次存取的資源 結果： 減少硬碟寫入次數，P75 cache hit duration 也降低，因為不需要 evict 非熱點資源、cache hit ratio 和 retention 也提高了    如何實作 解法一： 紀錄存取次數，但不要快取\n 用 bloom filter 等 memory-efficient 資料結構來儲存存取次數 新問題：資源都會 miss 第二次才會被 cache，這對 CDN 供應商或客戶來說都無法接受。  解法二： 多一個 transient cache (in memory cache)。\n 先將欲快取到 SSD 的資源放在 memory 中，如果存取它太多次，就 promote 到 SSD 中 沒被 promote 的資源最後會被 evict  權衡 這聽起來很合理，全部放到 memory 中，但其實需要在 SSD 壽命、cache tail hit latency 和 memory 使用量之間權衡，而這次影響最大的就是 memory 使用量上升：\n transient cache memory 究竟要多大： 影響 eviction、cache hit ratio 和 page cache 競爭： page cache 抓熱門資源、但 transient cache 大多為非熱門，有排擠效應 和 process memory 競爭： process 和 page cache 不一樣，對 memory 有剛性需求，而且 edge service 的升級需要 zero downtime，所以會同時有兩個版本的服務（藍綠佈署 🙃），如果記憶體不夠，就會讓 page cache 減少，反而增加 IO。  有段話透露出 Cloudflare 對於客戶太在乎 miss rate 的抱怨，認為只是在博取「眼球效能」😈\n From a customer’s perspective, cache retention being too short is unacceptable because it leads to more misses, commensurate higher cost, and worse eyeball performance.\n 結果與展望 Cloudlfare 採取在新的機器上部署新的 transient cache，並只在部分 asset 使用，不斷尋找 memory size 的甜蜜點，最後結果為\n 在 SSD 壽命、cache tail hit latency 和 memory 使用量三者間，Cloudflare 選擇前兩者 減少 20%-25% SSD 寫入 CDN tail latency 在高峰期間也減少了 20%  而對未來可以做更好的部分則是：\n 部署更多： 舊機器退役後，新世代機器（更多 memory 的機器）就會上去 更智慧的 promotion 演算法： 現在僅透過資源觸擊數，未來可依據資源的 TTL 決定是否 promote；另一面向則是 demotion，雖然不會減少硬碟寫入，但可增加 cache hit ratio 和 cache retention 用其他儲存裝置做 transient cache： 選擇 memory 是因為損耗花費低，HDD 同樣耐操，可以考慮混合 SSD、HDD、memory 在費用和效能取得平衡  ","wordCount":"1700","inLanguage":"en","datePublished":"2020-04-25T00:00:00+08:00","dateModified":"2020-04-25T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weihanglo.tw/posts/2020/www-0x0e/"},"publisher":{"@type":"Organization","name":"Weihang Lo","logo":{"@type":"ImageObject","url":"https://weihanglo.tw/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://weihanglo.tw accesskey=h title="Weihang Lo (Alt + H)">Weihang Lo</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://weihanglo.tw/ title=Home>
<span>Home</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
WWW 0x0E: 親愛的，我把快取都放你腦中了
</h1>
<div class=post-meta><span title="2020-04-25 00:00:00 +0800 +0800">April 25, 2020</span>&nbsp;·&nbsp;4 min
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-carehttpsaral20200325apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care aria-label="Apple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care"><a href=https://ar.al/2020/03/25/apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care/>Apple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care</a></a></li>
<li>
<a href=#copyrighting-all-the-melodies-to-avoid-accidental-infringement-httpsyoutubesjtm0moogiu aria-label="Copyrighting all the melodies to avoid accidental infringement "><a href=https://youtu.be/sJtm0MoOgiU>Copyrighting all the melodies to avoid accidental infringement </a></a></li>
<li>
<a href=#why-we-started-putting-unpopular-assets-in-memoryhttpsblogcloudflarecomwhy-we-started-putting-unpopular-assets-in-memory aria-label="Why We Started Putting Unpopular Assets in Memory"><a href=https://blog.cloudflare.com/why-we-started-putting-unpopular-assets-in-memory/>Why We Started Putting Unpopular Assets in Memory</a></a><ul>
<li>
<a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li>
<li>
<a href=#%e8%a7%80%e5%af%9f%e7%8f%be%e6%b3%81 aria-label=觀察現況>觀察現況</a></li>
<li>
<a href=#%e5%a6%82%e4%bd%95%e5%af%a6%e4%bd%9c aria-label=如何實作>如何實作</a></li></ul>
</li>
<li>
<a href=#%e6%ac%8a%e8%a1%a1 aria-label=權衡>權衡</a></li>
<li>
<a href=#%e7%b5%90%e6%9e%9c%e8%88%87%e5%b1%95%e6%9c%9b aria-label=結果與展望>結果與展望</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><blockquote>
<p>If you cloud end Covid-19 by sacrificing a JavaScript framework, which one would you choose and why Angular?</p>
<p>— <a href="https://twitter.com/dabit3/status/1251597948472999936?s=20">@dabit3</a> 2020.4.19</p>
</blockquote>
<p>這裡是 WWW 第拾肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p>
<h2 id=apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-carehttpsaral20200325apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care><a href=https://ar.al/2020/03/25/apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care/>Apple just killed Offline Web Apps while purporting to protect your privacy: why that’s A Bad Thing and why you should care</a><a hidden class=anchor aria-hidden=true href=#apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-carehttpsaral20200325apple-just-killed-offline-web-apps-while-purporting-to-protect-your-privacy-why-thats-a-bad-thing-and-why-you-should-care>#</a></h2>
<p>標題很聳動但無誤，Apple 決定幫 Safari 給所有 storage 加上一個**「七天沒進站就刪掉」**的限制，不負責任猜測是 app 營收不好。</p>
<h2 id=copyrighting-all-the-melodies-to-avoid-accidental-infringement-httpsyoutubesjtm0moogiu><a href=https://youtu.be/sJtm0MoOgiU>Copyrighting all the melodies to avoid accidental infringement </a><a hidden class=anchor aria-hidden=true href=#copyrighting-all-the-melodies-to-avoid-accidental-infringement-httpsyoutubesjtm0moogiu>#</a></h2>
<p><a href=http://allthemusic.info>All the Music LLC</a> 是一間懷抱夢想的公司，他們將旋律視為有限的數學排列組合，而數學是既有事實，所以沒有著作權，然後再利用程式組合不同音高的音符，每秒產生三十萬不同旋律的 midi，放在 public domain，進而保障音樂創作者不會被來路不明的著作權蟑螂吿到死。</p>
<p>該專案認為，音樂是由旋律、節奏、合聲，音色的要素組合，但在節奏差距不大的情況下，聽起來會像同一個旋律，加上美國著作權有「<a href=https://en.wikipedia.org/wiki/Substantial_similarity#Substantial_similarity_in_copyright_infringement>實質相似性</a>」的概念，所以目前窮舉 8 個音高 x 12 個音符組合的旋律即可涵蓋大部分的旋律（之後又加上更多小調，以涵蓋更多種類的音樂）。</p>
<p>這個專案我覺得非常有趣，而且是<a href=https://github.com/allthemusicllc>用 Rust 寫的</a>！不過其實世界上音樂不是只有西方古典音樂的五線譜，印度、中國、日本還有大大小小的部落民族都有各種超越五線譜的音樂，這些著作權要怎麼保障？又要怎樣讓創作者盡情發揮？仍然有難度存在。</p>
<blockquote>
<p>更多細節可以看專案的 <a href=http://allthemusic.info/faqs/>FAQ</a>，雖然載入超慢&mldr;</p>
</blockquote>
<h2 id=why-we-started-putting-unpopular-assets-in-memoryhttpsblogcloudflarecomwhy-we-started-putting-unpopular-assets-in-memory><a href=https://blog.cloudflare.com/why-we-started-putting-unpopular-assets-in-memory/>Why We Started Putting Unpopular Assets in Memory</a><a hidden class=anchor aria-hidden=true href=#why-we-started-putting-unpopular-assets-in-memoryhttpsblogcloudflarecomwhy-we-started-putting-unpopular-assets-in-memory>#</a></h2>
<p><img loading=lazy src=https://blog-cloudflare-com-assets.storage.googleapis.com/2020/03/pasted-image-0--4--1.png alt>
</p>
<blockquote>
<p>Image from Cloudflare blog</p>
</blockquote>
<p>乍聽之下，標題聳動駭人，依然推薦閱讀此文。抽絲剝繭，層層理出技術決策如何從觀察、實驗、可能問題、現實部署情況，到未來展望的脈絡，值得技術撰文者參考。稍加摘要（根本稱不上是摘要）：</p>
<h3 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h3>
<p>Cloudflare 的 Cache 放在 SSD，<a href=https://blog.cloudflare.com/cloudflares-gen-x-servers-for-an-accelerated-future/>客製化的超強 SSD</a>，但仍遭遇一些問題：</p>
<ul>
<li><strong>問題一：</strong> SSD 的 IO 是造成 tail latency 的主因</li>
<li><strong>問題二：</strong> 物理 SSD 壞掉替換的維運成本很高（Cloudflare 在兩百座城市的資料中心的運費、人力替換成本）</li>
</ul>
<h3 id=觀察現況>觀察現況<a hidden class=anchor aria-hidden=true href=#觀察現況>#</a></h3>
<p>熱點資源已有作業系統 page cache 將之放在 memory：</p>
<ul>
<li>Linux LRU 等各種演算法早就針對熱點做讀取快取</li>
<li>page cache 也會做寫入緩衝（buffer write） 但 Cloudflare 作為 CDN 服務，更新資源次數極少，page cache 沒辦法幫助減少硬碟寫入</li>
</ul>
<p>非熱點資源似乎可以放進 memory：</p>
<ul>
<li><strong>動機一：</strong> 寫入過多<a href=https://www.usenix.org/conference/fast12/reducing-ssd-read-latency-nand-flash-program-and-erase-suspension>導致 SSD 壽命驟減</a>，寫入需要對 storage 晶片送 P/E operation ，這個 operation 會阻擋 read ops</li>
<li><strong>動機二：</strong> 很多資源都是一次性再也不會存取第二次
<ul>
<li><strong>假說：</strong> 減少硬碟寫入可加速硬碟讀取</li>
<li><strong>方法：</strong> 只 cache 第二次存取的資源</li>
<li><strong>結果：</strong> 減少硬碟寫入次數，P75 cache hit duration 也降低，因為不需要 evict 非熱點資源、cache hit ratio 和 retention 也提高了</li>
</ul>
</li>
</ul>
<h3 id=如何實作>如何實作<a hidden class=anchor aria-hidden=true href=#如何實作>#</a></h3>
<p><strong>解法一：</strong> 紀錄存取次數，但不要快取</p>
<ul>
<li>用 <a href=https://en.wikipedia.org/wiki/Bloom_filter>bloom filter</a> 等 memory-efficient 資料結構來儲存存取次數</li>
<li>新問題：資源都會 miss 第二次才會被 cache，這對 CDN 供應商或客戶來說都無法接受。</li>
</ul>
<p><strong>解法二：</strong> 多一個 transient cache (in memory cache)。</p>
<ul>
<li>先將欲快取到 SSD 的資源放在 memory 中，如果存取它太多次，就 promote 到 SSD 中</li>
<li>沒被 promote 的資源最後會被 evict</li>
</ul>
<h2 id=權衡>權衡<a hidden class=anchor aria-hidden=true href=#權衡>#</a></h2>
<p>這聽起來很合理，全部放到 memory 中，但其實需要在 SSD 壽命、cache tail hit latency 和 memory 使用量之間權衡，而這次影響最大的就是 memory 使用量上升：</p>
<ul>
<li><strong>transient cache memory 究竟要多大：</strong> 影響 eviction、cache hit ratio</li>
<li><strong>和 page cache 競爭：</strong> page cache 抓熱門資源、但 transient cache 大多為非熱門，有排擠效應</li>
<li><strong>和 process memory 競爭：</strong> process 和 page cache 不一樣，對 memory 有剛性需求，而且 edge service 的升級需要 zero downtime，所以會同時有兩個版本的服務（<a href=https://tech.hahow.in/%E6%B7%BA%E8%AB%87-hahow-%E8%97%8D%E7%B6%A0%E9%83%A8%E7%BD%B2-1c99d42336a9>藍綠佈署 🙃</a>），如果記憶體不夠，就會讓 page cache 減少，反而增加 IO。</li>
</ul>
<p>有段話透露出 Cloudflare 對於客戶太在乎 miss rate 的抱怨，認為只是在博取「眼球效能」😈</p>
<blockquote>
<p>From a customer&rsquo;s perspective, cache retention being too short is unacceptable because it leads to more misses, commensurate higher cost, and <strong><em>worse eyeball performance</em></strong>.</p>
</blockquote>
<h2 id=結果與展望>結果與展望<a hidden class=anchor aria-hidden=true href=#結果與展望>#</a></h2>
<p>Cloudlfare 採取在新的機器上部署新的 transient cache，並只在部分 asset 使用，不斷尋找 memory size 的甜蜜點，最後結果為</p>
<ul>
<li>在 SSD 壽命、cache tail hit latency 和 memory 使用量三者間，Cloudflare 選擇前兩者</li>
<li>減少 20%-25% SSD 寫入</li>
<li>CDN tail latency 在高峰期間也減少了 20%</li>
</ul>
<p>而對未來可以做更好的部分則是：</p>
<ul>
<li><strong>部署更多：</strong> 舊機器退役後，新世代機器（更多 memory 的機器）就會上去</li>
<li><strong>更智慧的 promotion 演算法：</strong> 現在僅透過資源觸擊數，未來可依據資源的 TTL 決定是否 promote；另一面向則是 demotion，雖然不會減少硬碟寫入，但可增加 cache hit ratio 和 cache retention</li>
<li><strong>用其他儲存裝置做 transient cache：</strong> 選擇 memory 是因為損耗花費低，HDD 同樣耐操，可以考慮混合 SSD、HDD、memory 在費用和效能取得平衡</li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://weihanglo.tw/tags/cache/>Cache</a></li>
<li><a href=https://weihanglo.tw/tags/databases/>Databases</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://weihanglo.tw/posts/2020/www-0x0f/>
<span class=title>« Prev Page</span>
<br>
<span>WWW 0x0F: 工程師唯一需要知道的數字是伴侶生日</span>
</a>
<a class=next href=https://weihanglo.tw/posts/2020/www-0x0d/>
<span class=title>Next Page »</span>
<br>
<span>WWW 0x0D: 已達上限</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>CC BY-NC-SA 4.0</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>