<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="這裡是 WWW 第拾陸期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Graceful shutdown in Kubernetes is not always trivial 對不起，分享一篇 medium 付費牆的文章。重點節錄：
 讓你的 app delay 一些時間再停止接收 connection 如果你沒辦法控制 app（code 不是你寫的），可加 preStop hook 來控制 如果加了沒用，請去看該 app 如何處理各種 Signal 請測試，請分析，不要盲目寫完就當作自己做好 graceful shutdown  三篇文章了解 TiDB 技术内幕 - 说计算 由於開源資料庫系統 TiDB 為中國人研發，中文撰寫的文件非常多，這篇主要介紹 SQL 的 relation model 如何映射到 Key-Value model，處理 index 和 unique index 也不相同。很有趣，值得一讀（TiDB/TiKV 的 source code 也是 😂）。
Rewriting the heart of our sync engine Dropbox 重寫整個電腦版的同步引擎 Nucleus，花了四年時間，節錄些（其實不是節錄）有趣發現："><meta name=theme-color content="#ffcd00"><meta property="og:title" content="WWW 0x10: 重構不是病，寫起來要人命 • Weihang Lo"><meta property="og:description" content="這裡是 WWW 第拾陸期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Graceful shutdown in Kubernetes is not always trivial 對不起，分享一篇 medium 付費牆的文章。重點節錄：
 讓你的 app delay 一些時間再停止接收 connection 如果你沒辦法控制 app（code 不是你寫的），可加 preStop hook 來控制 如果加了沒用，請去看該 app 如何處理各種 Signal 請測試，請分析，不要盲目寫完就當作自己做好 graceful shutdown  三篇文章了解 TiDB 技术内幕 - 说计算 由於開源資料庫系統 TiDB 為中國人研發，中文撰寫的文件非常多，這篇主要介紹 SQL 的 relation model 如何映射到 Key-Value model，處理 index 和 unique index 也不相同。很有趣，值得一讀（TiDB/TiKV 的 source code 也是 😂）。
Rewriting the heart of our sync engine Dropbox 重寫整個電腦版的同步引擎 Nucleus，花了四年時間，節錄些（其實不是節錄）有趣發現："><meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x10/"><meta property="og:site_name" content="Weihang Lo"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Rust"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Databases"><meta property="article:published_time" content="2020-05-09T00:00:00+08:00"><meta property="article:modified_time" content="2020-05-09T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>WWW 0x10: 重構不是病，寫起來要人命 • Weihang Lo</title><link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x10/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-posts"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/posts/>Posts</a></li><li class=item><a href=/tags/>Tags</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Weihang Lo</p><p class="desc site-desc"></p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>WWW 0x10: 重構不是病，寫起來要人命</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-05-09T00:00:00+08:00>2020, May 09</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>2 mins read</span></div></div></header><div class="container entry-content"><p>這裡是 WWW 第拾陸期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p><h2 id=graceful-shutdown-in-kubernetes-is-not-always-trivialhttpsmediumcomflant-comkubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2><a href=https://medium.com/flant-com/kubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2>Graceful shutdown in Kubernetes is not always trivial</a></h2><p>對不起，分享一篇 medium 付費牆的文章。重點節錄：</p><ul><li>讓你的 app delay 一些時間再停止接收 connection</li><li>如果你沒辦法控制 app（code 不是你寫的），可加 <code>preStop</code> hook 來控制</li><li>如果加了沒用，請去看該 app 如何處理各種 Signal</li><li>請測試，請分析，不要盲目寫完就當作自己做好 graceful shutdown</li></ul><h2 id=三篇文章了解-tidb-技术内幕---说计算httpspingcapcomblog-cntidb-internal-2><a href=https://pingcap.com/blog-cn/tidb-internal-2/>三篇文章了解 TiDB 技术内幕 - 说计算</a></h2><p>由於開源資料庫系統 <a href=https://pingcap.com>TiDB</a> 為中國人研發，中文撰寫的文件非常多，這篇主要介紹 SQL 的 relation model 如何映射到 Key-Value model，處理 index 和 unique index 也不相同。很有趣，值得一讀（TiDB/TiKV 的 source code 也是 😂）。</p><h2 id=rewriting-the-heart-of-our-sync-enginehttpsdropboxtechinfrastructurerewriting-the-heart-of-our-sync-engine><a href=https://dropbox.tech/infrastructure/rewriting-the-heart-of-our-sync-engine>Rewriting the heart of our sync engine</a></h2><p><img src=https://dropbox.tech/cms/content/dam/dropbox/tech-blog/en-us/2020/03/01.png alt></p><p>Dropbox 重寫整個電腦版的同步引擎 <strong>Nucleus</strong>，花了四年時間，節錄些（其實不是節錄）有趣發現：</p><h3 id=-同步檔案有下列幾個困難點>🤯 同步檔案有下列幾個困難點</h3><ul><li>分散式系統：client 常常 offline、或是在不同的裝置同步，扎扎實實就是個分散式系統</li><li>耐用性：不同作業系統有不同的實作，有些時候甚至要 reverse-engineering，不過這通常會影響到很小部分人</li><li>測試檔案同步：各種連線狀況、本地讀取、寫檔到硬碟、不同的 snapshot、上傳、chunk transfer</li><li>同步行為：不同 client 任意移動資料夾，造成資料夾間 circular cycle</li></ul><h3 id=-為什麼要重寫>✏️ 為什麼要重寫</h3><p>雖然原始的同步服務很成功，團隊也不斷重構最佳化，但程式碼並不健康，最大幾個問題是：</p><ul><li><strong>Consistency：</strong> data model 沒有考慮共享性，consistency guarantees 不強</li><li><strong>Testability：</strong> 系統可測試性不夠強，反而依靠 slow rollout 然後開始 debugging</li><li><strong>Concurrency：</strong> 最後當然是 concurrent 問題，不好測，不好重現，只好用粗粒度的鎖，犧牲一些效能</li></ul><h3 id=-系統重寫核對清單>📝 系統重寫核對清單</h3><p>整篇文章<del>只有</del>這部分最有趣，因為 Dropbox 團隊知道<a href=https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/>重寫其實容易是不明智的決策</a>，但團隊還是很清楚列出決定重寫的關鍵（說不定是事後諸葛）。</p><ol><li>是否窮盡所有漸進改善方案<ol><li>有試過重構現有模組嗎</li><li>有針對熱點分析改善嗎</li><li>可階段性發佈漸進改善的成果嗎</li></ol></li><li>是否有足夠能力重寫專案<ol><li>對現有專案完全瞭解到考古程度嗎</li><li>有足夠的工程資源嗎</li><li>可接受新功能開發步調趨緩嗎</li></ol></li><li>是否知道專案的未來方向<ol><li>重寫真的會改善嗎</li><li>新系統有制定各種原則嗎</li></ol></li></ol><p>我懶得詳述 Dropbox 對這些問題的答案，但它們其實透過 <a href=http://mypy-lang.org/>MyPy</a>（印象中 MyPy 就是 Dropbox 發揚光大）還有各種 profiling 工具不斷重構，但仍然決定重寫。其中完全跳脫我的思維的是最後一點，重寫新系統其實就是「 <strong>重新塑造工程文化</strong> 」的好時機（也是大搞辦公室政治的好時機 😈），善用這個機會，團隊肯定煥然一新。</p><blockquote><p>Starting from scratch is a great opportunity to reset technical culture for a team.</p></blockquote><h3 id=-所以-dropbox-到底做了什麼>📦 所以 Dropbox 到底做了什麼</h3><p>寫了這麼多，應該已經猜到 Dropbox 做了什麼，對，就是用 <strong>Rust</strong> 重寫他們整個 Desktop client sync engine。Rust 對 Dropbox 來說是個「force multiplier」，使用 Rust 是最好的技術決策之一，除了效能，type system 和 AOT compiling checking 才是讓團隊笑到最後的關鍵因素。</p><p>廣告快打完了，還是提一下新的 sync engine <strong>Nucleus</strong> 到底葫蘆裡賣什麼課程：</p><ul><li><strong>Threading model 簡化：</strong> 幾乎所有 code 都在 single thread（a.k.a「The Control Thread」）用了 Rust 非同步的 de facto <a href=https://github.com/rust-lang/futures-rs>futures.rs</a>，剩下 network IO 放到 event loop（未看先猜是 <a href=https://tokio.rs>tokio</a>），CPU-heavy task 有 thread pool，檔案系統 IO 也有個 dedicated thread。乾乾淨淨，清潔溜溜。</li><li><strong>Deterministic 增加 testability：</strong> The Control Thread 在輸入值和排程法確定的條件下，行為是 deterministic，解決了舊系統不容易寫測試的問題，也能簡單重現錯誤，甚至可以用個做 pseudorandom 的 input、檔案、系統狀態和錯誤。</li><li><strong>重新設計具有 strong consistency 的 client-server protocol：</strong> 共享的檔案和目錄終於有全域 ID，檔案和目錄的移動是 O(1)，和他們 subtree 的大小無關（不知道底層怎麼做到）。</li></ul><p>然後 Dropbox 正在找會寫 Rust 的 infra team member，帥。</p><blockquote><p>沒錯，Rust 早就滲透你我的生活，人遲早會鏽蝕</p></blockquote></div><footer class=entry-footer><div class="container sep-before"><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/rust/>Rust</a>, <a class=tag href=/tags/devops/>DevOps</a>, <a class=tag href=/tags/databases/>Databases</a></div></div><div style=text-align:center;padding-top:2em><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/><img src=https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png alt=cc-by-nc-sa-4></a></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/posts/2020/www-0x0f/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>WWW 0x0F: 工程師唯一需要知道的數字是伴侶生日</a></div><div class="next-entry sep-before"><a href=/posts/2020/www-0x11/><span class=screen-reader-text>Next post: </span>WWW 0x11: 庫存文章已用罄<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://facebook.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Facebook account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href=https://twitter.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=https://linkedin.com/in/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Telegram icon</title><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2017-2020 Weihang Lo</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script src=/js/custom.js></script></body></html>