<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½ | Weihang Lo</title>
<meta name=keywords content="Rust,DevOps,Databases">
<meta name=description content="é€™è£¡æ˜¯ WWW ç¬¬æ‹¾é™¸æœŸï¼ŒWow Weihang Weekly æ˜¯ä¸€å€‹æ¯«ç„¡ç« æ³•çš„å€‹äººé€±åˆŠï¼Œå‡ºåˆŠé€±æœŸæ¥µä¸å›ºå®šï¼Œå¾ä¸€é€±åˆ°äº”å¹´éƒ½æœ‰å¯èƒ½ã€‚åˆæœŸå…§å®¹ä»¥è»Ÿé«”å·¥ç¨‹ç‚ºä¸»ï¼Œç­‰è²¡å¯Œè‡ªç”±å¾Œæœƒæœ‰æ›´å¤šé›œ">
<meta name=author content>
<link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x10/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://weihanglo.tw/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://weihanglo.tw/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://weihanglo.tw/favicon-32x32.png>
<link rel=apple-touch-icon href=https://weihanglo.tw/apple-touch-icon.png>
<link rel=mask-icon href=https://weihanglo.tw/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script>
<meta property="og:title" content="WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½">
<meta property="og:description" content="é€™è£¡æ˜¯ WWW ç¬¬æ‹¾é™¸æœŸï¼ŒWow Weihang Weekly æ˜¯ä¸€å€‹æ¯«ç„¡ç« æ³•çš„å€‹äººé€±åˆŠï¼Œå‡ºåˆŠé€±æœŸæ¥µä¸å›ºå®šï¼Œå¾ä¸€é€±åˆ°äº”å¹´éƒ½æœ‰å¯èƒ½ã€‚åˆæœŸå…§å®¹ä»¥è»Ÿé«”å·¥ç¨‹ç‚ºä¸»ï¼Œç­‰è²¡å¯Œè‡ªç”±å¾Œæœƒæœ‰æ›´å¤šé›œ">
<meta property="og:type" content="article">
<meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x10/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-05-09T00:00:00+08:00">
<meta property="article:modified_time" content="2020-05-09T00:00:00+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½">
<meta name=twitter:description content="é€™è£¡æ˜¯ WWW ç¬¬æ‹¾é™¸æœŸï¼ŒWow Weihang Weekly æ˜¯ä¸€å€‹æ¯«ç„¡ç« æ³•çš„å€‹äººé€±åˆŠï¼Œå‡ºåˆŠé€±æœŸæ¥µä¸å›ºå®šï¼Œå¾ä¸€é€±åˆ°äº”å¹´éƒ½æœ‰å¯èƒ½ã€‚åˆæœŸå…§å®¹ä»¥è»Ÿé«”å·¥ç¨‹ç‚ºä¸»ï¼Œç­‰è²¡å¯Œè‡ªç”±å¾Œæœƒæœ‰æ›´å¤šé›œ">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://weihanglo.tw/posts/"},{"@type":"ListItem","position":3,"name":"WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½","item":"https://weihanglo.tw/posts/2020/www-0x10/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½","name":"WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½","description":"é€™è£¡æ˜¯ WWW ç¬¬æ‹¾é™¸æœŸï¼ŒWow Weihang Weekly æ˜¯ä¸€å€‹æ¯«ç„¡ç« æ³•çš„å€‹äººé€±åˆŠï¼Œå‡ºåˆŠé€±æœŸæ¥µä¸å›ºå®šï¼Œå¾ä¸€é€±åˆ°äº”å¹´éƒ½æœ‰å¯èƒ½ã€‚åˆæœŸå…§å®¹ä»¥è»Ÿé«”å·¥ç¨‹ç‚ºä¸»ï¼Œç­‰è²¡å¯Œè‡ªç”±å¾Œæœƒæœ‰æ›´å¤šé›œ","keywords":["Rust","DevOps","Databases"],"articleBody":"é€™è£¡æ˜¯ WWW ç¬¬æ‹¾é™¸æœŸï¼ŒWow Weihang Weekly æ˜¯ä¸€å€‹æ¯«ç„¡ç« æ³•çš„å€‹äººé€±åˆŠï¼Œå‡ºåˆŠé€±æœŸæ¥µä¸å›ºå®šï¼Œå¾ä¸€é€±åˆ°äº”å¹´éƒ½æœ‰å¯èƒ½ã€‚åˆæœŸå…§å®¹ä»¥è»Ÿé«”å·¥ç¨‹ç‚ºä¸»ï¼Œç­‰è²¡å¯Œè‡ªç”±å¾Œæœƒæœ‰æ›´å¤šé›œé£Ÿç¯‡ç« ã€‚\nGraceful shutdown in Kubernetes is not always trivial å°ä¸èµ·ï¼Œåˆ†äº«ä¸€ç¯‡ medium ä»˜è²»ç‰†çš„æ–‡ç« ã€‚é‡é»ç¯€éŒ„ï¼š\n è®“ä½ çš„ app delay ä¸€äº›æ™‚é–“å†åœæ­¢æ¥æ”¶ connection å¦‚æœä½ æ²’è¾¦æ³•æ§åˆ¶ appï¼ˆcode ä¸æ˜¯ä½ å¯«çš„ï¼‰ï¼Œå¯åŠ  preStop hook ä¾†æ§åˆ¶ å¦‚æœåŠ äº†æ²’ç”¨ï¼Œè«‹å»çœ‹è©² app å¦‚ä½•è™•ç†å„ç¨® Signal è«‹æ¸¬è©¦ï¼Œè«‹åˆ†æï¼Œä¸è¦ç›²ç›®å¯«å®Œå°±ç•¶ä½œè‡ªå·±åšå¥½ graceful shutdown  ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´è®¡ç®— ç”±æ–¼é–‹æºè³‡æ–™åº«ç³»çµ± TiDB ç‚ºä¸­åœ‹äººç ”ç™¼ï¼Œä¸­æ–‡æ’°å¯«çš„æ–‡ä»¶éå¸¸å¤šï¼Œé€™ç¯‡ä¸»è¦ä»‹ç´¹ SQL çš„ relation model å¦‚ä½•æ˜ å°„åˆ° Key-Value modelï¼Œè™•ç† index å’Œ unique index ä¹Ÿä¸ç›¸åŒã€‚å¾ˆæœ‰è¶£ï¼Œå€¼å¾—ä¸€è®€ï¼ˆTiDB/TiKV çš„ source code ä¹Ÿæ˜¯ ğŸ˜‚ï¼‰ã€‚\nRewriting the heart of our sync engine Dropbox é‡å¯«æ•´å€‹é›»è…¦ç‰ˆçš„åŒæ­¥å¼•æ“ Nucleusï¼ŒèŠ±äº†å››å¹´æ™‚é–“ï¼Œç¯€éŒ„äº›ï¼ˆå…¶å¯¦ä¸æ˜¯ç¯€éŒ„ï¼‰æœ‰è¶£ç™¼ç¾ï¼š\nğŸ¤¯ åŒæ­¥æª”æ¡ˆæœ‰ä¸‹åˆ—å¹¾å€‹å›°é›£é»  åˆ†æ•£å¼ç³»çµ±ï¼šclient å¸¸å¸¸ offlineã€æˆ–æ˜¯åœ¨ä¸åŒçš„è£ç½®åŒæ­¥ï¼Œæ‰æ‰å¯¦å¯¦å°±æ˜¯å€‹åˆ†æ•£å¼ç³»çµ± è€ç”¨æ€§ï¼šä¸åŒä½œæ¥­ç³»çµ±æœ‰ä¸åŒçš„å¯¦ä½œï¼Œæœ‰äº›æ™‚å€™ç”šè‡³è¦ reverse-engineeringï¼Œä¸éé€™é€šå¸¸æœƒå½±éŸ¿åˆ°å¾ˆå°éƒ¨åˆ†äºº æ¸¬è©¦æª”æ¡ˆåŒæ­¥ï¼šå„ç¨®é€£ç·šç‹€æ³ã€æœ¬åœ°è®€å–ã€å¯«æª”åˆ°ç¡¬ç¢Ÿã€ä¸åŒçš„ snapshotã€ä¸Šå‚³ã€chunk transfer åŒæ­¥è¡Œç‚ºï¼šä¸åŒ client ä»»æ„ç§»å‹•è³‡æ–™å¤¾ï¼Œé€ æˆè³‡æ–™å¤¾é–“ circular cycle  âœï¸ ç‚ºä»€éº¼è¦é‡å¯« é›–ç„¶åŸå§‹çš„åŒæ­¥æœå‹™å¾ˆæˆåŠŸï¼Œåœ˜éšŠä¹Ÿä¸æ–·é‡æ§‹æœ€ä½³åŒ–ï¼Œä½†ç¨‹å¼ç¢¼ä¸¦ä¸å¥åº·ï¼Œæœ€å¤§å¹¾å€‹å•é¡Œæ˜¯ï¼š\n Consistencyï¼š data model æ²’æœ‰è€ƒæ…®å…±äº«æ€§ï¼Œconsistency guarantees ä¸å¼· Testabilityï¼š ç³»çµ±å¯æ¸¬è©¦æ€§ä¸å¤ å¼·ï¼Œåè€Œä¾é  slow rollout ç„¶å¾Œé–‹å§‹ debugging Concurrencyï¼š æœ€å¾Œç•¶ç„¶æ˜¯ concurrent å•é¡Œï¼Œä¸å¥½æ¸¬ï¼Œä¸å¥½é‡ç¾ï¼Œåªå¥½ç”¨ç²—ç²’åº¦çš„é–ï¼ŒçŠ§ç‰²ä¸€äº›æ•ˆèƒ½  ğŸ“ ç³»çµ±é‡å¯«æ ¸å°æ¸…å–® æ•´ç¯‡æ–‡ç« åªæœ‰é€™éƒ¨åˆ†æœ€æœ‰è¶£ï¼Œå› ç‚º Dropbox åœ˜éšŠçŸ¥é“é‡å¯«å…¶å¯¦å®¹æ˜“æ˜¯ä¸æ˜æ™ºçš„æ±ºç­–ï¼Œä½†åœ˜éšŠé‚„æ˜¯å¾ˆæ¸…æ¥šåˆ—å‡ºæ±ºå®šé‡å¯«çš„é—œéµï¼ˆèªªä¸å®šæ˜¯äº‹å¾Œè«¸è‘›ï¼‰ã€‚\n æ˜¯å¦çª®ç›¡æ‰€æœ‰æ¼¸é€²æ”¹å–„æ–¹æ¡ˆ  æœ‰è©¦éé‡æ§‹ç¾æœ‰æ¨¡çµ„å— æœ‰é‡å°ç†±é»åˆ†ææ”¹å–„å— å¯éšæ®µæ€§ç™¼ä½ˆæ¼¸é€²æ”¹å–„çš„æˆæœå—   æ˜¯å¦æœ‰è¶³å¤ èƒ½åŠ›é‡å¯«å°ˆæ¡ˆ  å°ç¾æœ‰å°ˆæ¡ˆå®Œå…¨ç­è§£åˆ°è€ƒå¤ç¨‹åº¦å— æœ‰è¶³å¤ çš„å·¥ç¨‹è³‡æºå— å¯æ¥å—æ–°åŠŸèƒ½é–‹ç™¼æ­¥èª¿è¶¨ç·©å—   æ˜¯å¦çŸ¥é“å°ˆæ¡ˆçš„æœªä¾†æ–¹å‘  é‡å¯«çœŸçš„æœƒæ”¹å–„å— æ–°ç³»çµ±æœ‰åˆ¶å®šå„ç¨®åŸå‰‡å—    æˆ‘æ‡¶å¾—è©³è¿° Dropbox å°é€™äº›å•é¡Œçš„ç­”æ¡ˆï¼Œä½†å®ƒå€‘å…¶å¯¦é€é MyPyï¼ˆå°è±¡ä¸­ MyPy å°±æ˜¯ Dropbox ç™¼æšå…‰å¤§ï¼‰é‚„æœ‰å„ç¨® profiling å·¥å…·ä¸æ–·é‡æ§‹ï¼Œä½†ä»ç„¶æ±ºå®šé‡å¯«ã€‚å…¶ä¸­å®Œå…¨è·³è„«æˆ‘çš„æ€ç¶­çš„æ˜¯æœ€å¾Œä¸€é»ï¼Œé‡å¯«æ–°ç³»çµ±å…¶å¯¦å°±æ˜¯ã€Œ é‡æ–°å¡‘é€ å·¥ç¨‹æ–‡åŒ– ã€çš„å¥½æ™‚æ©Ÿï¼ˆä¹Ÿæ˜¯å¤§æè¾¦å…¬å®¤æ”¿æ²»çš„å¥½æ™‚æ©Ÿ ğŸ˜ˆï¼‰ï¼Œå–„ç”¨é€™å€‹æ©Ÿæœƒï¼Œåœ˜éšŠè‚¯å®šç…¥ç„¶ä¸€æ–°ã€‚\n Starting from scratch is a great opportunity to reset technical culture for a team.\n ğŸ“¦ æ‰€ä»¥ Dropbox åˆ°åº•åšäº†ä»€éº¼ å¯«äº†é€™éº¼å¤šï¼Œæ‡‰è©²å·²ç¶“çŒœåˆ° Dropbox åšäº†ä»€éº¼ï¼Œå°ï¼Œå°±æ˜¯ç”¨ Rust é‡å¯«ä»–å€‘æ•´å€‹ Desktop client sync engineã€‚Rust å° Dropbox ä¾†èªªæ˜¯å€‹ã€Œforce multiplierã€ï¼Œä½¿ç”¨ Rust æ˜¯æœ€å¥½çš„æŠ€è¡“æ±ºç­–ä¹‹ä¸€ï¼Œé™¤äº†æ•ˆèƒ½ï¼Œtype system å’Œ AOT compiling checking æ‰æ˜¯è®“åœ˜éšŠç¬‘åˆ°æœ€å¾Œçš„é—œéµå› ç´ ã€‚\nå»£å‘Šå¿«æ‰“å®Œäº†ï¼Œé‚„æ˜¯æä¸€ä¸‹æ–°çš„ sync engine Nucleus åˆ°åº•è‘«è˜†è£¡è³£ä»€éº¼èª²ç¨‹ï¼š\n Threading model ç°¡åŒ–ï¼š å¹¾ä¹æ‰€æœ‰ code éƒ½åœ¨ single threadï¼ˆa.k.aã€ŒThe Control Threadã€ï¼‰ç”¨äº† Rust éåŒæ­¥çš„ de facto futures.rsï¼Œå‰©ä¸‹ network IO æ”¾åˆ° event loopï¼ˆæœªçœ‹å…ˆçŒœæ˜¯ tokioï¼‰ï¼ŒCPU-heavy task æœ‰ thread poolï¼Œæª”æ¡ˆç³»çµ± IO ä¹Ÿæœ‰å€‹ dedicated threadã€‚ä¹¾ä¹¾æ·¨æ·¨ï¼Œæ¸…æ½”æºœæºœã€‚ Deterministic å¢åŠ  testabilityï¼š The Control Thread åœ¨è¼¸å…¥å€¼å’Œæ’ç¨‹æ³•ç¢ºå®šçš„æ¢ä»¶ä¸‹ï¼Œè¡Œç‚ºæ˜¯ deterministicï¼Œè§£æ±ºäº†èˆŠç³»çµ±ä¸å®¹æ˜“å¯«æ¸¬è©¦çš„å•é¡Œï¼Œä¹Ÿèƒ½ç°¡å–®é‡ç¾éŒ¯èª¤ï¼Œç”šè‡³å¯ä»¥ç”¨å€‹åš pseudorandom çš„ inputã€æª”æ¡ˆã€ç³»çµ±ç‹€æ…‹å’ŒéŒ¯èª¤ã€‚ é‡æ–°è¨­è¨ˆå…·æœ‰ strong consistency çš„ client-server protocolï¼š å…±äº«çš„æª”æ¡ˆå’Œç›®éŒ„çµ‚æ–¼æœ‰å…¨åŸŸ IDï¼Œæª”æ¡ˆå’Œç›®éŒ„çš„ç§»å‹•æ˜¯ O(1)ï¼Œå’Œä»–å€‘ subtree çš„å¤§å°ç„¡é—œï¼ˆä¸çŸ¥é“åº•å±¤æ€éº¼åšåˆ°ï¼‰ã€‚  ç„¶å¾Œ Dropbox æ­£åœ¨æ‰¾æœƒå¯« Rust çš„ infra team memberï¼Œå¸¥ã€‚\n æ²’éŒ¯ï¼ŒRust æ—©å°±æ»²é€ä½ æˆ‘çš„ç”Ÿæ´»ï¼Œäººé²æ—©æœƒé½è•\n ","wordCount":"1522","inLanguage":"en","datePublished":"2020-05-09T00:00:00+08:00","dateModified":"2020-05-09T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weihanglo.tw/posts/2020/www-0x10/"},"publisher":{"@type":"Organization","name":"Weihang Lo","logo":{"@type":"ImageObject","url":"https://weihanglo.tw/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://weihanglo.tw accesskey=h title="Weihang Lo (Alt + H)">Weihang Lo</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://weihanglo.tw/ title=Home>
<span>Home</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
WWW 0x10: é‡æ§‹ä¸æ˜¯ç—…ï¼Œå¯«èµ·ä¾†è¦äººå‘½
</h1>
<div class=post-meta><span title="2020-05-09 00:00:00 +0800 +0800">May 9, 2020</span>&nbsp;Â·&nbsp;4 min
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#graceful-shutdown-in-kubernetes-is-not-always-trivialhttpsmediumcomflant-comkubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2 aria-label="Graceful shutdown in Kubernetes is not always trivial"><a href=https://medium.com/flant-com/kubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2>Graceful shutdown in Kubernetes is not always trivial</a></a></li>
<li>
<a href=#%e4%b8%89%e7%af%87%e6%96%87%e7%ab%a0%e4%ba%86%e8%a7%a3-tidb-%e6%8a%80%e6%9c%af%e5%86%85%e5%b9%95---%e8%af%b4%e8%ae%a1%e7%ae%97httpspingcapcomblog-cntidb-internal-2 aria-label="ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´è®¡ç®—"><a href=https://pingcap.com/blog-cn/tidb-internal-2/>ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´è®¡ç®—</a></a></li>
<li>
<a href=#rewriting-the-heart-of-our-sync-enginehttpsdropboxtechinfrastructurerewriting-the-heart-of-our-sync-engine aria-label="Rewriting the heart of our sync engine"><a href=https://dropbox.tech/infrastructure/rewriting-the-heart-of-our-sync-engine>Rewriting the heart of our sync engine</a></a><ul>
<li>
<a href=#-%e5%90%8c%e6%ad%a5%e6%aa%94%e6%a1%88%e6%9c%89%e4%b8%8b%e5%88%97%e5%b9%be%e5%80%8b%e5%9b%b0%e9%9b%a3%e9%bb%9e aria-label="ğŸ¤¯ åŒæ­¥æª”æ¡ˆæœ‰ä¸‹åˆ—å¹¾å€‹å›°é›£é»">ğŸ¤¯ åŒæ­¥æª”æ¡ˆæœ‰ä¸‹åˆ—å¹¾å€‹å›°é›£é»</a></li>
<li>
<a href=#-%e7%82%ba%e4%bb%80%e9%ba%bc%e8%a6%81%e9%87%8d%e5%af%ab aria-label="âœï¸ ç‚ºä»€éº¼è¦é‡å¯«">âœï¸ ç‚ºä»€éº¼è¦é‡å¯«</a></li>
<li>
<a href=#-%e7%b3%bb%e7%b5%b1%e9%87%8d%e5%af%ab%e6%a0%b8%e5%b0%8d%e6%b8%85%e5%96%ae aria-label="ğŸ“ ç³»çµ±é‡å¯«æ ¸å°æ¸…å–®">ğŸ“ ç³»çµ±é‡å¯«æ ¸å°æ¸…å–®</a></li>
<li>
<a href=#-%e6%89%80%e4%bb%a5-dropbox-%e5%88%b0%e5%ba%95%e5%81%9a%e4%ba%86%e4%bb%80%e9%ba%bc aria-label="ğŸ“¦ æ‰€ä»¥ Dropbox åˆ°åº•åšäº†ä»€éº¼">ğŸ“¦ æ‰€ä»¥ Dropbox åˆ°åº•åšäº†ä»€éº¼</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>é€™è£¡æ˜¯ WWW ç¬¬æ‹¾é™¸æœŸï¼ŒWow Weihang Weekly æ˜¯ä¸€å€‹æ¯«ç„¡ç« æ³•çš„å€‹äººé€±åˆŠï¼Œå‡ºåˆŠé€±æœŸæ¥µä¸å›ºå®šï¼Œå¾ä¸€é€±åˆ°äº”å¹´éƒ½æœ‰å¯èƒ½ã€‚åˆæœŸå…§å®¹ä»¥è»Ÿé«”å·¥ç¨‹ç‚ºä¸»ï¼Œç­‰è²¡å¯Œè‡ªç”±å¾Œæœƒæœ‰æ›´å¤šé›œé£Ÿç¯‡ç« ã€‚</p>
<h2 id=graceful-shutdown-in-kubernetes-is-not-always-trivialhttpsmediumcomflant-comkubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2><a href=https://medium.com/flant-com/kubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2>Graceful shutdown in Kubernetes is not always trivial</a><a hidden class=anchor aria-hidden=true href=#graceful-shutdown-in-kubernetes-is-not-always-trivialhttpsmediumcomflant-comkubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2>#</a></h2>
<p>å°ä¸èµ·ï¼Œåˆ†äº«ä¸€ç¯‡ medium ä»˜è²»ç‰†çš„æ–‡ç« ã€‚é‡é»ç¯€éŒ„ï¼š</p>
<ul>
<li>è®“ä½ çš„ app delay ä¸€äº›æ™‚é–“å†åœæ­¢æ¥æ”¶ connection</li>
<li>å¦‚æœä½ æ²’è¾¦æ³•æ§åˆ¶ appï¼ˆcode ä¸æ˜¯ä½ å¯«çš„ï¼‰ï¼Œå¯åŠ  <code>preStop</code> hook ä¾†æ§åˆ¶</li>
<li>å¦‚æœåŠ äº†æ²’ç”¨ï¼Œè«‹å»çœ‹è©² app å¦‚ä½•è™•ç†å„ç¨® Signal</li>
<li>è«‹æ¸¬è©¦ï¼Œè«‹åˆ†æï¼Œä¸è¦ç›²ç›®å¯«å®Œå°±ç•¶ä½œè‡ªå·±åšå¥½ graceful shutdown</li>
</ul>
<h2 id=ä¸‰ç¯‡æ–‡ç« äº†è§£-tidb-æŠ€æœ¯å†…å¹•---è¯´è®¡ç®—httpspingcapcomblog-cntidb-internal-2><a href=https://pingcap.com/blog-cn/tidb-internal-2/>ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´è®¡ç®—</a><a hidden class=anchor aria-hidden=true href=#ä¸‰ç¯‡æ–‡ç« äº†è§£-tidb-æŠ€æœ¯å†…å¹•---è¯´è®¡ç®—httpspingcapcomblog-cntidb-internal-2>#</a></h2>
<p>ç”±æ–¼é–‹æºè³‡æ–™åº«ç³»çµ± <a href=https://pingcap.com>TiDB</a> ç‚ºä¸­åœ‹äººç ”ç™¼ï¼Œä¸­æ–‡æ’°å¯«çš„æ–‡ä»¶éå¸¸å¤šï¼Œé€™ç¯‡ä¸»è¦ä»‹ç´¹ SQL çš„ relation model å¦‚ä½•æ˜ å°„åˆ° Key-Value modelï¼Œè™•ç† index å’Œ unique index ä¹Ÿä¸ç›¸åŒã€‚å¾ˆæœ‰è¶£ï¼Œå€¼å¾—ä¸€è®€ï¼ˆTiDB/TiKV çš„ source code ä¹Ÿæ˜¯ ğŸ˜‚ï¼‰ã€‚</p>
<h2 id=rewriting-the-heart-of-our-sync-enginehttpsdropboxtechinfrastructurerewriting-the-heart-of-our-sync-engine><a href=https://dropbox.tech/infrastructure/rewriting-the-heart-of-our-sync-engine>Rewriting the heart of our sync engine</a><a hidden class=anchor aria-hidden=true href=#rewriting-the-heart-of-our-sync-enginehttpsdropboxtechinfrastructurerewriting-the-heart-of-our-sync-engine>#</a></h2>
<p><img loading=lazy src=https://dropbox.tech/cms/content/dam/dropbox/tech-blog/en-us/2020/03/01.png alt>
</p>
<p>Dropbox é‡å¯«æ•´å€‹é›»è…¦ç‰ˆçš„åŒæ­¥å¼•æ“ <strong>Nucleus</strong>ï¼ŒèŠ±äº†å››å¹´æ™‚é–“ï¼Œç¯€éŒ„äº›ï¼ˆå…¶å¯¦ä¸æ˜¯ç¯€éŒ„ï¼‰æœ‰è¶£ç™¼ç¾ï¼š</p>
<h3 id=-åŒæ­¥æª”æ¡ˆæœ‰ä¸‹åˆ—å¹¾å€‹å›°é›£é»>ğŸ¤¯ åŒæ­¥æª”æ¡ˆæœ‰ä¸‹åˆ—å¹¾å€‹å›°é›£é»<a hidden class=anchor aria-hidden=true href=#-åŒæ­¥æª”æ¡ˆæœ‰ä¸‹åˆ—å¹¾å€‹å›°é›£é»>#</a></h3>
<ul>
<li>åˆ†æ•£å¼ç³»çµ±ï¼šclient å¸¸å¸¸ offlineã€æˆ–æ˜¯åœ¨ä¸åŒçš„è£ç½®åŒæ­¥ï¼Œæ‰æ‰å¯¦å¯¦å°±æ˜¯å€‹åˆ†æ•£å¼ç³»çµ±</li>
<li>è€ç”¨æ€§ï¼šä¸åŒä½œæ¥­ç³»çµ±æœ‰ä¸åŒçš„å¯¦ä½œï¼Œæœ‰äº›æ™‚å€™ç”šè‡³è¦ reverse-engineeringï¼Œä¸éé€™é€šå¸¸æœƒå½±éŸ¿åˆ°å¾ˆå°éƒ¨åˆ†äºº</li>
<li>æ¸¬è©¦æª”æ¡ˆåŒæ­¥ï¼šå„ç¨®é€£ç·šç‹€æ³ã€æœ¬åœ°è®€å–ã€å¯«æª”åˆ°ç¡¬ç¢Ÿã€ä¸åŒçš„ snapshotã€ä¸Šå‚³ã€chunk transfer</li>
<li>åŒæ­¥è¡Œç‚ºï¼šä¸åŒ client ä»»æ„ç§»å‹•è³‡æ–™å¤¾ï¼Œé€ æˆè³‡æ–™å¤¾é–“ circular cycle</li>
</ul>
<h3 id=-ç‚ºä»€éº¼è¦é‡å¯«>âœï¸ ç‚ºä»€éº¼è¦é‡å¯«<a hidden class=anchor aria-hidden=true href=#-ç‚ºä»€éº¼è¦é‡å¯«>#</a></h3>
<p>é›–ç„¶åŸå§‹çš„åŒæ­¥æœå‹™å¾ˆæˆåŠŸï¼Œåœ˜éšŠä¹Ÿä¸æ–·é‡æ§‹æœ€ä½³åŒ–ï¼Œä½†ç¨‹å¼ç¢¼ä¸¦ä¸å¥åº·ï¼Œæœ€å¤§å¹¾å€‹å•é¡Œæ˜¯ï¼š</p>
<ul>
<li><strong>Consistencyï¼š</strong> data model æ²’æœ‰è€ƒæ…®å…±äº«æ€§ï¼Œconsistency guarantees ä¸å¼·</li>
<li><strong>Testabilityï¼š</strong> ç³»çµ±å¯æ¸¬è©¦æ€§ä¸å¤ å¼·ï¼Œåè€Œä¾é  slow rollout ç„¶å¾Œé–‹å§‹ debugging</li>
<li><strong>Concurrencyï¼š</strong> æœ€å¾Œç•¶ç„¶æ˜¯ concurrent å•é¡Œï¼Œä¸å¥½æ¸¬ï¼Œä¸å¥½é‡ç¾ï¼Œåªå¥½ç”¨ç²—ç²’åº¦çš„é–ï¼ŒçŠ§ç‰²ä¸€äº›æ•ˆèƒ½</li>
</ul>
<h3 id=-ç³»çµ±é‡å¯«æ ¸å°æ¸…å–®>ğŸ“ ç³»çµ±é‡å¯«æ ¸å°æ¸…å–®<a hidden class=anchor aria-hidden=true href=#-ç³»çµ±é‡å¯«æ ¸å°æ¸…å–®>#</a></h3>
<p>æ•´ç¯‡æ–‡ç« <del>åªæœ‰</del>é€™éƒ¨åˆ†æœ€æœ‰è¶£ï¼Œå› ç‚º Dropbox åœ˜éšŠçŸ¥é“<a href=https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/>é‡å¯«å…¶å¯¦å®¹æ˜“æ˜¯ä¸æ˜æ™ºçš„æ±ºç­–</a>ï¼Œä½†åœ˜éšŠé‚„æ˜¯å¾ˆæ¸…æ¥šåˆ—å‡ºæ±ºå®šé‡å¯«çš„é—œéµï¼ˆèªªä¸å®šæ˜¯äº‹å¾Œè«¸è‘›ï¼‰ã€‚</p>
<ol>
<li>æ˜¯å¦çª®ç›¡æ‰€æœ‰æ¼¸é€²æ”¹å–„æ–¹æ¡ˆ
<ol>
<li>æœ‰è©¦éé‡æ§‹ç¾æœ‰æ¨¡çµ„å—</li>
<li>æœ‰é‡å°ç†±é»åˆ†ææ”¹å–„å—</li>
<li>å¯éšæ®µæ€§ç™¼ä½ˆæ¼¸é€²æ”¹å–„çš„æˆæœå—</li>
</ol>
</li>
<li>æ˜¯å¦æœ‰è¶³å¤ èƒ½åŠ›é‡å¯«å°ˆæ¡ˆ
<ol>
<li>å°ç¾æœ‰å°ˆæ¡ˆå®Œå…¨ç­è§£åˆ°è€ƒå¤ç¨‹åº¦å—</li>
<li>æœ‰è¶³å¤ çš„å·¥ç¨‹è³‡æºå—</li>
<li>å¯æ¥å—æ–°åŠŸèƒ½é–‹ç™¼æ­¥èª¿è¶¨ç·©å—</li>
</ol>
</li>
<li>æ˜¯å¦çŸ¥é“å°ˆæ¡ˆçš„æœªä¾†æ–¹å‘
<ol>
<li>é‡å¯«çœŸçš„æœƒæ”¹å–„å—</li>
<li>æ–°ç³»çµ±æœ‰åˆ¶å®šå„ç¨®åŸå‰‡å—</li>
</ol>
</li>
</ol>
<p>æˆ‘æ‡¶å¾—è©³è¿° Dropbox å°é€™äº›å•é¡Œçš„ç­”æ¡ˆï¼Œä½†å®ƒå€‘å…¶å¯¦é€é <a href=http://mypy-lang.org/>MyPy</a>ï¼ˆå°è±¡ä¸­ MyPy å°±æ˜¯ Dropbox ç™¼æšå…‰å¤§ï¼‰é‚„æœ‰å„ç¨® profiling å·¥å…·ä¸æ–·é‡æ§‹ï¼Œä½†ä»ç„¶æ±ºå®šé‡å¯«ã€‚å…¶ä¸­å®Œå…¨è·³è„«æˆ‘çš„æ€ç¶­çš„æ˜¯æœ€å¾Œä¸€é»ï¼Œé‡å¯«æ–°ç³»çµ±å…¶å¯¦å°±æ˜¯ã€Œ <strong>é‡æ–°å¡‘é€ å·¥ç¨‹æ–‡åŒ–</strong> ã€çš„å¥½æ™‚æ©Ÿï¼ˆä¹Ÿæ˜¯å¤§æè¾¦å…¬å®¤æ”¿æ²»çš„å¥½æ™‚æ©Ÿ ğŸ˜ˆï¼‰ï¼Œå–„ç”¨é€™å€‹æ©Ÿæœƒï¼Œåœ˜éšŠè‚¯å®šç…¥ç„¶ä¸€æ–°ã€‚</p>
<blockquote>
<p>Starting from scratch is a great opportunity to reset technical culture for a team.</p>
</blockquote>
<h3 id=-æ‰€ä»¥-dropbox-åˆ°åº•åšäº†ä»€éº¼>ğŸ“¦ æ‰€ä»¥ Dropbox åˆ°åº•åšäº†ä»€éº¼<a hidden class=anchor aria-hidden=true href=#-æ‰€ä»¥-dropbox-åˆ°åº•åšäº†ä»€éº¼>#</a></h3>
<p>å¯«äº†é€™éº¼å¤šï¼Œæ‡‰è©²å·²ç¶“çŒœåˆ° Dropbox åšäº†ä»€éº¼ï¼Œå°ï¼Œå°±æ˜¯ç”¨ <strong>Rust</strong> é‡å¯«ä»–å€‘æ•´å€‹ Desktop client sync engineã€‚Rust å° Dropbox ä¾†èªªæ˜¯å€‹ã€Œforce multiplierã€ï¼Œä½¿ç”¨ Rust æ˜¯æœ€å¥½çš„æŠ€è¡“æ±ºç­–ä¹‹ä¸€ï¼Œé™¤äº†æ•ˆèƒ½ï¼Œtype system å’Œ AOT compiling checking æ‰æ˜¯è®“åœ˜éšŠç¬‘åˆ°æœ€å¾Œçš„é—œéµå› ç´ ã€‚</p>
<p>å»£å‘Šå¿«æ‰“å®Œäº†ï¼Œé‚„æ˜¯æä¸€ä¸‹æ–°çš„ sync engine <strong>Nucleus</strong> åˆ°åº•è‘«è˜†è£¡è³£ä»€éº¼èª²ç¨‹ï¼š</p>
<ul>
<li><strong>Threading model ç°¡åŒ–ï¼š</strong> å¹¾ä¹æ‰€æœ‰ code éƒ½åœ¨ single threadï¼ˆa.k.aã€ŒThe Control Threadã€ï¼‰ç”¨äº† Rust éåŒæ­¥çš„ de facto <a href=https://github.com/rust-lang/futures-rs>futures.rs</a>ï¼Œå‰©ä¸‹ network IO æ”¾åˆ° event loopï¼ˆæœªçœ‹å…ˆçŒœæ˜¯ <a href=https://tokio.rs>tokio</a>ï¼‰ï¼ŒCPU-heavy task æœ‰ thread poolï¼Œæª”æ¡ˆç³»çµ± IO ä¹Ÿæœ‰å€‹ dedicated threadã€‚ä¹¾ä¹¾æ·¨æ·¨ï¼Œæ¸…æ½”æºœæºœã€‚</li>
<li><strong>Deterministic å¢åŠ  testabilityï¼š</strong> The Control Thread åœ¨è¼¸å…¥å€¼å’Œæ’ç¨‹æ³•ç¢ºå®šçš„æ¢ä»¶ä¸‹ï¼Œè¡Œç‚ºæ˜¯ deterministicï¼Œè§£æ±ºäº†èˆŠç³»çµ±ä¸å®¹æ˜“å¯«æ¸¬è©¦çš„å•é¡Œï¼Œä¹Ÿèƒ½ç°¡å–®é‡ç¾éŒ¯èª¤ï¼Œç”šè‡³å¯ä»¥ç”¨å€‹åš pseudorandom çš„ inputã€æª”æ¡ˆã€ç³»çµ±ç‹€æ…‹å’ŒéŒ¯èª¤ã€‚</li>
<li><strong>é‡æ–°è¨­è¨ˆå…·æœ‰ strong consistency çš„ client-server protocolï¼š</strong> å…±äº«çš„æª”æ¡ˆå’Œç›®éŒ„çµ‚æ–¼æœ‰å…¨åŸŸ IDï¼Œæª”æ¡ˆå’Œç›®éŒ„çš„ç§»å‹•æ˜¯ O(1)ï¼Œå’Œä»–å€‘ subtree çš„å¤§å°ç„¡é—œï¼ˆä¸çŸ¥é“åº•å±¤æ€éº¼åšåˆ°ï¼‰ã€‚</li>
</ul>
<p>ç„¶å¾Œ Dropbox æ­£åœ¨æ‰¾æœƒå¯« Rust çš„ infra team memberï¼Œå¸¥ã€‚</p>
<blockquote>
<p>æ²’éŒ¯ï¼ŒRust æ—©å°±æ»²é€ä½ æˆ‘çš„ç”Ÿæ´»ï¼Œäººé²æ—©æœƒé½è•</p>
</blockquote>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://weihanglo.tw/tags/rust/>Rust</a></li>
<li><a href=https://weihanglo.tw/tags/devops/>DevOps</a></li>
<li><a href=https://weihanglo.tw/tags/databases/>Databases</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://weihanglo.tw/posts/2020/www-0x11/>
<span class=title>Â« Prev Page</span>
<br>
<span>WWW 0x11: åº«å­˜æ–‡ç« å·²ç”¨ç½„</span>
</a>
<a class=next href=https://weihanglo.tw/posts/2020/www-0x0f/>
<span class=title>Next Page Â»</span>
<br>
<span>WWW 0x0F: å·¥ç¨‹å¸«å”¯ä¸€éœ€è¦çŸ¥é“çš„æ•¸å­—æ˜¯ä¼´ä¾¶ç”Ÿæ—¥</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>CC BY-NC-SA 4.0</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>