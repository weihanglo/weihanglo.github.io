<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç† | Weihang Lo</title>
<meta name=keywords content="Kubernetes,DevOps">
<meta name=description content="K8s æœ‰å¥½ç”¨çš„ autoscaling åŠŸèƒ½ï¼Œä½†ä½ çŸ¥é“é™¤äº† pod ä¹‹å¤–ï¼Œnode ä¹Ÿå¯ä»¥ auto scaling å—ï¼Ÿå¸¥ï¼Œä½ çŸ¥é“å°±ä¸ç”¨åˆ†äº«äº†å•Š ğŸš¬ æœ¬æ–‡ä»¥é‡é»æ•´ç†çš„æ–¹å¼ï¼Œå…ˆä»‹ç´¹ç›®å‰å¸¸è¦‹çš„ Autoscal">
<meta name=author content>
<link rel=canonical href=https://weihanglo.tw/posts/2020/k8s-autoscaling/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.css rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://weihanglo.tw/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://weihanglo.tw/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://weihanglo.tw/favicon-32x32.png>
<link rel=apple-touch-icon href=https://weihanglo.tw/apple-touch-icon.png>
<link rel=mask-icon href=https://weihanglo.tw/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script>
<meta property="og:title" content="Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç†">
<meta property="og:description" content="K8s æœ‰å¥½ç”¨çš„ autoscaling åŠŸèƒ½ï¼Œä½†ä½ çŸ¥é“é™¤äº† pod ä¹‹å¤–ï¼Œnode ä¹Ÿå¯ä»¥ auto scaling å—ï¼Ÿå¸¥ï¼Œä½ çŸ¥é“å°±ä¸ç”¨åˆ†äº«äº†å•Š ğŸš¬ æœ¬æ–‡ä»¥é‡é»æ•´ç†çš„æ–¹å¼ï¼Œå…ˆä»‹ç´¹ç›®å‰å¸¸è¦‹çš„ Autoscal">
<meta property="og:type" content="article">
<meta property="og:url" content="https://weihanglo.tw/posts/2020/k8s-autoscaling/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-03-23T00:00:00+08:00">
<meta property="article:modified_time" content="2020-03-23T00:00:00+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç†">
<meta name=twitter:description content="K8s æœ‰å¥½ç”¨çš„ autoscaling åŠŸèƒ½ï¼Œä½†ä½ çŸ¥é“é™¤äº† pod ä¹‹å¤–ï¼Œnode ä¹Ÿå¯ä»¥ auto scaling å—ï¼Ÿå¸¥ï¼Œä½ çŸ¥é“å°±ä¸ç”¨åˆ†äº«äº†å•Š ğŸš¬ æœ¬æ–‡ä»¥é‡é»æ•´ç†çš„æ–¹å¼ï¼Œå…ˆä»‹ç´¹ç›®å‰å¸¸è¦‹çš„ Autoscal">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://weihanglo.tw/posts/"},{"@type":"ListItem","position":3,"name":"Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç†","item":"https://weihanglo.tw/posts/2020/k8s-autoscaling/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç†","name":"Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç†","description":"K8s æœ‰å¥½ç”¨çš„ autoscaling åŠŸèƒ½ï¼Œä½†ä½ çŸ¥é“é™¤äº† pod ä¹‹å¤–ï¼Œnode ä¹Ÿå¯ä»¥ auto scaling å—ï¼Ÿå¸¥ï¼Œä½ çŸ¥é“å°±ä¸ç”¨åˆ†äº«äº†å•Š ğŸš¬ æœ¬æ–‡ä»¥é‡é»æ•´ç†çš„æ–¹å¼ï¼Œå…ˆä»‹ç´¹ç›®å‰å¸¸è¦‹çš„ Autoscal","keywords":["Kubernetes","DevOps"],"articleBody":"K8s æœ‰å¥½ç”¨çš„ autoscaling åŠŸèƒ½ï¼Œä½†ä½ çŸ¥é“é™¤äº† pod ä¹‹å¤–ï¼Œnode ä¹Ÿå¯ä»¥ auto scaling å—ï¼Ÿå¸¥ï¼Œä½ çŸ¥é“å°±ä¸ç”¨åˆ†äº«äº†å•Š ğŸš¬\næœ¬æ–‡ä»¥é‡é»æ•´ç†çš„æ–¹å¼ï¼Œå…ˆä»‹ç´¹ç›®å‰å¸¸è¦‹çš„ Autoscalerï¼Œå†ä»‹ç´¹ä¸€äº›é˜²æ­¢ pod è¢«äº‚æ®ºçš„ configã€‚\nï¼ˆæ’°æ–¼ 2020-03-23ï¼ŒåŸºæ–¼ Kubernetes 1.17ï¼Œä½† Api Versions å¤ªå¤šè«‹è‡ªè¡ŒæŸ¥é–±æ‰‹å†Šï¼‰\nè®“æˆ‘å€‘æ­¡è¿ç¬¬ä¸€ä½ Autoscaler å‡ºå ´ï¼\nCluster Autoscalerï¼ˆCAï¼‰ è² è²¬èª¿æ•´ node-pool çš„ node size scalingï¼Œå±¬æ–¼ cluster level autoscalerã€‚\n ç™½è©±æ–‡ï¼šé–‹æ–°æ©Ÿå™¨ï¼Œé—œæ²’è·¯ç”¨çš„æ©Ÿå™¨ ğŸ˜ˆ\n  Scale-upï¼š æœ‰ pod çš„ç‹€æ…‹æ˜¯ unschedulable æ™‚ Scale-downï¼š è§€å¯Ÿ pod ç¸½å…±çš„ memory/CPU request æ˜¯å¦ å¯è¨­å®š min/maxi poolsizeï¼ˆGKEï¼‰ï¼Œè‡ªå·±ç®¡ç†çš„å¢é›†å¯ä»¥è¨­å®šæ›´å¤šåƒæ•¸ æœƒåƒç…§ PriorityClass ä¾†èª¿æ§ podï¼Œä½†å°±æ˜¯åƒ…åƒ…è¨­ç«‹ä¸€æ¢è²§çª®æˆªæ­¢ç·šï¼Œç•¶å‰æ˜¯ -10 ï¼Œautoscaler ä¸æœƒå› ç‚ºä½æ–¼æ­¤ç·šçš„ pod è€Œå» scale-upï¼Œéœ€è¦ scale-down ä¹Ÿä¸æœƒç†æœƒ node è£¡é¢æ˜¯å¦æœ‰é€™ç¨® pod éƒ¨åˆ†è¨­å®šè¨­ä¸å¥½æœƒè®“ CA æ²’è¾¦æ³• scaling  CA è¦é—œ node ç„¶å¾Œ evict pod æ™‚é•å pod affinity/anti-affinity å’Œ PodDisruptionBudget åœ¨ node åŠ ä¸Š annotation å¯é˜²æ­¢è¢« scale downï¼š\"cluster-autoscaler.kubernetes.io/scale-down-disabled\": \"true\"   ç†è«–ä¸Š CA å¾ˆå¿«ï¼Œé è¨­ç™¼ç¾ unschedulable 10 ç§’å°± scale-upï¼Œç“¶é ¸æœƒåœ¨ Node provisionï¼ˆé–‹æ©Ÿå™¨ï¼‰éœ€è¦æ•¸åˆ†é˜ âš ï¸ GKE è‹¥è¦ enable CAï¼Œæœƒè®“ K8s master æš«åœé‡é–‹ï¼Œä¸å¯ä¸è¬¹æ… âš ï¸ æ‰‹å‹•æ›´æ”¹ autoscalable node-pool çš„ node label ç­‰æ¬„ä½æœƒæ‰ï¼Œå› ç‚ºä¿®æ”¹ä¸æœƒå‚³æ’­åˆ° node template  Horizontal Pod Autoscalerï¼ˆHPAï¼‰ ç®¡ç† pod æ•¸é‡çš„ autoscalerï¼Œå±¬æ–¼ pod levelï¼ŒåŒæ™‚ä¹Ÿæ˜¯ä¸€ç¨® K8s API resourceã€‚\n ç™½è©±æ–‡ï¼šè‡ªå‹•å¢æ¸› replica æ•¸é‡\n  Scale-upï¼š æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±å¢åŠ  deployment çš„ replicas Scale-downï¼š æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±æ¸›å°‘ deployment çš„ replicas åœ¨ scale up/down ä¹‹å¾Œéƒ½æœƒç­‰å€‹ä¸‰äº”åˆ†é˜ç©©å®šå¾Œï¼Œå†é–‹å§‹æª¢æŸ¥ metricï¼ˆå¦‚æœçªç„¶çˆ†æ¼²æ‡‰è©²ä¾†ä¸åŠï¼Ÿï¼‰ å¯ä»¥è¨­å®š custom/external metrics ä¾†è§¸ç™¼ autoscaling âš ï¸ v2beta2 ä»¥ä¸Šçš„ HPA æ‰æœ‰ metrics å¯ä»¥æª¢æŸ¥ï¼Œv1 åªèƒ½æª¢æŸ¥ CPU utilization  ç›®å‰ hpa.spec æœ‰ä»¥ä¸‹çš„ fieldsï¼š\n maxReplicasï¼šæ©ï¼Œå­—é¢ä¸Šçš„æ„æ€ minReplicasï¼šautoscaler å¯ä»¥è¨­å®šçš„æœ€å° replicas å€¼ï¼Œé è¨­ç‚º 1 scaleTargetRefï¼šè¦ scale çš„ resourceï¼Œé€šå¸¸è¨­å®šç‚º deployment ç­‰ schedulerï¼ˆstatefulset ä¸è¡Œï¼‰ metricsï¼šè¨­å®š scaling è¦æª¢æŸ¥çš„ metricsï¼Œè·Ÿ metrics.k8s.io é€™äº› API object æœ‰é—œï¼Œå¯è¨­å®š  Resourceï¼š ç›®æ¨™è³‡æºçš„ Memory/CPU ç­‰ï¼Œé€šå¸¸é€é metrics-server å»ºç«‹ Podï¼š pod ä¸Šçš„ metricsï¼Œä¸åŒçš„æ˜¯ Resource é å…ˆå®šç¾©å¥½äº†ï¼Œä½† Pod å‰‡æ˜¯å¯ä»¥è€Œå¤–å‚­ custom.metrics.k8s.io API ä¾†å®šç¾© Objectï¼š å’Œ Pod é¡ä¼¼ï¼Œæ˜¯å…¶ä»–åœ¨åŒå€‹ namespace ä¸‹é¢çš„ Resource Object çš„ metricsï¼Œä¾‹å¦‚ Ingress hit-per-seconds Externalï¼š å¤–éƒ¨çš„ metricsï¼Œä¾‹å¦‚ load balancerï¼Œæˆ‘å€‘å¯ä»¥é€é prometheus-adapter å°‡ Prometheus çš„ metrics æ ¼å¼è½‰æ›ç‚º metrics API çš„æ ¼å¼ï¼Œæ‰€ä»¥å¤§è†½å‘å¤–æ±‚æ´å§    å¦‚æœæƒ³ç©ç© HPAï¼Œè«‹åƒè€ƒå®˜æ–¹æ–‡ä»¶èµ°éä¸€éï¼Œä½†åƒè¬ä¸è¦åœ¨æ­£å¼ç’°å¢ƒäº‚ç© ğŸ˜ˆã€‚\n å»çœ‹äº† Kuberentes ç¾åœ¨æœ‰ä»€éº¼ stable metricsï¼Œå¾—åˆ°ä»¥ä¸‹ç­”æ¡ˆï¼Œå¸¥\n Vertical Pod Autoscalerï¼ˆVPAï¼‰ è‡ªå‹•æ¨è–¦ä¸¦è¨­å®šæœ€é©åˆ deployment pod çš„ resource requests/limits è¨­å®šï¼ˆæœ€ä½è³‡æºéœ€æ±‚å’Œå¯ç”¨è³‡æºä¸Šé™ï¼‰ï¼Œä¸éœ€è¦å† runtime ç›£æ§é€éäººå·¥èª¿æ•´åˆ°æ­£ç¢ºçš„ CPU/Memoryã€‚\n ç™½è©±æ–‡ï¼šæ˜¯ä¸€å€‹èƒ½è§£æ”¾ä½ çš„ç”Ÿç”¢åŠ›çš„æ¨è–¦ç³»çµ±å•¦\n  Scale-upï¼š æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±æ¸›å°‘ deployment çš„ pod template çš„ resources.requestsï¼Œå†é€éé‡å•Ÿ pod å¯¦éš›æ›´æ–° Scale-downï¼š æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±æ¸›å°‘ deployment çš„ pod template çš„ resources.requestsï¼Œå†é€éé‡å•Ÿ pod å¯¦éš›æ›´æ–° æ˜¯ä¸€å€‹ CRDï¼ˆCustom Resource Definition objectï¼‰ VPA ä¸æœƒæ›´å‹• resources.limitï¼Œäº‹å¯¦ä¸Šï¼Œåœ¨ç•¶å‰ MVP æ˜¯å°‡ limit è¨­å®šç‚º infinity VPA çš„æ”¹å‹•æœƒåƒè€ƒè©² pod çš„ historic dataï¼ˆå—¯ï¼Œå¾ˆæœ‰è‡ªå­¸èƒ½åŠ›ï¼‰ GKE å¯ä»¥ä¸€éµå•Ÿç”¨ï¼Œä½†æ˜¯ API version æ”¹è®Šä¹Ÿè¦é€é google cloud âš ï¸ VPA ç›®å‰ä¸è©²è·Ÿ HPA ä¸€èµ·ç”¨ï¼ˆVPA 0.7.1ï¼‰ï¼Œé™¤é HPA ç”¨äº† custom metric ä¾†è§¸ç™¼ âš ï¸ å°ï¼Œä½ ç™¼ç¾äº†ä¸€å®šè¦é‡å•Ÿ pod æ‰æœƒæ›´æ–°ï¼Œé€™æ˜¯ç•¶å‰ VPA çš„é™åˆ¶ï¼Œå¦‚æœå—ä¸é³¥å°±æš«æ™‚å…ˆåˆ¥ç”¨å§ âš ï¸ ç›®å‰å’Œ JVM æœ‰é»ä¸æ­ï¼Œå› ç‚º JVM éš±åŒ¿ç—…æƒ…ä¸å…¬é–‹é€æ˜  ç›®å‰ vpa.spec æœ‰ä»¥ä¸‹å¹¾å€‹ fieldsï¼š\n targetRefï¼š è¦èª¿æ•´çš„ resourceï¼Œé€šå¸¸è¨­å®šç‚º deployment ç­‰ schedulerï¼ˆstatefulset ä¸è¡Œï¼‰ updatePolicyï¼šæœƒå¦‚ä½•èª¿ç¯€ Podï¼Œç¸½å…±æœ‰ä¸‰ç¨®æ¨¡å¼ï¼Œä½†å…¶å¯¦ä½ å¯¦éš›åªæœƒç”¨åˆ° Recreate  Offï¼šé—œï¼Œå¯ç”¨ä¾† dry-run Initialï¼š åªæœƒåœ¨ pod creation æ˜¯æŒ‡æ´¾è³‡æºï¼Œä¹‹å¾Œæ•´å€‹ç”Ÿå‘½é€±æœŸéƒ½æ²’ autoscaler çš„äº‹ Recreateï¼š æœƒé€é delete/recreate ä¾†èª¿ç¯€ pod æ•´å€‹ç”Ÿå‘½é€±æœŸçš„ resources Autoï¼šè‡ªå‹•ç”¨ä»»ä½• updatePolicy ä¾†åšäº‹ï¼Œç›®å‰ç­‰æ–¼ Recreate   resourcePolicy.containerPoliciesï¼š æ±ºå®š autoscaler å¦‚ä½•å°ç‰¹å®š container è¨ˆç®—è³‡æºç”¨é‡ï¼Œæ˜¯ä¸€å€‹ array of structï¼Œæœ‰å¹¾å€‹ field  containerNameï¼šæƒ³å°å“ªå€‹ container é–‹åˆ€ modeï¼šæœ‰ Auto æˆ– Off ä¾†æ±ºå®šæ˜¯å¦å°è©² container autoscale minAllowedï¼šæ¨è–¦è³‡æºç”¨é‡çš„æœ€ä½é™åº¦ maxAllowedï¼šæ¨è–¦è³‡æºç”¨é‡çš„æœ€é«˜é™åº¦    å› ç‚ºæ–‡ä»¶æ›´æ–°å¤ªæ…¢ï¼Œå»ºè­°ç›´æ¥çœ‹ VPA çš„ source code ä¾†çœ‹åˆ°åº•æ€éº¼ç”¨ï¼Œæˆ–æ˜¯çœ‹ Google çš„æ–‡ä»¶ï¼Œæ­¤å¤– GKE å¯ä»¥ä¸€éµé–‹å•Ÿ VPAï¼Œbeta ç‰ˆçš„åŠŸèƒ½å…¬é–‹å‡ºä¾†é‚„ä¸åŠ  beta tagï¼Œè†½å¤§åŒ…é’å¤©ã€‚\nç•¶ç„¶ï¼Œå¦‚æœä½ å°å¯¦ä½œç´°ç¯€å’Œå¦‚ä½•æ¨è–¦å¾ˆæœ‰èˆˆè¶£çš„è©±ï¼Œä¹Ÿå¯ä»¥çœ‹æœ€åˆçš„ design proposalã€‚\nå¦‚ä½•è®“è©²æ­»çš„ Pod æ­»æ‰ï¼Œä¸è©²æ­»çš„ Pod æ™šé»æ­» ä»¥ä¸Šæ˜¯ Autoscaler çš„ä»‹ç´¹ï¼Œä½†ç„¡è«– scale pod æˆ– nodeï¼Œéƒ½å¯èƒ½æ®ºæ‰éƒ¨åˆ†çš„ podï¼Œç‚ºäº†ä¿æŒç¶²è·¯ç©©å®šï¼Œæˆ–æ˜¯æŸäº›æœå‹™éœ€è¦å®šé‡çš„ replica set å­˜æ´»ï¼ˆä¾‹å¦‚ç”¨åˆ° raft å…±è­˜æ¼”ç®—æ³•çš„æœå‹™ï¼‰ï¼Œæˆ‘å€‘éœ€è¦ä¸€äº›è¨­å®šï¼Œè®“ pod ä¸æœƒé•·åœ¨ä¸è©²é•·çš„ nodeï¼Œä¹Ÿä¸æœƒæ­»å¾—ä¸æ˜ä¸ç™½ã€‚\nPod Resources Rquests and Limits K8s æ±ºå®š Pod æ”¾åœ¨å“ªï¼Œæœ‰ä¸€å€‹è¦é»ï¼šå“ªå€‹ Node çš„è³‡æºå¤ å°±å¾€å“ªæ”¾ã€‚å˜Ÿå˜Ÿå¥½ï¼Œpod.spec å¯ä»¥è¨­å®š container éœ€è¦å¤šå°‘é‹ç®—è³‡æºï¼ˆCPUã€Memory ç­‰ï¼‰ï¼š\n containers[].resources.requestsï¼šå°±æ˜¯ minimumï¼Œè©²å®¹å™¨ã€Œè‡³å°‘éœ€è¦å¤šå°‘è³‡æºã€ containers[].resources.limitsï¼šå°±æ˜¯ maximumï¼Œè©² å®¹å™¨ã€Œè‡³å¤šå¯ä½¿ç”¨å¤šå°‘è³‡æºã€  Scheduler æœƒæŒ‰ç…§ resources.requests æ±ºå®š pod è¦æ”¾åœ¨å“ªï¼Œä¸€å€‹ node ä¸Šé¢æ‰€æœ‰ pod containers çš„ requests ç¸½å’Œä¸èƒ½è¶…éè©² node æä¾›çš„é‹ç®—è³‡æºç¸½é‡ï¼Œå¦å‰‡æ–° Pod æœƒæ”¾ä¸ä¸Šå»è©² nodeã€‚\né‚£æƒ³çŸ¥é“ limits æ€éº¼è¨ˆç®—çš„å—ï¼Ÿä½ ä¸æƒ³çŸ¥é“ä½†æˆ‘é‚„æ˜¯è¦èªªï¼šä¸åŒçš„ container runtime çµ±è¨ˆé‹ç®—è³‡æºä½¿ç”¨é‡çš„æ–¹å¼å„ç•°ï¼Œä»¥æœ€å¸¸è¦‹çš„ Docker ä¾†èªªï¼ŒCPU ç”¨é‡æ˜¯ã€Œæ¯ 100ms è©² container ä½”ç”¨å¤šå°‘ CPU timeã€ä¾†æ±ºå®šï¼Œè€Œ Memory ç”¨é‡å‰‡æ˜¯ç”¨ docker run çš„ --memory ä¾†é™åˆ¶ï¼Œè©³æƒ…è«‹åƒé–±å®˜æ–¹æ‰‹å†Šã€‚\né€™è£¡å·ä¸€ä¸‹ Sysdig çš„åœ–ï¼Œè¦–è¦ºåŒ–ä¾†ç†è§£ resources requestsï¼š\nimage from Sysdig: Understanding Kubernetes limits and requests by example\nç¸½è€Œè¨€ä¹‹ï¼Œåœ¨ Pod è¦è¢« schedule åˆ° nodeï¼Œéƒ½æœƒåƒè€ƒé€™äº›è¨­å®šä¾†èª¿æ§ï¼ŒCluster Autoscaler ä¹Ÿä¸ä¾‹å¤–ï¼Œå¦‚æœç™¼ç¾ Autoscaler é‹ä½œä¸èƒ½ï¼Œæª¢æŸ¥ä¸€ä¸‹é€™äº›è¨­å®šï¼Œç„¶å¾Œè¨˜å¾— requests = ä¸‹é™ï¼Œlimit = ä¸Šé™æº–æ²’éŒ¯ã€‚\n è¦é™åˆ¶é‹ç®—è³‡æºä½¿ç”¨ï¼Œé‚„æœ‰ ResourceQuotaï¼ˆé™åˆ¶ namespace è³‡æºä½¿ç”¨ï¼‰å’Œ LimitRangeï¼ˆï¼‰é€™å…©å€‹ API Resources å¯ç”¨ï¼Œç”šè‡³å¯ä»¥ç®¡ç† storageï¼Œä½†è¨­å®šæœ‰äº›è¤‡é›œï¼ŒæŒ‰ä¸‹ä¸è¡¨ã€‚\nç„¶å¾Œ GKE æœƒå¹«ä½ äº‚åŠ  ResourceQuotaï¼ŒGoogle é«’é«’ã€‚\n Pod Disruption Budgetï¼ˆPDBï¼‰ PDB å­—é¢ä¸Šæ„æ€æ˜¯ã€ŒPod çš„å´©æ½°é ç®—ã€ï¼Œèªªç©¿äº†ï¼Œå°±æ˜¯è¨­å®šPod é‡åˆ°äº‹æ•…æ™‚è‡³å°‘è¦æ´»å¹¾å€‹å’Œè‡³å¤šèƒ½æ­»å¹¾å€‹ã€‚ é‚„æœ‰æ©Ÿæˆ¿å°åŸ SRE é€²ä¸å»é‡é–‹ æˆ‘å€‘å…ˆä¾†å®šç¾©ã€Œäº‹æ•…ã€ã€‚èˆ‰å‡¡ç³»çµ±ç•¶æ©Ÿã€æ©Ÿæˆ¿æ–·é›»ã€æµ·åº•é›»çºœè¢«é¯Šé­šå’¬ï¼Œæˆ–æ˜¯å°åŸ SRE ç„¡æ³•é€²å»é‡é–‹æ©Ÿï¼Œé€™äº›å¯èƒ½æœƒé€ æˆæ©Ÿå™¨ææ¯€çš„äº‹æ•…éƒ½æ˜¯ä¸€ç¨® disruptionï¼Œä½†é€™äº›æ˜¯ã€Œéè‡ªé¡˜æ€§äº‹æ•…ã€ã€‚ç•¶ç„¶ï¼ŒK8s ç®¡ç†å“¡æƒ³è¦ scale down ä¸€å€‹ node ä¾†ç¶­è­·æˆ–æ˜¯çœéŒ¢ä¹Ÿæ˜¯ä¸€ç¨®äº‹æ•…ï¼Œé€™ç¨®å°±æ˜¯ã€Œè‡ªé¡˜æ€§äº‹æ•…ã€ï¼ŒPDB å°±æ˜¯ç‚ºäº†é˜²æ­¢ç®¡ç†å“¡é‚£å¤©æ™šä¸Šå–äº†å¤ªå¤šé…’ä¸å°å¿ƒä¸€æ¬¡ drain å¤ªå¤š node çš„æœ€å¾Œä¸€é“å®‰å…¨é–ã€‚\nPDB æœ‰ä¸‹åˆ—å¹¾å€‹ fieldsï¼š\n maxUnavailableï¼šæ©ï¼Œå‰›å‰›è¬›éï¼Œæœ€å¤šèƒ½æ­»å¹¾å€‹ pod minAvailableï¼šè‡³å°‘è¦æœ‰å¹¾å€‹å­˜æ´» selectorï¼šé€™å€‹ä½ ä¸çŸ¥é“è‡ªå·± kubectl explain pdb.spec.selector å§ ğŸ’©  è¬›èµ·ä¾† PDB å¾ˆç°¡å–®ï¼Œä½†å…¶å¯¦å®ƒéå¸¸å¯¦ç”¨ï¼Œå¿…é ˆç´°ç´°å“åšï¼Œä¾‹å¦‚ä½ æœ‰å€‹ç”¨äº† distributed serviceï¼Œç”±æ–¼é€™ç¨®ç”¨äº†å…±è­˜æ¼”ç®—æ³•çš„æœå‹™ qurorum éƒ½éœ€è¦æœ‰ä¸€å®šæ•¸é‡ï¼ˆä¾‹å¦‚ 3ï¼‰ï¼Œæ‰€ä»¥ä½ å¯èƒ½é¸æ“‡å° StatefulSet çš„ pod è¨­å®š minAvailable: 3ï¼›æˆ–æ˜¯ä½ ç™¼ç¾ä½ æ ¹æœ¬ä¸èƒ½æ­»ä»»ä½•ä¸€å€‹æœå‹™ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¨­å®š maxUnavailable: 0ï¼Œé€™æ¨£ K8s ç®¡ç†å“¡ç™¼ç¾æ²’è¾¦æ³• drain node çš„æ™‚å€™å°±æœƒä¾†æ‰¾ä½ ï¼Œä½ å°±å¯ä»¥å¥½å¥½è¦åŠƒæ‰‹å‹•èª¿æ•´ï¼Œä¸€èµ· DevOps æƒ¹ã€‚\nPod Affinity/Anti-Affinity Affinityï¼Œè¦ªå’Œæ€§ï¼Œå¦‚ water affinity æ˜¯è¦ªæ°´æ€§ï¼ŒPod affinity ä»£è¡¨ã€ŒPod æœƒè¶¨æ–¼è¢«å®‰ç½®åœ¨å“ªä¸€å€‹ nodeã€ï¼Œanti-affinity å‰‡åä¹‹ã€‚\nPod å¯ä»¥è¨­å®šå…©ç¨® affinityï¼šNode Affinity å’Œ Pod Affinityã€‚\n Node Affinityï¼š é€éå„ç¨® expressionï¼ˆorã€andã€in ç­‰ï¼‰é¸æ“‡ä¸åŒçš„ node ä¾†å®‰ç½® podï¼Œå¯¦éš›ä¸Šå°±æ˜¯å¼·åŒ–ç‰ˆçš„ node selectorï¼Œä½†å¯ä»¥è¨­å®šå„ç¨®ã€Œrequiredã€æˆ–ã€Œpreferredã€å±¬æ€§æ±ºå®šæ¢ä»¶æ˜¯å¦å¿…é ˆã€‚ Pod Affinityï¼š é€™æ˜¯è·¨ pod çš„ affinityï¼Œè¨­å®šä¸Šå’Œ Node Affinity é¡ä¼¼ï¼Œæ›å¥è©±èªªå°±æ˜¯ï¼šé€™å€‹ pod A å·²ç¶“åœ¨é€™å€‹ Node ä¸Šé¢è·‘äº†ï¼Œæ‰€ä»¥ pod B æ ¹æ“š podAffinity çš„è¨­å®šä¹Ÿè¦ï¼ˆæˆ–ä¸è¦ï¼‰åœ¨é€™å€‹ node ä¸Šé¢è·‘ã€‚  ç”±æ–¼ Pod Affinity é‚„æœ‰ä¸€å€‹ topologyKey å¯ä»¥æŒ‡å®š Node labelï¼Œè®“ affinity é™åˆ¶åœ¨æœ‰åŒä¸€å€‹ label çš„ node ä¸Šé¢é‹ä½œï¼Œé€™å€‹ topologyKey å› ç‚ºå¯¦ä½œä¸Šå®‰å…¨æ€§å’Œæ•ˆèƒ½è€ƒé‡ï¼Œæœ‰è«¸å¤šé™åˆ¶ï¼Œè«‹è©³é–±å…¬é–‹èªªæ˜æ›¸ã€‚\n  âš ï¸ ç›®å‰å¯¦ä½œä¸Šï¼Œé…åˆ CA ä½¿ç”¨å¯èƒ½é€ æˆ CA æ…¢ä¸‰å€‹æ•¸é‡ç´šï¼Œä¸”è¨­å®šä¸å¥½å¯èƒ½ç„¡æ³• scale downï¼Œè«‹æ³¨æ„ å…¶å¯¦é‚„æœ‰å’Œ affinity ç›¸åçš„ taint/tolerationï¼Œæœƒç¢ºèª Pod ä¸åœ¨ç‰¹å®šçš„ Node ä¸Šå®‰ç½®ï¼Œæœ‰æ©Ÿæœƒå†è«‡   Pod Priority and Preemption äººæœ‰è²§å¯Œè²´è³¤ï¼Œè€Œ SRE æœ€è³¤ï¼ŒPod ç•¶ç„¶ä¹Ÿä¸ä¾‹å¤–ï¼Œæˆ‘å€‘å¯ä»¥é€é PriorityClass é€™å€‹ API resourceï¼Œè®“ä¸€äº› Pod å°±æ˜¯æ¯”å…¶ä»– Pod é‚„é«˜è²´ï¼ˆæˆ–ä½è³¤ï¼‰ã€‚\nç•¶è¨­å®š pod.spec.priorityClassName å¾Œï¼Œé€™å€‹ pod å°±ç²å¾—éšç´šèº«åˆ†ï¼Œå¦‚æœé‡ä¸Šäº†æœ‰äº› pod æ²’è¾¦æ³• schedule åˆ° node ä¸Šï¼ŒpriorityClass è¼ƒä½çš„ pod å°±æœƒè¢«è¿«è¸¢å‡º nodeï¼Œè®“é«˜ç´šçš„ pod å…ˆ scheduleï¼Œå°±æ˜¯é€™éº¼ç¾å¯¦ã€‚\n PriorityClass å’Œ StorageClass ä¸€æ¨£ï¼Œæ˜¯ non-namspaced çš„è³‡æº priorityclass.valueï¼šæ˜¯ä¸€å€‹ integerï¼Œè¶Šé«˜è¶Šå„ªå…ˆ priorityclass.preemptionPolicyï¼šæ˜¯å¦èƒ½å¤ æ“ æ‰ç¾æœ‰çš„ pod  Neverï¼šåªèƒ½æ¶æ’éšŠåœ¨ Pending ä½†é‚„æ²’ schedule çš„ pod å‰é¢å…ˆè¢«å®‰ç½® PreemptLowerPriorityï¼šæ¯”è¼ƒå…‡ï¼Œæœƒå˜—è©¦å¹¹æ‰å·²ç¶“ scheduled çš„ä½é †ä½ pod   NonPreemptingPriority feature gate åœ¨ 1.15 æˆªæ­¢ 1.17 éƒ½é‚„åœ¨ Alphaï¼Œé è¨­ false å’Œ QoSï¼ˆç”± pod resources.requests/limits çµ„åˆå‡ºä¾†ï¼‰æ˜¯æ­£äº¤é—œä¿‚ï¼Œäº’ç›¸å½±éŸ¿ç¨‹åº¦ä½ âš ï¸ PriorityClass å° PDB çš„æ”¯æ´æ˜¯ã€Œç›¡å…¶æ‰€èƒ½ã€ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨éœ€è¦ evict pod æ™‚ï¼Œæœƒç›¡åŠ›å»æ‰¾å¯èƒ½ç¬¦åˆ PDB çš„å—å®³è€…ï¼Œä½†å¦‚æœæ²’æ‰¾åˆ°ï¼Œä½é †ä½çš„ pod é‚„æ˜¯æœƒè¢«å¹¹æ‰   äº‹å¯¦ä¸Š k8s æœ‰é è¨­å…©å€‹ PriorityClassï¼Œå°ˆé–€çµ¦ K8s æ ¸å¿ƒå…ƒä»¶ï¼ŒåŸå‰‡ä¸Šä¸è¦ä»»æ„å‹•åˆ°é€™äº› PriorityClassï¼Œä¹Ÿä¸è¦æ¶ä»–å€‘çš„è³‡æºã€‚\n å°çµ æ„Ÿè¬æ‚¨è€å¿ƒçœ‹å®Œé€™ç¯‡å†—æ–‡ï¼Œä¾†ç¸½è¤‡ç¿’ä¸€ä¸‹ï¼š\n Cluster Autoscaler æ§åˆ¶å¢æ¸› node æ©Ÿå™¨ï¼Œèˆ’æœ Horizontal Pod Autoscaler æ§åˆ¶ deployment çš„ replicas æ•¸é‡ï¼Œèˆ’æœ Verticla Pod Autoscaler æ§åˆ¶ deployment çš„ resource requests/limit æ•¸ï¼Œèˆ’æœ å„˜é‡è¨­å®š Pod resources requests èˆ‡ limitï¼Œä½†é€™ä»£è¡¨è¦ç†Ÿæ‚‰ app ä½¿ç”¨è³‡æºå¤šå¯¡ï¼Œé™¤éç”¨ VPA Pod Disruption Budget æ˜¯ä½ æœ€å¾Œä¸€é“é–ï¼Œå‹™å¿…è¨­å®š è‹¥æœå‹™éœ€è¦å¼· HAï¼ˆè·¨ region/zoneã€æˆ–è·¨ä¸åŒå¯¦é«”æ©Ÿæˆ¿ï¼‰ï¼Œè«‹è¨­å®š (anti-)affinity å¦‚æœä½ æœ‰äº› app é«˜äººä¸€ç­‰ï¼Œéå¸¸éå¸¸é‡è¦ï¼Œé‡è¦åˆ°å¯ä»¥æŠŠåˆ¥äººçš„ pod å¹¹æ‰ï¼Œè«‹è¨­å®š PriorityClass  åˆ‡è¨˜ï¼Œè‹¥è¦æ¸¬è©¦ autoscalingï¼Œåƒè¬æ³¨æ„ç•¶å‰åœ¨å“ªå€‹ cluster contextï¼Œåˆ¥èªªæˆ‘æ²’æé†’ï¼Œå°å¿ƒå¼„å£äº†æ­£å¼ç’°å¢ƒçš„ Kubernetes cluster ğŸ˜ˆã€‚\nReferences  K8s Doc - Horizontal Pod Autoscaler K8s Doc - Manage Compute Resources for Containers K8s Doc - Disruptions K8s Doc - Assign Pods to Nodes K8s Doc - Pod Priority and Preemption GitHub - Cluster Autoscaler FAQ GitHub - Vertical Pod Autoscaler GKE - Cluster autoscaler GKE - Vertical Pod Autoscaler  ","wordCount":"4443","inLanguage":"en","datePublished":"2020-03-23T00:00:00+08:00","dateModified":"2020-03-23T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weihanglo.tw/posts/2020/k8s-autoscaling/"},"publisher":{"@type":"Organization","name":"Weihang Lo","logo":{"@type":"ImageObject","url":"https://weihanglo.tw/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://weihanglo.tw accesskey=h title="Weihang Lo (Alt + H)">Weihang Lo</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://weihanglo.tw/ title=Home>
<span>Home</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://weihanglo.tw/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Kuberenetes Autoscaling ç›¸é—œçŸ¥è­˜å°æ•´ç†
</h1>
<div class=post-meta><span title="2020-03-23 00:00:00 +0800 +0800">March 23, 2020</span>&nbsp;Â·&nbsp;9 min
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#cluster-autoscalercahttpsgithubcomkubernetesautoscalertreemastercluster-autoscaler aria-label="Cluster Autoscalerï¼ˆCAï¼‰"><a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler>Cluster Autoscalerï¼ˆCAï¼‰</a></a></li>
<li>
<a href=#horizontal-pod-autoscalerhpahttpskubernetesiodocstasksrun-applicationhorizontal-pod-autoscale aria-label="Horizontal Pod Autoscalerï¼ˆHPAï¼‰"><a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/>Horizontal Pod Autoscalerï¼ˆHPAï¼‰</a></a></li>
<li>
<a href=#vertical-pod-autoscalervpahttpsgithubcomkubernetesautoscalerblobmastervertical-pod-autoscalerpkgapisautoscalingk8siov1beta2typesgo aria-label="Vertical Pod Autoscalerï¼ˆVPAï¼‰"><a href=https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/pkg/apis/autoscaling.k8s.io/v1beta2/types.go>Vertical Pod Autoscalerï¼ˆVPAï¼‰</a></a></li>
<li>
<a href=#%e5%a6%82%e4%bd%95%e8%ae%93%e8%a9%b2%e6%ad%bb%e7%9a%84-pod-%e6%ad%bb%e6%8e%89%e4%b8%8d%e8%a9%b2%e6%ad%bb%e7%9a%84-pod-%e6%99%9a%e9%bb%9e%e6%ad%bb aria-label="å¦‚ä½•è®“è©²æ­»çš„ Pod æ­»æ‰ï¼Œä¸è©²æ­»çš„ Pod æ™šé»æ­»">å¦‚ä½•è®“è©²æ­»çš„ Pod æ­»æ‰ï¼Œä¸è©²æ­»çš„ Pod æ™šé»æ­»</a><ul>
<li>
<a href=#pod-resources-rquests-and-limits aria-label="Pod Resources Rquests and Limits">Pod Resources Rquests and Limits</a></li>
<li>
<a href=#pod-disruption-budgetpdb aria-label="Pod Disruption Budgetï¼ˆPDBï¼‰">Pod Disruption Budgetï¼ˆPDBï¼‰</a></li>
<li>
<a href=#pod-affinityanti-affinity aria-label="Pod Affinity/Anti-Affinity">Pod Affinity/Anti-Affinity</a></li>
<li>
<a href=#pod-priority-and-preemption aria-label="Pod Priority and Preemption">Pod Priority and Preemption</a></li></ul>
</li>
<li>
<a href=#%e5%b0%8f%e7%b5%90 aria-label=å°çµ>å°çµ</a></li>
<li>
<a href=#references aria-label=References>References</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>K8s æœ‰å¥½ç”¨çš„ autoscaling åŠŸèƒ½ï¼Œä½†ä½ çŸ¥é“é™¤äº† pod ä¹‹å¤–ï¼Œnode ä¹Ÿå¯ä»¥ auto scaling å—ï¼Ÿå¸¥ï¼Œä½ çŸ¥é“å°±ä¸ç”¨åˆ†äº«äº†å•Š ğŸš¬</p>
<p>æœ¬æ–‡ä»¥é‡é»æ•´ç†çš„æ–¹å¼ï¼Œå…ˆä»‹ç´¹ç›®å‰å¸¸è¦‹çš„ Autoscalerï¼Œå†ä»‹ç´¹ä¸€äº›é˜²æ­¢ pod è¢«äº‚æ®ºçš„ configã€‚</p>
<p><em>ï¼ˆæ’°æ–¼ 2020-03-23ï¼ŒåŸºæ–¼ Kubernetes 1.17ï¼Œä½† Api Versions å¤ªå¤šè«‹è‡ªè¡ŒæŸ¥é–±æ‰‹å†Šï¼‰</em></p>
<p>è®“æˆ‘å€‘æ­¡è¿ç¬¬ä¸€ä½ Autoscaler å‡ºå ´ï¼</p>
<h2 id=cluster-autoscalercahttpsgithubcomkubernetesautoscalertreemastercluster-autoscaler><a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler>Cluster Autoscalerï¼ˆCAï¼‰</a><a hidden class=anchor aria-hidden=true href=#cluster-autoscalercahttpsgithubcomkubernetesautoscalertreemastercluster-autoscaler>#</a></h2>
<p>è² è²¬èª¿æ•´ node-pool çš„ node size scalingï¼Œå±¬æ–¼ cluster level autoscalerã€‚</p>
<blockquote>
<p>ç™½è©±æ–‡ï¼šé–‹æ–°æ©Ÿå™¨ï¼Œé—œæ²’è·¯ç”¨çš„æ©Ÿå™¨ ğŸ˜ˆ</p>
</blockquote>
<ul>
<li><a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-up-work><strong>Scale-upï¼š</strong></a> æœ‰ pod çš„ç‹€æ…‹æ˜¯ <code>unschedulable</code> æ™‚</li>
<li><a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-down-work><strong>Scale-downï¼š</strong></a> è§€å¯Ÿ pod ç¸½å…±çš„ memory/CPU request æ˜¯å¦ &lt; 50%ï¼ˆéçœŸå¯¦çš„ resource utilizationï¼‰+ æ²’æœ‰å…¶ä»– pod/node çš„æ¢ä»¶é™åˆ¶</li>
<li>å¯è¨­å®š min/maxi poolsizeï¼ˆGKEï¼‰ï¼Œè‡ªå·±ç®¡ç†çš„å¢é›†å¯ä»¥<a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca>è¨­å®šæ›´å¤šåƒæ•¸</a></li>
<li>æœƒåƒç…§ PriorityClass ä¾†èª¿æ§ podï¼Œä½†å°±æ˜¯åƒ…åƒ…è¨­ç«‹ä¸€æ¢<del>è²§çª®</del>æˆªæ­¢ç·šï¼Œç•¶å‰æ˜¯ <code>-10</code> ï¼Œautoscaler ä¸æœƒå› ç‚ºä½æ–¼æ­¤ç·šçš„ pod è€Œå» scale-upï¼Œéœ€è¦ scale-down ä¹Ÿä¸æœƒç†æœƒ node è£¡é¢æ˜¯å¦æœ‰é€™ç¨® pod</li>
<li>éƒ¨åˆ†è¨­å®šè¨­ä¸å¥½æœƒè®“ CA æ²’è¾¦æ³• scaling
<ul>
<li>CA è¦é—œ node ç„¶å¾Œ evict pod æ™‚é•å pod affinity/anti-affinity å’Œ PodDisruptionBudget</li>
<li>åœ¨ node åŠ ä¸Š annotation å¯é˜²æ­¢è¢« scale downï¼š<code>"cluster-autoscaler.kubernetes.io/scale-down-disabled": "true"</code></li>
</ul>
</li>
<li>ç†è«–ä¸Š CA å¾ˆå¿«ï¼Œé è¨­ç™¼ç¾ <code>unschedulable</code> 10 ç§’å°± scale-upï¼Œç“¶é ¸æœƒåœ¨ Node provisionï¼ˆé–‹æ©Ÿå™¨ï¼‰éœ€è¦æ•¸åˆ†é˜</li>
<li>âš ï¸ GKE è‹¥è¦ enable CAï¼Œæœƒè®“ K8s master æš«åœé‡é–‹ï¼Œä¸å¯ä¸è¬¹æ…</li>
<li>âš ï¸ æ‰‹å‹•æ›´æ”¹ autoscalable node-pool çš„ node label ç­‰æ¬„ä½æœƒæ‰ï¼Œå› ç‚ºä¿®æ”¹ä¸æœƒå‚³æ’­åˆ° node template</li>
</ul>
<h2 id=horizontal-pod-autoscalerhpahttpskubernetesiodocstasksrun-applicationhorizontal-pod-autoscale><a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/>Horizontal Pod Autoscalerï¼ˆHPAï¼‰</a><a hidden class=anchor aria-hidden=true href=#horizontal-pod-autoscalerhpahttpskubernetesiodocstasksrun-applicationhorizontal-pod-autoscale>#</a></h2>
<p>ç®¡ç† pod æ•¸é‡çš„ autoscalerï¼Œå±¬æ–¼ pod levelï¼ŒåŒæ™‚ä¹Ÿæ˜¯ä¸€ç¨® K8s API resourceã€‚</p>
<blockquote>
<p>ç™½è©±æ–‡ï¼šè‡ªå‹•å¢æ¸› replica æ•¸é‡</p>
</blockquote>
<ul>
<li><strong>Scale-upï¼š</strong> æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±å¢åŠ  deployment çš„ replicas</li>
<li><strong>Scale-downï¼š</strong> æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±æ¸›å°‘ deployment çš„ replicas</li>
<li>åœ¨ scale up/down ä¹‹å¾Œéƒ½æœƒç­‰å€‹ä¸‰äº”åˆ†é˜ç©©å®šå¾Œï¼Œå†é–‹å§‹æª¢æŸ¥ metricï¼ˆå¦‚æœçªç„¶çˆ†æ¼²æ‡‰è©²ä¾†ä¸åŠï¼Ÿï¼‰</li>
<li>å¯ä»¥è¨­å®š custom/external metrics ä¾†è§¸ç™¼ autoscaling</li>
<li>âš ï¸ v2beta2 ä»¥ä¸Šçš„ HPA æ‰æœ‰ metrics å¯ä»¥æª¢æŸ¥ï¼Œv1 åªèƒ½æª¢æŸ¥ CPU utilization</li>
</ul>
<p><img loading=lazy src=https://d33wubrfki0l68.cloudfront.net/4fe1ef7265a93f5f564bd3fbb0269ebd10b73b4e/1775d/images/docs/horizontal-pod-autoscaler.svg alt>
</p>
<p>ç›®å‰ <code>hpa.spec</code> æœ‰ä»¥ä¸‹çš„ fieldsï¼š</p>
<ul>
<li><code>maxReplicas</code>ï¼šæ©ï¼Œå­—é¢ä¸Šçš„æ„æ€</li>
<li><code>minReplicas</code>ï¼šautoscaler å¯ä»¥è¨­å®šçš„æœ€å° replicas å€¼ï¼Œé è¨­ç‚º 1</li>
<li><code>scaleTargetRef</code>ï¼šè¦ scale çš„ resourceï¼Œé€šå¸¸è¨­å®šç‚º deployment ç­‰ schedulerï¼ˆstatefulset ä¸è¡Œï¼‰</li>
<li><code>metrics</code>ï¼šè¨­å®š scaling è¦æª¢æŸ¥çš„ metricsï¼Œè·Ÿ <code>metrics.k8s.io</code> é€™äº› API object æœ‰é—œï¼Œå¯è¨­å®š
<ol>
<li><strong>Resourceï¼š</strong> ç›®æ¨™è³‡æºçš„ Memory/CPU ç­‰ï¼Œé€šå¸¸é€é metrics-server å»ºç«‹</li>
<li><strong>Podï¼š</strong> pod ä¸Šçš„ metricsï¼Œä¸åŒçš„æ˜¯ Resource é å…ˆå®šç¾©å¥½äº†ï¼Œä½† Pod å‰‡æ˜¯å¯ä»¥è€Œå¤–å‚­ <code>custom.metrics.k8s.io</code> API ä¾†å®šç¾©</li>
<li><strong>Objectï¼š</strong> å’Œ Pod é¡ä¼¼ï¼Œæ˜¯å…¶ä»–åœ¨åŒå€‹ namespace ä¸‹é¢çš„ Resource Object çš„ metricsï¼Œä¾‹å¦‚ Ingress hit-per-seconds</li>
<li><strong>Externalï¼š</strong> å¤–éƒ¨çš„ metricsï¼Œä¾‹å¦‚ load balancerï¼Œæˆ‘å€‘å¯ä»¥é€é <a href=https://github.com/DirectXMan12/k8s-prometheus-adapter>prometheus-adapter</a> å°‡ Prometheus çš„ metrics æ ¼å¼è½‰æ›ç‚º metrics API çš„æ ¼å¼ï¼Œæ‰€ä»¥å¤§è†½å‘å¤–æ±‚æ´å§</li>
</ol>
</li>
</ul>
<p>å¦‚æœæƒ³ç©ç© HPAï¼Œè«‹åƒè€ƒ<a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough>å®˜æ–¹æ–‡ä»¶èµ°éä¸€é</a>ï¼Œä½†åƒè¬ä¸è¦åœ¨æ­£å¼ç’°å¢ƒäº‚ç© ğŸ˜ˆã€‚</p>
<blockquote>
<p>å»çœ‹äº† Kuberentes ç¾åœ¨æœ‰ä»€éº¼ stable metricsï¼Œå¾—åˆ°ä»¥ä¸‹ç­”æ¡ˆï¼Œå¸¥</p>
</blockquote>
<p><img loading=lazy src=https://media2.giphy.com/media/cKmfTuhx0kyu1e6BkL/giphy.gif alt>
</p>
<h2 id=vertical-pod-autoscalervpahttpsgithubcomkubernetesautoscalerblobmastervertical-pod-autoscalerpkgapisautoscalingk8siov1beta2typesgo><a href=https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/pkg/apis/autoscaling.k8s.io/v1beta2/types.go>Vertical Pod Autoscalerï¼ˆVPAï¼‰</a><a hidden class=anchor aria-hidden=true href=#vertical-pod-autoscalervpahttpsgithubcomkubernetesautoscalerblobmastervertical-pod-autoscalerpkgapisautoscalingk8siov1beta2typesgo>#</a></h2>
<p>è‡ªå‹•æ¨è–¦ä¸¦è¨­å®šæœ€é©åˆ deployment pod çš„ resource requests/limits è¨­å®šï¼ˆæœ€ä½è³‡æºéœ€æ±‚å’Œå¯ç”¨è³‡æºä¸Šé™ï¼‰ï¼Œä¸éœ€è¦å† runtime ç›£æ§é€éäººå·¥èª¿æ•´åˆ°æ­£ç¢ºçš„ CPU/Memoryã€‚</p>
<blockquote>
<p>ç™½è©±æ–‡ï¼šæ˜¯ä¸€å€‹èƒ½è§£æ”¾ä½ çš„ç”Ÿç”¢åŠ›çš„æ¨è–¦ç³»çµ±å•¦</p>
</blockquote>
<ul>
<li><strong>Scale-upï¼š</strong> æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±æ¸›å°‘ deployment çš„ pod template çš„ resources.requestsï¼Œå†é€éé‡å•Ÿ pod å¯¦éš›æ›´æ–°</li>
<li><strong>Scale-downï¼š</strong> æª¢æŸ¥ metricsï¼Œç™¼ç¾éäº† threshold å°±æ¸›å°‘ deployment çš„ pod template çš„ resources.requestsï¼Œå†é€éé‡å•Ÿ pod å¯¦éš›æ›´æ–°</li>
<li>æ˜¯ä¸€å€‹ CRDï¼ˆ<a href=https://kubernetes.io/docs/concepts/api-extension/custom-resources/>Custom Resource Definition object</a>ï¼‰</li>
<li>VPA ä¸æœƒæ›´å‹• <code>resources.limit</code>ï¼Œäº‹å¯¦ä¸Šï¼Œåœ¨ç•¶å‰ MVP <a href=https://github.com/kubernetes/community/blob/a358faf/contributors/design-proposals/autoscaling/vertical-pod-autoscaler.md#recommendation-model>æ˜¯å°‡ limit è¨­å®šç‚º infinity</a></li>
<li>VPA çš„æ”¹å‹•æœƒåƒè€ƒè©² pod çš„ historic dataï¼ˆå—¯ï¼Œå¾ˆæœ‰è‡ªå­¸èƒ½åŠ›ï¼‰</li>
<li>GKE å¯ä»¥ä¸€éµå•Ÿç”¨ï¼Œä½†æ˜¯ API version æ”¹è®Šä¹Ÿè¦é€é google cloud</li>
<li>âš ï¸ VPA ç›®å‰ä¸è©²è·Ÿ HPA ä¸€èµ·ç”¨ï¼ˆVPA 0.7.1ï¼‰ï¼Œé™¤é <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-custom-metrics>HPA ç”¨äº† custom metric ä¾†è§¸ç™¼</a></li>
<li>âš ï¸ å°ï¼Œä½ ç™¼ç¾äº†ä¸€å®šè¦é‡å•Ÿ pod æ‰æœƒæ›´æ–°ï¼Œé€™æ˜¯ç•¶å‰ VPA çš„é™åˆ¶ï¼Œå¦‚æœå—ä¸é³¥å°±æš«æ™‚å…ˆåˆ¥ç”¨å§</li>
<li>âš ï¸ ç›®å‰å’Œ JVM æœ‰é»ä¸æ­ï¼Œå› ç‚º JVM éš±åŒ¿ç—…æƒ…ä¸å…¬é–‹é€æ˜</li>
</ul>
<p>ç›®å‰ <code>vpa.spec</code> æœ‰ä»¥ä¸‹å¹¾å€‹ fieldsï¼š</p>
<ul>
<li><code>targetRef</code>ï¼š è¦èª¿æ•´çš„ resourceï¼Œé€šå¸¸è¨­å®šç‚º deployment ç­‰ schedulerï¼ˆstatefulset ä¸è¡Œï¼‰</li>
<li><code>updatePolicy</code>ï¼šæœƒå¦‚ä½•èª¿ç¯€ Podï¼Œç¸½å…±æœ‰ä¸‰ç¨®æ¨¡å¼ï¼Œä½†å…¶å¯¦ä½ å¯¦éš›åªæœƒç”¨åˆ° Recreate
<ul>
<li><code>Off</code>ï¼šé—œï¼Œå¯ç”¨ä¾† dry-run</li>
<li><code>Initial</code>ï¼š åªæœƒåœ¨ pod creation æ˜¯æŒ‡æ´¾è³‡æºï¼Œä¹‹å¾Œæ•´å€‹ç”Ÿå‘½é€±æœŸéƒ½æ²’ autoscaler çš„äº‹</li>
<li><code>Recreate</code>ï¼š æœƒé€é delete/recreate ä¾†èª¿ç¯€ pod æ•´å€‹ç”Ÿå‘½é€±æœŸçš„ resources</li>
<li><code>Auto</code>ï¼šè‡ªå‹•ç”¨ä»»ä½• updatePolicy ä¾†åšäº‹ï¼Œç›®å‰ç­‰æ–¼ <code>Recreate</code></li>
</ul>
</li>
<li><code>resourcePolicy.containerPolicies</code>ï¼š æ±ºå®š autoscaler å¦‚ä½•å°ç‰¹å®š container è¨ˆç®—è³‡æºç”¨é‡ï¼Œæ˜¯ä¸€å€‹ array of structï¼Œæœ‰å¹¾å€‹ field
<ul>
<li><code>containerName</code>ï¼šæƒ³å°å“ªå€‹ container é–‹åˆ€</li>
<li><code>mode</code>ï¼šæœ‰ <code>Auto</code> æˆ– <code>Off</code> ä¾†æ±ºå®šæ˜¯å¦å°è©² container autoscale</li>
<li><code>minAllowed</code>ï¼šæ¨è–¦è³‡æºç”¨é‡çš„æœ€ä½é™åº¦</li>
<li><code>maxAllowed</code>ï¼šæ¨è–¦è³‡æºç”¨é‡çš„æœ€é«˜é™åº¦</li>
</ul>
</li>
</ul>
<p>å› ç‚ºæ–‡ä»¶æ›´æ–°å¤ªæ…¢ï¼Œå»ºè­°ç›´æ¥çœ‹ <a href=https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/pkg/apis/autoscaling.k8s.io/v1beta2/types.go>VPA çš„ source code</a> ä¾†çœ‹åˆ°åº•æ€éº¼ç”¨ï¼Œæˆ–æ˜¯çœ‹ <a href=https://cloud.google.com/kubernetes-engine/docs/concepts/verticalpodautoscaler>Google çš„æ–‡ä»¶</a>ï¼Œæ­¤å¤– GKE å¯ä»¥ä¸€éµé–‹å•Ÿ VPAï¼Œbeta ç‰ˆçš„åŠŸèƒ½å…¬é–‹å‡ºä¾†é‚„ä¸åŠ  beta tagï¼Œè†½å¤§åŒ…é’å¤©ã€‚</p>
<p>ç•¶ç„¶ï¼Œå¦‚æœä½ å°å¯¦ä½œç´°ç¯€å’Œå¦‚ä½•æ¨è–¦å¾ˆæœ‰èˆˆè¶£çš„è©±ï¼Œä¹Ÿå¯ä»¥çœ‹æœ€åˆçš„ <a href=https://github.com/kubernetes/community/blob/a358faf/contributors/design-proposals/autoscaling/vertical-pod-autoscaler.md>design proposal</a>ã€‚</p>
<p><img loading=lazy src=https://i.imgur.com/Nr68ZyD.png alt>
</p>
<h2 id=å¦‚ä½•è®“è©²æ­»çš„-pod-æ­»æ‰ä¸è©²æ­»çš„-pod-æ™šé»æ­»>å¦‚ä½•è®“è©²æ­»çš„ Pod æ­»æ‰ï¼Œä¸è©²æ­»çš„ Pod æ™šé»æ­»<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•è®“è©²æ­»çš„-pod-æ­»æ‰ä¸è©²æ­»çš„-pod-æ™šé»æ­»>#</a></h2>
<p>ä»¥ä¸Šæ˜¯ Autoscaler çš„ä»‹ç´¹ï¼Œä½†ç„¡è«– scale pod æˆ– nodeï¼Œéƒ½å¯èƒ½æ®ºæ‰éƒ¨åˆ†çš„ podï¼Œç‚ºäº†ä¿æŒç¶²è·¯ç©©å®šï¼Œæˆ–æ˜¯æŸäº›æœå‹™éœ€è¦å®šé‡çš„ replica set å­˜æ´»ï¼ˆä¾‹å¦‚ç”¨åˆ° raft å…±è­˜æ¼”ç®—æ³•çš„æœå‹™ï¼‰ï¼Œæˆ‘å€‘éœ€è¦ä¸€äº›è¨­å®šï¼Œè®“ pod ä¸æœƒé•·åœ¨ä¸è©²é•·çš„ nodeï¼Œä¹Ÿä¸æœƒæ­»å¾—ä¸æ˜ä¸ç™½ã€‚</p>
<h3 id=pod-resources-rquests-and-limits>Pod Resources Rquests and Limits<a hidden class=anchor aria-hidden=true href=#pod-resources-rquests-and-limits>#</a></h3>
<p>K8s æ±ºå®š Pod æ”¾åœ¨å“ªï¼Œæœ‰ä¸€å€‹è¦é»ï¼š<strong>å“ªå€‹ Node çš„è³‡æºå¤ å°±å¾€å“ªæ”¾</strong>ã€‚å˜Ÿå˜Ÿå¥½ï¼Œ<code>pod.spec</code> å¯ä»¥è¨­å®š container éœ€è¦å¤šå°‘é‹ç®—è³‡æºï¼ˆCPUã€Memory ç­‰ï¼‰ï¼š</p>
<ul>
<li><code>containers[].resources.requests</code>ï¼šå°±æ˜¯ <strong>minimum</strong>ï¼Œè©²å®¹å™¨ã€Œè‡³å°‘éœ€è¦å¤šå°‘è³‡æºã€</li>
<li><code>containers[].resources.limits</code>ï¼šå°±æ˜¯ <strong>maximum</strong>ï¼Œè©² å®¹å™¨ã€Œè‡³å¤šå¯ä½¿ç”¨å¤šå°‘è³‡æºã€</li>
</ul>
<p>Scheduler æœƒæŒ‰ç…§ <code>resources.requests</code> æ±ºå®š pod è¦æ”¾åœ¨å“ªï¼Œä¸€å€‹ node ä¸Šé¢æ‰€æœ‰ pod containers çš„ requests ç¸½å’Œä¸èƒ½è¶…éè©² node æä¾›çš„é‹ç®—è³‡æºç¸½é‡ï¼Œå¦å‰‡æ–° Pod æœƒæ”¾ä¸ä¸Šå»è©² nodeã€‚</p>
<p>é‚£æƒ³çŸ¥é“ <code>limits</code> æ€éº¼è¨ˆç®—çš„å—ï¼Ÿä½ ä¸æƒ³çŸ¥é“ä½†æˆ‘é‚„æ˜¯è¦èªªï¼šä¸åŒçš„ container runtime çµ±è¨ˆé‹ç®—è³‡æºä½¿ç”¨é‡çš„æ–¹å¼å„ç•°ï¼Œä»¥æœ€å¸¸è¦‹çš„ Docker ä¾†èªªï¼ŒCPU ç”¨é‡æ˜¯ã€Œæ¯ 100ms è©² container ä½”ç”¨å¤šå°‘ CPU timeã€ä¾†æ±ºå®šï¼Œè€Œ Memory ç”¨é‡å‰‡æ˜¯ç”¨ <a href=https://docs.docker.com/engine/reference/run/#runtime-constraints-on-resources><code>docker run</code> çš„ <code>--memory</code></a> ä¾†é™åˆ¶ï¼Œè©³æƒ…è«‹<a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>åƒé–±å®˜æ–¹æ‰‹å†Š</a>ã€‚</p>
<p>é€™è£¡å·ä¸€ä¸‹ Sysdig çš„åœ–ï¼Œè¦–è¦ºåŒ–ä¾†ç†è§£ resources requestsï¼š</p>
<p><img loading=lazy src=https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/uploads/image11.png alt>
</p>
<p><em>image from Sysdig: <a href=https://sysdig.com/blog/kubernetes-limits-requests/>Understanding Kubernetes limits and requests by example</a></em></p>
<p>ç¸½è€Œè¨€ä¹‹ï¼Œåœ¨ Pod è¦è¢« schedule åˆ° nodeï¼Œéƒ½æœƒåƒè€ƒé€™äº›è¨­å®šä¾†èª¿æ§ï¼ŒCluster Autoscaler ä¹Ÿä¸ä¾‹å¤–ï¼Œå¦‚æœç™¼ç¾ Autoscaler é‹ä½œä¸èƒ½ï¼Œæª¢æŸ¥ä¸€ä¸‹é€™äº›è¨­å®šï¼Œç„¶å¾Œè¨˜å¾— <strong>requests = ä¸‹é™</strong>ï¼Œ<strong>limit = ä¸Šé™</strong>æº–æ²’éŒ¯ã€‚</p>
<blockquote>
<p>è¦é™åˆ¶é‹ç®—è³‡æºä½¿ç”¨ï¼Œé‚„æœ‰ <a href=https://kubernetes.io/docs/concepts/policy/resource-quotas/><code>ResourceQuota</code></a>ï¼ˆé™åˆ¶ namespace è³‡æºä½¿ç”¨ï¼‰å’Œ <a href=https://kubernetes.io/docs/concepts/policy/limit-range/><code>LimitRange</code></a>ï¼ˆï¼‰é€™å…©å€‹ API Resources å¯ç”¨ï¼Œç”šè‡³å¯ä»¥ç®¡ç† storageï¼Œä½†è¨­å®šæœ‰äº›è¤‡é›œï¼ŒæŒ‰ä¸‹ä¸è¡¨ã€‚</p>
<p>ç„¶å¾Œ <a href=https://cloud.google.com/kubernetes-engine/quotas>GKE æœƒå¹«ä½ äº‚åŠ  ResourceQuota</a>ï¼ŒGoogle é«’é«’ã€‚</p>
</blockquote>
<h3 id=pod-disruption-budgetpdb>Pod Disruption Budgetï¼ˆPDBï¼‰<a hidden class=anchor aria-hidden=true href=#pod-disruption-budgetpdb>#</a></h3>
<p>PDB å­—é¢ä¸Šæ„æ€æ˜¯ã€ŒPod çš„å´©æ½°é ç®—ã€ï¼Œèªªç©¿äº†ï¼Œå°±æ˜¯è¨­å®šPod é‡åˆ°<strong>äº‹æ•…</strong>æ™‚<strong>è‡³å°‘è¦æ´»å¹¾å€‹</strong>å’Œ<strong>è‡³å¤šèƒ½æ­»å¹¾å€‹</strong>ã€‚
é‚„æœ‰æ©Ÿæˆ¿å°åŸ SRE é€²ä¸å»é‡é–‹
æˆ‘å€‘å…ˆä¾†å®šç¾©ã€Œäº‹æ•…ã€ã€‚èˆ‰å‡¡ç³»çµ±ç•¶æ©Ÿã€æ©Ÿæˆ¿æ–·é›»ã€æµ·åº•é›»çºœè¢«é¯Šé­šå’¬ï¼Œæˆ–æ˜¯å°åŸ SRE ç„¡æ³•é€²å»é‡é–‹æ©Ÿï¼Œé€™äº›å¯èƒ½æœƒé€ æˆæ©Ÿå™¨ææ¯€çš„äº‹æ•…éƒ½æ˜¯ä¸€ç¨® disruptionï¼Œä½†é€™äº›æ˜¯ã€Œéè‡ªé¡˜æ€§äº‹æ•…ã€ã€‚ç•¶ç„¶ï¼ŒK8s ç®¡ç†å“¡æƒ³è¦ scale down ä¸€å€‹ node ä¾†ç¶­è­·æˆ–æ˜¯çœéŒ¢ä¹Ÿæ˜¯ä¸€ç¨®äº‹æ•…ï¼Œé€™ç¨®å°±æ˜¯ã€Œè‡ªé¡˜æ€§äº‹æ•…ã€ï¼ŒPDB å°±æ˜¯ç‚ºäº†é˜²æ­¢ç®¡ç†å“¡é‚£å¤©æ™šä¸Šå–äº†å¤ªå¤šé…’ä¸å°å¿ƒä¸€æ¬¡ drain å¤ªå¤š node çš„<strong>æœ€å¾Œä¸€é“å®‰å…¨é–</strong>ã€‚</p>
<p>PDB æœ‰ä¸‹åˆ—å¹¾å€‹ fieldsï¼š</p>
<ul>
<li><code>maxUnavailable</code>ï¼šæ©ï¼Œå‰›å‰›è¬›éï¼Œæœ€å¤šèƒ½æ­»å¹¾å€‹ pod</li>
<li><code>minAvailable</code>ï¼šè‡³å°‘è¦æœ‰å¹¾å€‹å­˜æ´»</li>
<li><code>selector</code>ï¼šé€™å€‹ä½ ä¸çŸ¥é“è‡ªå·± <code>kubectl explain pdb.spec.selector</code> å§ ğŸ’©</li>
</ul>
<p>è¬›èµ·ä¾† PDB å¾ˆç°¡å–®ï¼Œä½†å…¶å¯¦å®ƒéå¸¸å¯¦ç”¨ï¼Œå¿…é ˆç´°ç´°å“åšï¼Œä¾‹å¦‚ä½ æœ‰å€‹ç”¨äº† distributed serviceï¼Œç”±æ–¼é€™ç¨®ç”¨äº†å…±è­˜æ¼”ç®—æ³•çš„æœå‹™ qurorum éƒ½éœ€è¦æœ‰ä¸€å®šæ•¸é‡ï¼ˆä¾‹å¦‚ 3ï¼‰ï¼Œæ‰€ä»¥ä½ å¯èƒ½é¸æ“‡å° StatefulSet çš„ pod è¨­å®š <code>minAvailable: 3</code>ï¼›æˆ–æ˜¯ä½ ç™¼ç¾ä½ æ ¹æœ¬ä¸èƒ½æ­»ä»»ä½•ä¸€å€‹æœå‹™ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¨­å®š <code>maxUnavailable: 0</code>ï¼Œé€™æ¨£ K8s ç®¡ç†å“¡ç™¼ç¾æ²’è¾¦æ³• drain node çš„æ™‚å€™å°±æœƒä¾†æ‰¾ä½ ï¼Œä½ å°±å¯ä»¥å¥½å¥½è¦åŠƒæ‰‹å‹•èª¿æ•´ï¼Œä¸€èµ· DevOps æƒ¹ã€‚</p>
<h3 id=pod-affinityanti-affinity>Pod Affinity/Anti-Affinity<a hidden class=anchor aria-hidden=true href=#pod-affinityanti-affinity>#</a></h3>
<p>Affinityï¼Œè¦ªå’Œæ€§ï¼Œå¦‚ water affinity æ˜¯è¦ªæ°´æ€§ï¼ŒPod affinity ä»£è¡¨ã€ŒPod æœƒè¶¨æ–¼è¢«å®‰ç½®åœ¨å“ªä¸€å€‹ nodeã€ï¼Œanti-affinity å‰‡åä¹‹ã€‚</p>
<p>Pod å¯ä»¥è¨­å®šå…©ç¨® affinityï¼šNode Affinity å’Œ Pod Affinityã€‚</p>
<ul>
<li><strong>Node Affinityï¼š</strong> é€éå„ç¨® expressionï¼ˆorã€andã€in ç­‰ï¼‰é¸æ“‡ä¸åŒçš„ node ä¾†å®‰ç½® podï¼Œå¯¦éš›ä¸Šå°±æ˜¯å¼·åŒ–ç‰ˆçš„ node selectorï¼Œä½†å¯ä»¥è¨­å®šå„ç¨®ã€Œrequiredã€æˆ–ã€Œpreferredã€å±¬æ€§æ±ºå®šæ¢ä»¶æ˜¯å¦å¿…é ˆã€‚</li>
<li><strong>Pod Affinityï¼š</strong> é€™æ˜¯è·¨ pod çš„ affinityï¼Œè¨­å®šä¸Šå’Œ Node Affinity é¡ä¼¼ï¼Œæ›å¥è©±èªªå°±æ˜¯ï¼šé€™å€‹ pod A å·²ç¶“åœ¨é€™å€‹ Node ä¸Šé¢è·‘äº†ï¼Œæ‰€ä»¥ pod B æ ¹æ“š podAffinity çš„è¨­å®šä¹Ÿè¦ï¼ˆæˆ–ä¸è¦ï¼‰åœ¨é€™å€‹ node ä¸Šé¢è·‘ã€‚</li>
</ul>
<p>ç”±æ–¼ Pod Affinity é‚„æœ‰ä¸€å€‹ <code>topologyKey</code> å¯ä»¥æŒ‡å®š Node labelï¼Œè®“ affinity é™åˆ¶åœ¨æœ‰åŒä¸€å€‹ label çš„ node ä¸Šé¢é‹ä½œï¼Œé€™å€‹ <code>topologyKey</code> å› ç‚ºå¯¦ä½œä¸Šå®‰å…¨æ€§å’Œæ•ˆèƒ½è€ƒé‡ï¼Œæœ‰è«¸å¤šé™åˆ¶ï¼Œè«‹è©³é–±<a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>å…¬é–‹èªªæ˜æ›¸</a>ã€‚</p>
<blockquote>
<ul>
<li>âš ï¸ ç›®å‰å¯¦ä½œä¸Šï¼Œé…åˆ CA ä½¿ç”¨å¯èƒ½<a href=https://github.com/kubernetes/autoscaler/blob/2933517/cluster-autoscaler/FAQ.md#what-are-the-service-level-objectives-for-cluster-autoscaler>é€ æˆ CA æ…¢ä¸‰å€‹æ•¸é‡ç´š</a>ï¼Œä¸”è¨­å®šä¸å¥½å¯èƒ½ç„¡æ³• scale downï¼Œè«‹æ³¨æ„</li>
<li>å…¶å¯¦é‚„æœ‰å’Œ affinity ç›¸åçš„ <a href=https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/>taint/toleration</a>ï¼Œæœƒç¢ºèª Pod ä¸åœ¨ç‰¹å®šçš„ Node ä¸Šå®‰ç½®ï¼Œæœ‰æ©Ÿæœƒå†è«‡</li>
</ul>
</blockquote>
<h3 id=pod-priority-and-preemption>Pod Priority and Preemption<a hidden class=anchor aria-hidden=true href=#pod-priority-and-preemption>#</a></h3>
<p>äººæœ‰è²§å¯Œè²´è³¤ï¼Œ<del>è€Œ SRE æœ€è³¤</del>ï¼ŒPod ç•¶ç„¶ä¹Ÿä¸ä¾‹å¤–ï¼Œæˆ‘å€‘å¯ä»¥é€é PriorityClass é€™å€‹ API resourceï¼Œè®“ä¸€äº› Pod å°±æ˜¯æ¯”å…¶ä»– Pod é‚„é«˜è²´ï¼ˆæˆ–ä½è³¤ï¼‰ã€‚</p>
<p>ç•¶è¨­å®š <code>pod.spec.priorityClassName</code> å¾Œï¼Œé€™å€‹ pod å°±ç²å¾—éšç´šèº«åˆ†ï¼Œå¦‚æœé‡ä¸Šäº†æœ‰äº› pod æ²’è¾¦æ³• schedule åˆ° node ä¸Šï¼ŒpriorityClass è¼ƒä½çš„ pod å°±æœƒè¢«è¿«è¸¢å‡º nodeï¼Œè®“é«˜ç´šçš„ pod å…ˆ scheduleï¼Œå°±æ˜¯é€™éº¼ç¾å¯¦ã€‚</p>
<ul>
<li>PriorityClass å’Œ StorageClass ä¸€æ¨£ï¼Œæ˜¯ non-namspaced çš„è³‡æº</li>
<li><code>priorityclass.value</code>ï¼šæ˜¯ä¸€å€‹ integerï¼Œè¶Šé«˜è¶Šå„ªå…ˆ</li>
<li><code>priorityclass.preemptionPolicy</code>ï¼šæ˜¯å¦èƒ½å¤ æ“ æ‰ç¾æœ‰çš„ pod
<ul>
<li><code>Never</code>ï¼šåªèƒ½æ¶æ’éšŠåœ¨ Pending ä½†é‚„æ²’ schedule çš„ pod å‰é¢å…ˆè¢«å®‰ç½®</li>
<li><code>PreemptLowerPriority</code>ï¼šæ¯”è¼ƒå…‡ï¼Œæœƒå˜—è©¦å¹¹æ‰å·²ç¶“ scheduled çš„ä½é †ä½ pod</li>
</ul>
</li>
<li><a href=https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/><code>NonPreemptingPriority</code> feature gate</a> åœ¨ 1.15 æˆªæ­¢ 1.17 éƒ½é‚„åœ¨ Alphaï¼Œé è¨­ <code>false</code></li>
<li>å’Œ <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md>QoS</a>ï¼ˆç”± pod resources.requests/limits çµ„åˆå‡ºä¾†ï¼‰æ˜¯æ­£äº¤é—œä¿‚ï¼Œäº’ç›¸å½±éŸ¿ç¨‹åº¦ä½</li>
<li>âš ï¸ PriorityClass å° PDB çš„æ”¯æ´æ˜¯ã€Œç›¡å…¶æ‰€èƒ½ã€ï¼Œä¹Ÿå°±æ˜¯èªªåœ¨éœ€è¦ evict pod æ™‚ï¼Œæœƒç›¡åŠ›å»æ‰¾å¯èƒ½ç¬¦åˆ PDB çš„å—å®³è€…ï¼Œä½†å¦‚æœæ²’æ‰¾åˆ°ï¼Œä½é †ä½çš„ pod é‚„æ˜¯æœƒè¢«å¹¹æ‰</li>
</ul>
<blockquote>
<p>äº‹å¯¦ä¸Š k8s æœ‰é è¨­å…©å€‹ PriorityClassï¼Œå°ˆé–€çµ¦ K8s æ ¸å¿ƒå…ƒä»¶ï¼ŒåŸå‰‡ä¸Šä¸è¦ä»»æ„å‹•åˆ°<a href=https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/#interactions-of-pod-priority-and-qos>é€™äº› PriorityClass</a>ï¼Œä¹Ÿä¸è¦æ¶ä»–å€‘çš„è³‡æºã€‚</p>
</blockquote>
<h2 id=å°çµ>å°çµ<a hidden class=anchor aria-hidden=true href=#å°çµ>#</a></h2>
<p>æ„Ÿè¬æ‚¨è€å¿ƒçœ‹å®Œé€™ç¯‡å†—æ–‡ï¼Œä¾†ç¸½è¤‡ç¿’ä¸€ä¸‹ï¼š</p>
<ol>
<li>Cluster Autoscaler æ§åˆ¶å¢æ¸› node æ©Ÿå™¨ï¼Œèˆ’æœ</li>
<li>Horizontal Pod Autoscaler æ§åˆ¶ deployment çš„ replicas æ•¸é‡ï¼Œèˆ’æœ</li>
<li>Verticla Pod Autoscaler æ§åˆ¶ deployment çš„ resource requests/limit æ•¸ï¼Œèˆ’æœ</li>
<li>å„˜é‡è¨­å®š Pod resources requests èˆ‡ limitï¼Œä½†é€™ä»£è¡¨è¦ç†Ÿæ‚‰ app ä½¿ç”¨è³‡æºå¤šå¯¡ï¼Œé™¤éç”¨ VPA</li>
<li>Pod Disruption Budget æ˜¯ä½ æœ€å¾Œä¸€é“é–ï¼Œå‹™å¿…è¨­å®š</li>
<li>è‹¥æœå‹™éœ€è¦å¼· HAï¼ˆè·¨ region/zoneã€æˆ–è·¨ä¸åŒå¯¦é«”æ©Ÿæˆ¿ï¼‰ï¼Œè«‹è¨­å®š (anti-)affinity</li>
<li>å¦‚æœä½ æœ‰äº› app é«˜äººä¸€ç­‰ï¼Œéå¸¸éå¸¸é‡è¦ï¼Œé‡è¦åˆ°å¯ä»¥æŠŠåˆ¥äººçš„ pod å¹¹æ‰ï¼Œè«‹è¨­å®š PriorityClass</li>
</ol>
<p>åˆ‡è¨˜ï¼Œè‹¥è¦æ¸¬è©¦ autoscalingï¼Œåƒè¬æ³¨æ„ç•¶å‰åœ¨å“ªå€‹ cluster contextï¼Œåˆ¥èªªæˆ‘æ²’æé†’ï¼Œå°å¿ƒå¼„å£äº†æ­£å¼ç’°å¢ƒçš„ Kubernetes cluster ğŸ˜ˆã€‚</p>
<h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2>
<ul>
<li><a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/>K8s Doc - Horizontal Pod Autoscaler</a></li>
<li><a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>K8s Doc - Manage Compute Resources for Containers</a></li>
<li><a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/>K8s Doc - Disruptions</a></li>
<li><a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/>K8s Doc - Assign Pods to Nodes</a></li>
<li><a href=https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption>K8s Doc - Pod Priority and Preemption</a></li>
<li><a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md>GitHub - Cluster Autoscaler FAQ</a></li>
<li><a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler>GitHub - Vertical Pod Autoscaler</a></li>
<li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler>GKE - Cluster autoscaler</a></li>
<li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/verticalpodautoscaler>GKE - Vertical Pod Autoscaler</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://weihanglo.tw/tags/kubernetes/>Kubernetes</a></li>
<li><a href=https://weihanglo.tw/tags/devops/>DevOps</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://weihanglo.tw/posts/2020/www-0x0a/>
<span class=title>Â« Prev Page</span>
<br>
<span>WWW 0x0A: å—¯ï¼Œä½ é€™å¡Š 0xDEADBEEF</span>
</a>
<a class=next href=https://weihanglo.tw/posts/2020/www-0x09/>
<span class=title>Next Page Â»</span>
<br>
<span>WWW 0x09: åˆ°åº•è¦ä¸è¦æ“”å¿ƒ blocking</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>CC BY-NC-SA 4.0</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>