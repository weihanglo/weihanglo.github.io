<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="你的 function 是什麼顏色？
 這裡是 WWW 第參期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Using Rust in Windows 相較於 Microsoft 近期在 Rust 社群動作不斷，這篇文章相對平實，不過也藏了許多有趣事實。
 Microsoft 覺得 Cargo 不能容易配合既有的 build system，這個其實和 Google 使用 Bazel 和 Facebook 自己搞 tool 一樣，超巨頭的工作環境太特殊了。不過也提及正在與社群接觸，微軟真的開始關注 Rust 了。 提到了 Rust 很適合做 C 的 safe wrapper，其實這個也是官方死靈書提及的作法，bindgen 真心方便。 對熟悉 C++ 的開發者而言，Rust 學習成本比想像中低了很多，一兩天配合 Rust 好用的周邊工具就可以寫出 idiomatic Rust，這和 RustConf 2019 上 Facebook 僱員的說法一致。 看到最後才發現作者是 Hyper-V team 成員，再聯想到 AWS 用 Rust 寫的 Firecracker 作為 Fargate 和 Lambda 底層的 micro vm，不難想像這些大公司用 C++寫底層的底層員工生活多苦 。  What Color is Your Function?"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="WWW 0x03: What Color is Your Function? • Weihang Lo"><meta property="og:description" content="你的 function 是什麼顏色？
 這裡是 WWW 第參期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Using Rust in Windows 相較於 Microsoft 近期在 Rust 社群動作不斷，這篇文章相對平實，不過也藏了許多有趣事實。
 Microsoft 覺得 Cargo 不能容易配合既有的 build system，這個其實和 Google 使用 Bazel 和 Facebook 自己搞 tool 一樣，超巨頭的工作環境太特殊了。不過也提及正在與社群接觸，微軟真的開始關注 Rust 了。 提到了 Rust 很適合做 C 的 safe wrapper，其實這個也是官方死靈書提及的作法，bindgen 真心方便。 對熟悉 C++ 的開發者而言，Rust 學習成本比想像中低了很多，一兩天配合 Rust 好用的周邊工具就可以寫出 idiomatic Rust，這和 RustConf 2019 上 Facebook 僱員的說法一致。 看到最後才發現作者是 Hyper-V team 成員，再聯想到 AWS 用 Rust 寫的 Firecracker 作為 Fargate 和 Lambda 底層的 micro vm，不難想像這些大公司用 C++寫底層的底層員工生活多苦 。  What Color is Your Function?"><meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x03/"><meta property="og:site_name" content="Weihang Lo"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Weekly"><meta property="article:tag" content="Asynchronous"><meta property="article:tag" content="System Programming"><meta property="article:published_time" content="2020-02-08T00:00:00+08:00"><meta property="article:modified_time" content="2020-02-08T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>WWW 0x03: What Color is Your Function? • Weihang Lo</title><link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x03/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-posts"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/posts/>Posts</a></li><li class=item><a href=/tags/>Tags</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Weihang Lo</p><p class="desc site-desc"></p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>WWW 0x03: What Color is Your Function?</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-02-08T00:00:00+08:00>2020, Feb 08</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>2 mins read</span></div></div></header><div class="container entry-content"><blockquote><p>你的 function 是什麼顏色？</p></blockquote><p>這裡是 WWW 第參期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p><h2 id=using-rust-in-windowshttpsmsrc-blogmicrosoftcom20191107using-rust-in-windows><a href=https://msrc-blog.microsoft.com/2019/11/07/using-rust-in-windows/>Using Rust in Windows</a></h2><p>相較於 Microsoft 近期在 Rust 社群動作不斷，這篇文章相對平實，不過也藏了許多有趣事實。</p><ol><li>Microsoft 覺得 Cargo 不能容易配合既有的 build system，這個其實和 Google 使用 Bazel 和 Facebook 自己搞 tool 一樣，超巨頭的工作環境太特殊了。不過也提及正在與社群接觸，微軟真的開始關注 Rust 了。</li><li>提到了 Rust 很適合做 C 的 safe wrapper，其實這個也是官方<a href=https://doc.rust-lang.org/nomicon/ffi.html>死靈書提及的作法</a>，<code>bindgen</code> 真心方便。</li><li>對熟悉 C++ 的開發者而言，Rust 學習成本比想像中低了很多，一兩天配合 Rust 好用的周邊工具就可以寫出 idiomatic Rust，這和 RustConf 2019 上 Facebook 僱員的說法一致。</li><li>看到最後才發現作者是 Hyper-V team 成員，再聯想到 AWS 用 Rust 寫的 <a href=https://firecracker-microvm.github.io>Firecracker</a> 作為 Fargate 和 Lambda 底層的 micro vm，不難想像這些大公司<del>用 C++寫底層的底層員工生活多苦</del> 。</li></ol><h2 id=what-color-is-your-functionhttpsjournalstuffwithstuffcom20150201what-color-is-your-function><a href=https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/>What Color is Your Function?</a></h2><p>看起來滿篇幹話，但其實在講一個非常有趣的概念：這個世界被分為兩種 function， synchronous 和 asynchronous。async function 具有感染力，不能在 sync function 內部呼叫，因此，寫程式就要一直把「這個是 sync 那個是 async」的思維放在腦中，不累嗎？</p><p>作者提到了三種語言沒有這個問題：Go、Lua、Ruby。這三種都做了類似 green thread 的實作，所以例如操作 IO 就會 suspend 當前執行環境到 callstack，並 resume 其他 function 和 stack，撰寫程式不再需要刻意分辨 sync/async，寫起來都一樣。</p><p>雖然本文並非 Go 推坑文，但作者和我的想法的十分接近：Go 語言真的很簡單，連非同步都可以當作不知道，反正語言底層幫你解決了。</p><h2 id=200-行以內實作-green-threadhttpscfsamsongitbookiogreen-threads-explained-in-200-lines-of-rust><a href=https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/>200 行以內實作 Green Thread</a></h2><p>Go 的 Goroutine 和 Python 的 Greenlet 滿火熱的，最近來研究一下的實作 Green Thread，剛好看到 C 和 Rust 兩個實作版本，順便紀錄閱讀心得。</p><ul><li><a href=https://bit.ly/33ZdeCE>Rust 線上示範</a></li><li><a href=https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/>Rust 180 行版本（推薦）</a></li><li><a href=https://c9x.me/articles/gthreads/mach.html>C 150 行版本（一樣很棒）</a></li></ul><h3 id=green-thread-不負責任定義>Green Thread 不負責任定義</h3><p>提供在 userspace 的 non-preemptive multitasking，一個可以 yield 將 CPU 控制權讓出，並儲存當前的 context，在未來可以 resume 繼續執行。這種作法常見於 blocking-IO 的場景。</p><blockquote><p>正名一下，Green thread 稍微正式的名字是 coroutine。</p></blockquote><h3 id=要懂-green-thread-的先備知識>要懂 Green Thread 的先備知識</h3><ul><li>ABI 的概念（CPU calling convention）</li><li>CPU 如何管理 call stack</li><li>一些 Assembly（會需要用 asm 於 register 溝通）</li></ul><h3 id=thread-實作重點整理直接看文章比較快>Thread 實作重點整理（直接看文章比較快）</h3><ul><li>x86 會把 function pointer、return address 記錄在 register</li><li>把 function pointer 放到 stack pointer 上 就會執行函式</li><li>有個 <code>Runtime</code> 負責管理每一個 userspace <code>Thread</code></li><li><code>Thread</code> 有個 context，記錄當前 register 的狀態</li><li><code>Runtime</code> 有兩個最重要的 method：<code>yield</code>、<code>spawn</code></li><li><code>Runtime.yield</code> 轉讓 CPU 使用權： 找尋 yielding <code>Thread</code>，記錄當前的 register 狀態到它自己的 context 以便未來 resume，然後將準備執行的 <code>Thread</code> 的 context 寫入 register</li><li><code>Runtime.spawn</code> 啟動一個 thread 執行任務： 傳入任意的函式，將函式指標寫入 context 的特定 offset，這個 offset 對應 x86 ABI 的 stack pointer</li></ul></div><footer class=entry-footer><div class="container sep-before"><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/weekly/>Weekly</a>, <a class=tag href=/tags/asynchronous/>Asynchronous</a>, <a class=tag href=/tags/system-programming/>System Programming</a></div></div><div style=text-align:center;padding-top:2em><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/><img src=https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png alt=cc-by-nc-sa-4></a></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/posts/2020/www-0x02/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>WWW 0x02: Distroless Docker for distressed human</a></div><div class="next-entry sep-before"><a href=/posts/2020/www-0x04/><span class=screen-reader-text>Next post: </span>WWW 0x04: Not feeling the async pressure<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://facebook.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Facebook account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href=https://twitter.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=https://linkedin.com/in/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Telegram icon</title><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2017-2021 Weihang Lo</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script src=/js/custom.js></script></body></html>