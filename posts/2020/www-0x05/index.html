<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="這裡是 WWW 第伍期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Microservices: From Design to Deployment 這是 microservices.io 的作者在 NGINX blog 上面的系列文章，雖然是 2015 年的舊文，從起源、問題，和模式來理解微服務依然詳實，看完絕對驚呼：原來現在 Cloud Native 世界這麼混亂是有些道理！
 Note：不知道為什麼作者很愛提到 Netflix 各種微服務的專案，不過 Netflix 的 Java 開源微服務工具數量之多還真大開眼界
 以下分別摘要每個主題：
Introduction to Microservices 簡介什麼是微服務，有什麼優缺點，並介紹微服務架構下常見元件，鋪陳給接下來的系列文，總之是個不想看可跳過的篇章。
Building Microservices: Using an API Gateway 介紹 API gateway 為什麼存在：統一微服務一致對外的介面，解耦客戶端與微服務們，但缺點是 API gateway 需要更多 operational cost，也要維持 hign availibility。
實作 API gateway 要注意以下幾點：
 Performance：所有請求都會通過 gateway，所以效能和擴充性一定要好 Reactive Programming 模式：gateway 需要集合各種請求，善用 Reactive programming 模式很有幫助 Service Invocation：微服務之間就是 IPC（inter-process communication），如何透過不同模式相互 invoke 很重要，下一章會詳述 Service Discovery：如何讓服務之間互相知道彼此，就是「服務發現」的工作了，分為 client-side 和 service-side discovery，之後有專文說明 Partial Failures：微服務之間不像單體服務可以用簡單的 transaction 處理錯誤並 rollback，處理部分錯誤，保持 CAP 的 consistency 是個重要課題  Building Microservices: Inter‑Process Communication in a Microservices Architecture 介紹微服務間 IPC（inter‑process communication）的方法與模式，這是系列文中最接近實作層面的文章，很棒。"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="WWW 0x05: 若單體服務是屎，微服務就是許多屎 • Weihang Lo"><meta property="og:description" content="這裡是 WWW 第伍期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
Microservices: From Design to Deployment 這是 microservices.io 的作者在 NGINX blog 上面的系列文章，雖然是 2015 年的舊文，從起源、問題，和模式來理解微服務依然詳實，看完絕對驚呼：原來現在 Cloud Native 世界這麼混亂是有些道理！
 Note：不知道為什麼作者很愛提到 Netflix 各種微服務的專案，不過 Netflix 的 Java 開源微服務工具數量之多還真大開眼界
 以下分別摘要每個主題：
Introduction to Microservices 簡介什麼是微服務，有什麼優缺點，並介紹微服務架構下常見元件，鋪陳給接下來的系列文，總之是個不想看可跳過的篇章。
Building Microservices: Using an API Gateway 介紹 API gateway 為什麼存在：統一微服務一致對外的介面，解耦客戶端與微服務們，但缺點是 API gateway 需要更多 operational cost，也要維持 hign availibility。
實作 API gateway 要注意以下幾點：
 Performance：所有請求都會通過 gateway，所以效能和擴充性一定要好 Reactive Programming 模式：gateway 需要集合各種請求，善用 Reactive programming 模式很有幫助 Service Invocation：微服務之間就是 IPC（inter-process communication），如何透過不同模式相互 invoke 很重要，下一章會詳述 Service Discovery：如何讓服務之間互相知道彼此，就是「服務發現」的工作了，分為 client-side 和 service-side discovery，之後有專文說明 Partial Failures：微服務之間不像單體服務可以用簡單的 transaction 處理錯誤並 rollback，處理部分錯誤，保持 CAP 的 consistency 是個重要課題  Building Microservices: Inter‑Process Communication in a Microservices Architecture 介紹微服務間 IPC（inter‑process communication）的方法與模式，這是系列文中最接近實作層面的文章，很棒。"><meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x05/"><meta property="og:site_name" content="Weihang Lo"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Weekly"><meta property="article:tag" content="Microservice"><meta property="article:published_time" content="2020-02-22T00:00:00+08:00"><meta property="article:modified_time" content="2020-02-22T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.3"><title>WWW 0x05: 若單體服務是屎，微服務就是許多屎 • Weihang Lo</title><link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x05/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-posts"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/posts/>Posts</a></li><li class=item><a href=/tags/>Tags</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Weihang Lo</p><p class="desc site-desc"></p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>WWW 0x05: 若單體服務是屎，微服務就是許多屎</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-02-22T00:00:00+08:00>2020, Feb 22</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>2 mins read</span></div></div></header><div class="container entry-content"><p>這裡是 WWW 第伍期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p><h2 id=microservices-from-design-to-deploymenthttpswwwnginxcomblogintroduction-to-microservices><a href=https://www.nginx.com/blog/introduction-to-microservices/>Microservices: From Design to Deployment</a></h2><p><img src=https://i.imgur.com/6uLbuzb.png alt></p><p>這是 <a href=https://microservices.io>microservices.io</a> 的作者在 NGINX blog 上面的系列文章，雖然是 2015 年的舊文，從起源、問題，和模式來理解微服務依然詳實，看完絕對驚呼：原來現在 Cloud Native 世界這麼混亂是有些道理！</p><blockquote><p>Note：不知道為什麼作者很愛提到 Netflix 各種微服務的專案，不過 Netflix 的 Java 開源微服務工具數量之多還真大開眼界</p></blockquote><p>以下分別摘要每個主題：</p><h3 id=introduction-to-microserviceshttpswwwnginxcomblogintroduction-to-microservices><a href=https://www.nginx.com/blog/introduction-to-microservices/>Introduction to Microservices</a></h3><p>簡介什麼是微服務，有什麼優缺點，並介紹微服務架構下常見元件，鋪陳給接下來的系列文，總之是個不想看可跳過的篇章。</p><h3 id=building-microservices-using-an-api-gatewayhttpswwwnginxcomblogbuilding-microservices-using-an-api-gateway><a href=https://www.nginx.com/blog/building-microservices-using-an-api-gateway/>Building Microservices: Using an API Gateway</a></h3><p>介紹 API gateway 為什麼存在：統一微服務一致對外的介面，解耦客戶端與微服務們，但缺點是 API gateway 需要更多 operational cost，也要維持 hign availibility。</p><p>實作 API gateway 要注意以下幾點：</p><ul><li>Performance：所有請求都會通過 gateway，所以效能和擴充性一定要好</li><li>Reactive Programming 模式：gateway 需要集合各種請求，善用 Reactive programming 模式很有幫助</li><li>Service Invocation：微服務之間就是 IPC（inter-process communication），如何透過不同模式相互 invoke 很重要，下一章會詳述</li><li>Service Discovery：如何讓服務之間互相知道彼此，就是「服務發現」的工作了，分為 client-side 和 service-side discovery，之後有專文說明</li><li>Partial Failures：微服務之間不像單體服務可以用簡單的 transaction 處理錯誤並 rollback，處理部分錯誤，保持 CAP 的 consistency 是個重要課題</li></ul><h3 id=building-microservices-interprocess-communication-in-a-microservices-architecturehttpswwwnginxcomblogbuilding-microservices-inter-process-communication><a href=https://www.nginx.com/blog/building-microservices-inter-process-communication/>Building Microservices: Inter‑Process Communication in a Microservices Architecture</a></h3><p>介紹微服務間 IPC（inter‑process communication）的方法與模式，這是系列文中最接近實作層面的文章，很棒。</p><p>IPC 常見的溝通模式根據同步與非同步，以及一對一或一對多，有許多不同的作法，例如 request-respone（一對一、同步）、publish-subscribe（一對多、非同步）。而常見的技術有：</p><ul><li><strong>Message-based communication（message queue）</strong><ul><li>client-service 完全解耦合</li><li>message 有 buffering</li><li>有明確的 IPC，反觀 RPC 可能會以為自己在 invoke local function</li><li>系統複雜度增加不少</li><li>非同步，不容易做到同步的 request-response 互動模式</li></ul></li><li><strong>同步溝通：REST</strong><ul><li>對 entity/resource 操作，很簡單，大家都熟悉</li><li>如果用 HTTP，防火牆通常不會擋</li><li>因為是同步的溝通，client 和 server 要一起等待互動結果出爐</li><li>client 必須明確知道自己要到哪裡找資源，這部分有較重的耦合</li><li>REST 有個 <a href=https://martinfowler.com/articles/richardsonMaturityModel.html>4 level 的 Maturity Model</a> 可以參考</li></ul></li><li><strong>同步溝通：Thrift（注：其實應該要泛稱各種 IDL）</strong><ul><li>一個老牌，可以作為 IDL 的 binary format</li><li>有 compiler 可以協助產生各種語言的 code</li><li>（注：個人偏好 ProtoBuf 或是 FlatBuffer 這些更高效支援也廣的格式）</li></ul></li></ul><p>而 message format 也是重要的課題：選擇好用的 IDL 可以減少雙方來來去去修改 spec 的時間，例如 <a href=https://json-schema.org/>JSON schema</a> 或 <a href=https://developers.google.com/protocol-buffers>Protocol Buffer</a>。</p><h3 id=service-discovery-in-a-microservices-architecturehttpswwwnginxcomblogservice-discovery-in-a-microservices-architecture><a href=https://www.nginx.com/blog/service-discovery-in-a-microservices-architecture/>Service Discovery in a Microservices Architecture</a></h3><p>Service discovery 可以動態改變每個服務的位置，讓服務之間不再需要寫死 IP，使得部署與 scaling 更為彈性，主要分為兩種方式：client-side 與 server-side。</p><ul><li>client-side：client 詢問 service registry 來取得可用的服務位置，而且可以做到 client-side load balancing，但相對地，不同語言的 client 都需要實作一遍這個 discovery 邏輯</li><li>service-side：服務隱藏在 load balancer 後，load balancer 詢問 service registry，再決定要用哪個服務，完全抽象於 client 外，但也必須導入 load balancer 這個角色而且必須做 HA。</li></ul><p>此外，實作 service discovery 最重要的元件是 service registry，將服務註冊在 registry 上，讓其他服務可以透過 registry 發現彼此，常見使用 <a href=https://etcd.io/>etcd</a>、<a href=https://www.consul.io>consul</a> 和 <a href=https://zookeeper.apache.org>ZooKeeper</a> 達成。註冊的方式有</p><ul><li>自我註冊 Self‑Registration：服務自己主動向 registry 註冊/取消註冊</li><li>第三方註冊 Third‑Party Registration：額外的 registrar 訂閱該服務的事件或 healthcheck，來決定是否註冊或取消註冊</li></ul><h3 id=event-driven-data-management-for-microserviceshttpswwwnginxcomblogevent-driven-data-management-microservices><a href=https://www.nginx.com/blog/event-driven-data-management-microservices/>Event-Driven Data Management for Microservices</a></h3><p>本篇探討在微服務這種分散式架構下，每個服務都有獨立的資料庫，甚至資料庫的類型還不一樣，那如何保證 ACID、如何在 CAP 理論中作出取捨，two-phase commit（2PC）過於注重 C（consistency），不符合現代架構要求的 availability，因此，這裡提出 <strong>event-driven architecture</strong>：</p><ul><li>事情發生會 publish event</li><li>其他服務會訂閱這些 event 做對應處理</li><li>可以保證 <a href="https://queue.acm.org/detail.cfm?id=1394128">BASE model</a> 中的 eventual consistency</li><li>可以透過特定方法達成 Atomicity<ul><li><strong>使用 local 的 transaction：</strong> event 不直接 publish 到 message broker，而是利用 local 的 transaction 寫入到 event table 中，再透過另一個 Event publisher 服務發布至 message broker</li><li><strong>從資料庫 transaction log 挖寶：</strong> transaction log 裡面資料 100% 完整，可做為 event 來源，但是 log 太生不好處理，而且和選用的資料庫緊耦合</li><li><strong>使用 <a href=https://github.com/cer/event-sourcing-examples/wiki/WhyEventSourcing>Event sourcing</a>：</strong> 將原本 mutate 資料庫 table 的操作都改成一個個事件，例如 Order 狀態改變變成一個個 Order.completed Order.pending 事件，因為不再將資料映射到 Object entity，不僅省了 ORM 抽象，更保證資料 consistency（因為根本不會 mutate state），在 persistent data 的同時也會直接 publish event，但缺點是不好設計，而且不直觀，需要使用 <a href=https://github.com/cer/event-sourcing-examples/wiki>Command Query Responsibility Segregation（CQRS）</a> 達成特地的查詢操作。</li></ul></li></ul><h3 id=choosing-a-microservices-deployment-strategyhttpswwwnginxcomblogdeploying-microservices><a href=https://www.nginx.com/blog/deploying-microservices/>Choosing a Microservices Deployment Strategy</a></h3><p>由於微服務架構不論數量、語言、框架種類通常比單體架構更多，因此更難部署，這篇整理了許多不同的部署策略：</p><ul><li>一個 host 多服務<ul><li>Pros：部署最直接、資源運用率高</li><li>Cons：抽象化不夠，服務直接沒有隔離</li></ul></li><li>一個 VM 一個服務<ul><li>Pros：服務間獨立、安全性</li><li>Cons：資源運用率低、啟動慢</li></ul></li><li>一個 container 一個服務<ul><li>Pros：啟動快、image 容器化容易部署、隔離完善</li><li>Cons：資源運用率比 VM 高但比單一 host 低、比 VM 安全性低一些</li><li>如果有 cluster manager 例如 kubernetes 會增加資源運用率</li></ul></li><li>Serverless<ul><li>Pros：不需管理 infra、by request 算錢</li><li>Cons：僅適合 stateless 服務但不適合 long-running 服務、受限於 runtime 語言支援程度</li></ul></li></ul><h3 id=refactoring-a-monolith-into-microserviceshttpswwwnginxcomblogrefactoring-a-monolith-into-microservices><a href=https://www.nginx.com/blog/refactoring-a-monolith-into-microservices/>Refactoring a Monolith into Microservices</a></h3><p>如何從遷移到基本上是老生常談，還是條列有提到的策略好惹：</p><ul><li><strong>停止堆屎：</strong> 知道目前的單體架構是一坨屎，新 feature 就別再往上加了</li><li><strong>切堆分層：</strong> 架構通常分為 1）presentation layer，和 UI 或 REST API 等相關，2）business logic layer，都是業務邏輯，以及 3）data-access layer，存取資料庫或是訊息中介 message queue 等。切好切滿更容易抽象出微服務</li><li><strong>抽出服務：</strong> 乍看之下不知道在講啥，但提到需要以 module 為單位來抽象（前提是 module 權責分明），如果本來就有遵守 <a href=https://martinfowler.com/eaaCatalog/domainModel.html>Domain Model pattern</a> 會更好抽象</li></ul></div><footer class=entry-footer><div class="container sep-before"><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/weekly/>Weekly</a>, <a class=tag href=/tags/microservice/>Microservice</a></div></div><div style=text-align:center;padding-top:2em><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/><img src=https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png alt=cc-by-nc-sa-4></a></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/posts/2020/www-0x04/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>WWW 0x04: Not feeling the async pressure</a></div><div class="next-entry sep-before"><a href=/posts/2020/www-0x06/><span class=screen-reader-text>Next post: </span>WWW 0x06: Life is short. I hate GIL<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://facebook.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Facebook account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href=https://twitter.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Twitter icon</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=https://linkedin.com/in/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><title>Telegram icon</title><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7l-5.45-1.7c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2017-2020 Weihang Lo</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script><script src=/js/custom.js></script></body></html>