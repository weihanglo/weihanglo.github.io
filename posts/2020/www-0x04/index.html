<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>WWW 0x04: Not feeling the async pressure | Life is a refactoring process without tests</title>
<meta name=keywords content="Weekly,Performance,Rust,Asynchronous"><meta name=description content="這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食"><meta name=author content><link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x04/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://weihanglo.tw/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weihanglo.tw/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weihanglo.tw/favicon-32x32.png><link rel=apple-touch-icon href=https://weihanglo.tw/apple-touch-icon.png><link rel=mask-icon href=https://weihanglo.tw/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weihanglo.tw/posts/2020/www-0x04/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><meta property="og:title" content="WWW 0x04: Not feeling the async pressure"><meta property="og:description" content="這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食"><meta property="og:type" content="article"><meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x04/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-15T00:00:00+08:00"><meta property="article:modified_time" content="2020-02-15T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="WWW 0x04: Not feeling the async pressure"><meta name=twitter:description content="這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weihanglo.tw/posts/"},{"@type":"ListItem","position":2,"name":"WWW 0x04: Not feeling the async pressure","item":"https://weihanglo.tw/posts/2020/www-0x04/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WWW 0x04: Not feeling the async pressure","name":"WWW 0x04: Not feeling the async pressure","description":"這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食","keywords":["Weekly","Performance","Rust","Asynchronous"],"articleBody":"這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。\n“Performance Matters” by Emery Berger 最近滿紅的一個關於 performance measurement 的 影片，講者演講功力深厚，把嚴肅 performance analysis/profiling 議題以輕鬆的口吻娓娓道出，非常推薦。\n節錄一些我覺得有趣的點：\n以 CPU 和 transistor 的發展闡述為什麼現代程式越來越注重效能 解釋 Performance Analysis 和 Performance Profiling 有什麼差別 Performance Analysis 是需要統計而且不是 eyeball statistics，然後要排除環境變因 想做 Performance Profiling 可以從另一個角度開始：讓其他不想測試的部分「變慢」 Why Discord is switching from Go to Rust 簡體中文譯文\n標題乍看下有點聳動，其實內容很平實，完整交代來龍去脈：\n背景：Discord ReadState 服務架構和資料結構 問題：高度手動最佳化的 Go 實作仍有兩分鐘一次的 GC spike，測試好幾個 Go 版本都沒解決 行動：用沒有 GC 的 Rust 重寫，公司內其他團隊也有成功案例 成果：各項指標皆勝原本 Go 實作，但有強調不要腦衝什麼都 RiiR 紫色是 Go，藍色是還沒升級 Tokio 0.2 的 Rust\nI’m not feeling the async pressure 這篇文章是由 Python 知名框架 Flask 的作者所撰，內容點出當今 async 熱潮，從 c#、JavaScript、Python 到 Rust，沒有一個語言不想要 async，高層次抽象的背後，卻容易忽略 back pressure 帶來的問題。\n何謂 back pressure Back pressure 在「Backpressure explained — the resisted flow of data through software」一文中給了不錯的定義，若流體中的 back pressure 定義如下：\nResistance or force opposing the desired flow of fluid through pipes.\n那麼在軟體工程中就是以下的定義；\nResistance or force opposing the desired flow of data through software.\n作者用了一個貼切的例子：浴缸排水不及，反而水漲了起來，我自己覺得馬桶堵塞更貼切啦！簡單來說，sender 傳送速率大於 receiver，就會使得 back pressure 變成問題。\n管理 back pressure 的方法 要管理 back pressure 的方式有兩種：\ndropping：丟棄來不及處理的訊息 -\u003e 會掉資料 buffering：貯存來不及處理的訊息 -\u003e unbounded buffer 可能會漫出來 out-of-memory 可惜現今大部分語言的 async 都沒特別處理，例如 Python 的 asyncio，如果在 async function 中用了 blocking API，就會需要處理 back pressure，而 asyncio 選擇使用 buffering 的方式來解決，如果都沒有 receiver 讀取，buffer 就會一直長大。\n另外一種管理 back pressure 的方式就是告知 sender 請求其不要再送資料了，例如使用 Semaphore 並告知 sender 當前排隊人數，讓其自行決定是否不繼續等待，server 直接回傳給 client 503 也不失為一個選擇。\n不過這些都是基於 request-response 模型的 back pressure 管理，如果是 streaming 或是像 HTTP/2 這種複雜的多工，sender 同時又是 receiver 的模型，async/await 就非常不適用（注：感覺部分的應用應該可以透過 async-iterator 解決）。\nAsync Is The New Footguns 作者覺得 async 是 footgun 是因為：\n雖降低大型軟體工程，但其實也把處理 distributed system 的問題丟給了開發者（注：應是指 non-blocking async app 比起 blocking multi-threaded app 來得更隱晦，更難撰寫正確，例如在 async function 用到 blocking 整個 async runtime 就 block 住，所以才有 async runtime 要自動偵測 blocking） 改成 async function 會帶來許多 API breakage，這其實對 API user 來說很可怕，整個 call stack 可能都要變成 async 的 flow control 從來都不是容易的事，許多非 async/await 的 library 在這層面也有諸多錯誤，Go、aiohttp、hyper-h2 都有 issue 從 2014 年開到現在還沒解決 最後，作者期望任何 async library 作者，都能在新年新願望加個「給 flow control 和 back pressure 在 API 和文件中一個重要地位」。\n","wordCount":"1268","inLanguage":"en","datePublished":"2020-02-15T00:00:00+08:00","dateModified":"2020-02-15T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weihanglo.tw/posts/2020/www-0x04/"},"publisher":{"@type":"Organization","name":"Life is a refactoring process without tests","logo":{"@type":"ImageObject","url":"https://weihanglo.tw/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weihanglo.tw/ accesskey=h title="Life is a refactoring process without tests (Alt + H)">Life is a refactoring process without tests</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://weihanglo.tw/ title=Home><span>Home</span></a></li><li><a href=https://weihanglo.tw/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://weihanglo.tw/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://weihanglo.tw/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">WWW 0x04: Not feeling the async pressure</h1><div class=post-meta><span title='2020-02-15 00:00:00 +0800 +0800'>February 15, 2020</span>&nbsp;·&nbsp;3 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#performance-matters-by-emery-bergerhttpsyoutuber-tlsbdhe1a aria-label="&ldquo;Performance Matters&rdquo; by Emery Berger">&ldquo;Performance Matters&rdquo; by Emery Berger</a></li><li><a href=#why-discord-is-switching-from-go-to-rusthttpsblogdiscordappcomwhy-discord-is-switching-from-go-to-rust-a190bbca2b1f aria-label="Why Discord is switching from Go to Rust">Why Discord is switching from Go to Rust</a></li><li><a href=#im-not-feeling-the-async-pressurehttpslucumrpocooorg202011async-pressure aria-label="I&rsquo;m not feeling the async pressure">I&rsquo;m not feeling the async pressure</a><ul><li><a href=#%e4%bd%95%e8%ac%82-back-pressure aria-label="何謂 back pressure">何謂 back pressure</a></li><li><a href=#%e7%ae%a1%e7%90%86-back-pressure-%e7%9a%84%e6%96%b9%e6%b3%95 aria-label="管理 back pressure 的方法">管理 back pressure 的方法</a></li><li><a href=#async-is-the-new-footguns aria-label="Async Is The New Footguns">Async Is The New Footguns</a></li></ul></li></ul></div></details></div><div class=post-content><p>這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p><h2 id=performance-matters-by-emery-bergerhttpsyoutuber-tlsbdhe1a><a href=https://youtu.be/r-TLSBdHe1A>&ldquo;Performance Matters&rdquo; by Emery Berger</a><a hidden class=anchor aria-hidden=true href=#performance-matters-by-emery-bergerhttpsyoutuber-tlsbdhe1a>#</a></h2><p>最近滿紅的一個關於 performance measurement 的 影片，講者演講功力深厚，把嚴肅 performance analysis/profiling 議題以輕鬆的口吻娓娓道出，非常推薦。</p><p>節錄一些我覺得有趣的點：</p><ol><li>以 CPU 和 transistor 的發展闡述為什麼現代程式越來越注重效能</li><li>解釋 Performance Analysis 和 Performance Profiling 有什麼差別</li><li>Performance Analysis 是需要統計而且不是 eyeball statistics，然後要排除環境變因</li><li>想做 Performance Profiling 可以從另一個角度開始：讓其他不想測試的部分「變慢」</li></ol><h2 id=why-discord-is-switching-from-go-to-rusthttpsblogdiscordappcomwhy-discord-is-switching-from-go-to-rust-a190bbca2b1f><a href=https://blog.discordapp.com/why-discord-is-switching-from-go-to-rust-a190bbca2b1f>Why Discord is switching from Go to Rust</a><a hidden class=anchor aria-hidden=true href=#why-discord-is-switching-from-go-to-rusthttpsblogdiscordappcomwhy-discord-is-switching-from-go-to-rust-a190bbca2b1f>#</a></h2><blockquote><p><a href=https://mp.weixin.qq.com/s/KlDZx5s6fhn37BZMQAUm1g>簡體中文譯文</a></p></blockquote><p>標題乍看下有點聳動，其實內容很平實，完整交代來龍去脈：</p><ul><li>背景：Discord ReadState 服務架構和資料結構</li><li>問題：高度手動最佳化的 Go 實作仍有兩分鐘一次的 GC spike，測試好幾個 Go 版本都沒解決</li><li>行動：用沒有 GC 的 Rust 重寫，公司內其他團隊也有<a href=https://blog.discordapp.com/using-rust-to-scale-elixir-for-11-million-concurrent-users-c6f19fc029d3>成功案例</a></li><li>成果：各項指標皆勝原本 Go 實作，但有強調不要腦衝什麼都 <a href=http://adventures.michaelfbryan.com/posts/how-to-riir/>RiiR</a></li></ul><blockquote><p>紫色是 Go，藍色是還沒升級 Tokio 0.2 的 Rust</p></blockquote><p><img loading=lazy src=https://miro.medium.com/max/2570/1*-q1B4t622mnxoV8kvT9RwA.png alt></p><h2 id=im-not-feeling-the-async-pressurehttpslucumrpocooorg202011async-pressure><a href=https://lucumr.pocoo.org/2020/1/1/async-pressure/>I&rsquo;m not feeling the async pressure</a><a hidden class=anchor aria-hidden=true href=#im-not-feeling-the-async-pressurehttpslucumrpocooorg202011async-pressure>#</a></h2><p>這篇文章是由 Python 知名框架 Flask 的作者所撰，內容點出當今 async 熱潮，從 c#、JavaScript、Python 到 Rust，沒有一個語言不想要 async，高層次抽象的背後，卻容易忽略 back pressure 帶來的問題。</p><h3 id=何謂-back-pressure>何謂 back pressure<a hidden class=anchor aria-hidden=true href=#何謂-back-pressure>#</a></h3><p>Back pressure 在「<a href=https://medium.com/@jayphelps/backpressure-explained-the-flow-of-data-through-software-2350b3e77ce7>Backpressure explained — the resisted flow of data through software</a>」一文中給了不錯的定義，若流體中的 back pressure 定義如下：</p><blockquote><p>Resistance or force opposing the desired flow of <strong>fluid through pipes</strong>.</p></blockquote><p>那麼在軟體工程中就是以下的定義；</p><blockquote><p>Resistance or force opposing the desired flow of <strong>data through software</strong>.</p></blockquote><p>作者用了一個貼切的例子：浴缸排水不及，反而水漲了起來，我自己覺得馬桶堵塞更貼切啦！簡單來說，sender 傳送速率大於 receiver，就會使得 back pressure 變成問題。</p><h3 id=管理-back-pressure-的方法>管理 back pressure 的方法<a hidden class=anchor aria-hidden=true href=#管理-back-pressure-的方法>#</a></h3><p>要管理 back pressure 的方式有兩種：</p><ul><li>dropping：丟棄來不及處理的訊息 -> 會掉資料</li><li>buffering：貯存來不及處理的訊息 -> unbounded buffer 可能會漫出來 out-of-memory</li></ul><p>可惜現今大部分語言的 async 都沒特別處理，例如 Python 的 asyncio，如果在 async function 中用了 blocking API，就會需要處理 back pressure，而 asyncio 選擇使用 buffering 的方式來解決，如果都沒有 receiver 讀取，buffer 就會一直長大。</p><p>另外一種管理 back pressure 的方式就是告知 sender 請求其不要再送資料了，例如使用 Semaphore 並告知 sender 當前排隊人數，讓其自行決定是否不繼續等待，server 直接回傳給 client 503 也不失為一個選擇。</p><p>不過這些都是基於 request-response 模型的 back pressure 管理，如果是 streaming 或是像 HTTP/2 這種複雜的多工，sender 同時又是 receiver 的模型，async/await 就非常不適用（注：感覺部分的應用應該可以透過 async-iterator 解決）。</p><h3 id=async-is-the-new-footguns>Async Is The New Footguns<a hidden class=anchor aria-hidden=true href=#async-is-the-new-footguns>#</a></h3><p>作者覺得 async 是 footgun 是因為：</p><ul><li>雖降低大型軟體工程，但其實也把處理 distributed system 的問題丟給了開發者（注：應是指 non-blocking async app 比起 blocking multi-threaded app 來得更隱晦，更難撰寫正確，例如在 async function 用到 blocking 整個 async runtime 就 block 住，所以才有 <a href=https://async.rs/blog/stop-worrying-about-blocking-the-new-async-std-runtime/>async runtime 要自動偵測 blocking</a>）</li><li>改成 async function 會帶來許多 API breakage，這其實對 API user 來說很可怕，整個 call stack 可能都要變成 async 的</li><li>flow control 從來都不是容易的事，許多非 async/await 的 library 在這層面也有諸多錯誤，Go、aiohttp、hyper-h2 都有 issue 從 2014 年開到現在還沒解決</li></ul><p>最後，作者期望任何 async library 作者，都能在新年新願望加個「給 flow control 和 back pressure 在 API 和文件中一個重要地位」。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://weihanglo.tw/tags/weekly/>Weekly</a></li><li><a href=https://weihanglo.tw/tags/performance/>Performance</a></li><li><a href=https://weihanglo.tw/tags/rust/>Rust</a></li><li><a href=https://weihanglo.tw/tags/asynchronous/>Asynchronous</a></li></ul><nav class=paginav><a class=prev href=https://weihanglo.tw/posts/2020/www-0x05/><span class=title>« Prev</span><br><span>WWW 0x05: 若單體服務是屎，微服務就是許多屎</span>
</a><a class=next href=https://weihanglo.tw/posts/2020/www-0x03/><span class=title>Next »</span><br><span>WWW 0x03: What Color is Your Function?</span></a></nav></footer></article></main><footer class=footer><span>CC BY-NC-SA 4.0</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>