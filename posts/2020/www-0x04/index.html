<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
&ldquo;Performance Matters&rdquo; by Emery Berger 最近滿紅的一個關於 performance measurement 的 影片，講者演講功力深厚，把嚴肅 performance analysis/profiling 議題以輕鬆的口吻娓娓道出，非常推薦。
節錄一些我覺得有趣的點：
 以 CPU 和 transistor 的發展闡述為什麼現代程式越來越注重效能 解釋 Performance Analysis 和 Performance Profiling 有什麼差別 Performance Analysis 是需要統計而且不是 eyeball statistics，然後要排除環境變因 想做 Performance Profiling 可以從另一個角度開始：讓其他不想測試的部分「變慢」  Why Discord is switching from Go to Rust  簡體中文譯文
 標題乍看下有點聳動，其實內容很平實，完整交代來龍去脈：
 背景：Discord ReadState 服務架構和資料結構 問題：高度手動最佳化的 Go 實作仍有兩分鐘一次的 GC spike，測試好幾個 Go 版本都沒解決 行動：用沒有 GC 的 Rust 重寫，公司內其他團隊也有成功案例 成果：各項指標皆勝原本 Go 實作，但有強調不要腦衝什麼都 RiiR   紫色是 Go，藍色是還沒升級 Tokio 0."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="WWW 0x04: Not feeling the async pressure • Weihang Lo"><meta property="og:description" content="這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。
&ldquo;Performance Matters&rdquo; by Emery Berger 最近滿紅的一個關於 performance measurement 的 影片，講者演講功力深厚，把嚴肅 performance analysis/profiling 議題以輕鬆的口吻娓娓道出，非常推薦。
節錄一些我覺得有趣的點：
 以 CPU 和 transistor 的發展闡述為什麼現代程式越來越注重效能 解釋 Performance Analysis 和 Performance Profiling 有什麼差別 Performance Analysis 是需要統計而且不是 eyeball statistics，然後要排除環境變因 想做 Performance Profiling 可以從另一個角度開始：讓其他不想測試的部分「變慢」  Why Discord is switching from Go to Rust  簡體中文譯文
 標題乍看下有點聳動，其實內容很平實，完整交代來龍去脈：
 背景：Discord ReadState 服務架構和資料結構 問題：高度手動最佳化的 Go 實作仍有兩分鐘一次的 GC spike，測試好幾個 Go 版本都沒解決 行動：用沒有 GC 的 Rust 重寫，公司內其他團隊也有成功案例 成果：各項指標皆勝原本 Go 實作，但有強調不要腦衝什麼都 RiiR   紫色是 Go，藍色是還沒升級 Tokio 0."><meta property="og:url" content="https://weihanglo.tw/posts/2020/www-0x04/"><meta property="og:site_name" content="Weihang Lo"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="Weekly"><meta property="article:tag" content="Performance"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Asynchronous"><meta property="article:published_time" content="2020-02-15T00:00:00+08:00"><meta property="article:modified_time" content="2020-02-15T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.62.2"><title>WWW 0x04: Not feeling the async pressure • Weihang Lo</title><link rel=canonical href=https://weihanglo.tw/posts/2020/www-0x04/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.6a060eb7.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-posts"><div class=site><a class=screen-reader-text href=#content>Skip to Content</a><div class=main><nav id=main-menu class="menu main-menu" aria-label="Main Menu"><div class=container><ul><li class=item><a href=/>Home</a></li><li class=item><a href=/posts/>Posts</a></li><li class=item><a href=/tags/>Tags</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Weihang Lo</p><p class="desc site-desc"></p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>WWW 0x04: Not feeling the async pressure</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2020-02-15T00:00:00+08:00>2020, Feb 15</time></span>
<span class=reading-time><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>2 mins read</span></div></div></header><div class="container entry-content"><p>這裡是 WWW 第肆期，Wow Weihang Weekly 是一個毫無章法的個人週刊，出刊週期極不固定，從一週到五年都有可能。初期內容以軟體工程為主，等財富自由後會有更多雜食篇章。</p><h2 id=performance-matters-by-emery-bergerhttpsyoutuber-tlsbdhe1a><a href=https://youtu.be/r-TLSBdHe1A>&ldquo;Performance Matters&rdquo; by Emery Berger</a></h2><p>最近滿紅的一個關於 performance measurement 的 影片，講者演講功力深厚，把嚴肅 performance analysis/profiling 議題以輕鬆的口吻娓娓道出，非常推薦。</p><p>節錄一些我覺得有趣的點：</p><ol><li>以 CPU 和 transistor 的發展闡述為什麼現代程式越來越注重效能</li><li>解釋 Performance Analysis 和 Performance Profiling 有什麼差別</li><li>Performance Analysis 是需要統計而且不是 eyeball statistics，然後要排除環境變因</li><li>想做 Performance Profiling 可以從另一個角度開始：讓其他不想測試的部分「變慢」</li></ol><h2 id=why-discord-is-switching-from-go-to-rusthttpsblogdiscordappcomwhy-discord-is-switching-from-go-to-rust-a190bbca2b1f><a href=https://blog.discordapp.com/why-discord-is-switching-from-go-to-rust-a190bbca2b1f>Why Discord is switching from Go to Rust</a></h2><blockquote><p><a href=https://mp.weixin.qq.com/s/KlDZx5s6fhn37BZMQAUm1g>簡體中文譯文</a></p></blockquote><p>標題乍看下有點聳動，其實內容很平實，完整交代來龍去脈：</p><ul><li>背景：Discord ReadState 服務架構和資料結構</li><li>問題：高度手動最佳化的 Go 實作仍有兩分鐘一次的 GC spike，測試好幾個 Go 版本都沒解決</li><li>行動：用沒有 GC 的 Rust 重寫，公司內其他團隊也有<a href=https://blog.discordapp.com/using-rust-to-scale-elixir-for-11-million-concurrent-users-c6f19fc029d3>成功案例</a></li><li>成果：各項指標皆勝原本 Go 實作，但有強調不要腦衝什麼都 <a href=http://adventures.michaelfbryan.com/posts/how-to-riir/>RiiR</a></li></ul><blockquote><p>紫色是 Go，藍色是還沒升級 Tokio 0.2 的 Rust</p></blockquote><p><img src=https://miro.medium.com/max/2570/1*-q1B4t622mnxoV8kvT9RwA.png alt></p><h2 id=im-not-feeling-the-async-pressurehttpslucumrpocooorg202011async-pressure><a href=https://lucumr.pocoo.org/2020/1/1/async-pressure/>I'm not feeling the async pressure</a></h2><p>這篇文章是由 Python 知名框架 Flask 的作者所撰，內容點出當今 async 熱潮，從 c#、JavaScript、Python 到 Rust，沒有一個語言不想要 async，高層次抽象的背後，卻容易忽略 back pressure 帶來的問題。</p><h3 id=何謂-back-pressure>何謂 back pressure</h3><p>Back pressure 在「<a href=https://medium.com/@jayphelps/backpressure-explained-the-flow-of-data-through-software-2350b3e77ce7>Backpressure explained — the resisted flow of data through software</a>」一文中給了不錯的定義，若流體中的 back pressure 定義如下：</p><blockquote><p>Resistance or force opposing the desired flow of <strong>fluid through pipes</strong>.</p></blockquote><p>那麼在軟體工程中就是以下的定義；</p><blockquote><p>Resistance or force opposing the desired flow of <strong>data through software</strong>.</p></blockquote><p>作者用了一個貼切的例子：浴缸排水不及，反而水漲了起來，我自己覺得馬桶堵塞更貼切啦！簡單來說，sender 傳送速率大於 receiver，就會使得 back pressure 變成問題。</p><h3 id=管理-back-pressure-的方法>管理 back pressure 的方法</h3><p>要管理 back pressure 的方式有兩種：</p><ul><li>dropping：丟棄來不及處理的訊息 -> 會掉資料</li><li>buffering：貯存來不及處理的訊息 -> unbounded buffer 可能會漫出來 out-of-memory</li></ul><p>可惜現今大部分語言的 async 都沒特別處理，例如 Python 的 asyncio，如果在 async function 中用了 blocking API，就會需要處理 back pressure，而 asyncio 選擇使用 buffering 的方式來解決，如果都沒有 receiver 讀取，buffer 就會一直長大。</p><p>另外一種管理 back pressure 的方式就是告知 sender 請求其不要再送資料了，例如使用 Semaphore 並告知 sender 當前排隊人數，讓其自行決定是否不繼續等待，server 直接回傳給 client 503 也不失為一個選擇。</p><p>不過這些都是基於 request-response 模型的 back pressure 管理，如果是 streaming 或是像 HTTP/2 這種複雜的多工，sender 同時又是 receiver 的模型，async/await 就非常不適用（注：感覺部分的應用應該可以透過 async-iterator 解決）。</p><h3 id=async-is-the-new-footguns>Async Is The New Footguns</h3><p>作者覺得 async 是 footgun 是因為：</p><ul><li>雖降低大型軟體工程，但其實也把處理 distributed system 的問題丟給了開發者（注：應是指 non-blocking async app 比起 blocking multi-threaded app 來得更隱晦，更難撰寫正確，例如在 async function 用到 blocking 整個 async runtime 就 block 住，所以才有 <a href=https://async.rs/blog/stop-worrying-about-blocking-the-new-async-std-runtime/>async runtime 要自動偵測 blocking</a>）</li><li>改成 async function 會帶來許多 API breakage，這其實對 API user 來說很可怕，整個 call stack 可能都要變成 async 的</li><li>flow control 從來都不是容易的事，許多非 async/await 的 library 在這層面也有諸多錯誤，Go、aiohttp、hyper-h2 都有 issue 從 2014 年開到現在還沒解決</li></ul><p>最後，作者期望任何 async library 作者，都能在新年新願望加個「給 flow control 和 back pressure 在 API 和文件中一個重要地位」。</p></div><footer class=entry-footer><div class="container sep-before"><div class=tags><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/weekly/>Weekly</a>, <a class=tag href=/tags/performance/>Performance</a>, <a class=tag href=/tags/rust/>Rust</a>, <a class=tag href=/tags/asynchronous/>Asynchronous</a></div></div><div style=text-align:center;padding-top:2em><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/><img src=https://licensebuttons.net/l/by-nc-sa/4.0/88x31.png alt=cc-by-nc-sa-4></a></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/posts/2020/www-0x03/><span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>WWW 0x03: What Color is Your Function?</a></div><div class="next-entry sep-before"><a href=/posts/2020/www-0x05/><span class=screen-reader-text>Next post: </span>WWW 0x05: 若單體服務是屎，微服務就是許多屎<span aria-hidden=true>Next<svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://facebook.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Facebook account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href=https://twitter.com/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Twitter account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li><a href=https://linkedin.com/in/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/weihanglo target=_blank rel=noopener><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="m22.05 1.577c-.393-.016-.784.08-1.117.235-.484.186-4.92 1.902-9.41 3.64C9.263 6.325 7.005 7.198 5.267 7.867 3.53 8.537 2.222 9.035 2.153 9.059c-.46.16-1.082.362-1.61.984-.79581202 1.058365.21077405 1.964825 1.004 2.499 1.76.564 3.58 1.102 5.087 1.608.556 1.96 1.09 3.927 1.618 5.89.174.394.553.54.944.544l-.002.02s.307.03.606-.042c.3-.07.677-.244 1.02-.565.377-.354 1.4-1.36 1.98-1.928l4.37 3.226.035.02s.484.34 1.192.388c.354.024.82-.044 1.22-.337.403-.294.67-.767.795-1.307.374-1.63 2.853-13.427 3.276-15.38L23.676 4.725C23.972 3.625 23.863 2.617 23.18 2.02 22.838 1.723 22.444 1.593 22.05 1.576z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2017-2020 Weihang Lo</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.67d669ac.js></script><script src=/js/custom.js></script></body></html>